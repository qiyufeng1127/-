<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Jarvis - Resizable & Movable UI</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #131314; --card: #1E1E20; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #E3E3E3;
        }
        body { 
            background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0; padding: 20px; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 2px 2px, #333 1px, transparent 0);
            background-size: 40px 40px; /* ç§‘æŠ€æ„Ÿç½‘æ ¼èƒŒæ™¯ */
        }

        /* å¸ƒå±€å®¹å™¨ï¼šå…è®¸å…ƒç´ è‡ªç”±æ’åˆ— */
        #workspace {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-content: flex-start;
            height: 100%;
        }

        /* é¢æ¿æ ¸å¿ƒæ ·å¼ï¼šå¢åŠ  resize å±æ€§ */
        .panel { 
            background: var(--card); border-radius: 16px; padding: 15px; 
            border: 1px solid #333; display: flex; flex-direction: column; 
            position: relative; overflow: auto;
            min-width: 250px; min-height: 200px;
            width: 320px; height: 400px; /* åˆå§‹å¤§å° */
            
            /* å…³é”®ï¼šå…è®¸ä¿®æ”¹å¤§å° */
            resize: both; 
            overflow: hidden; 
            
            cursor: grab;
            transition: box-shadow 0.2s;
        }
        
        /* è°ƒæ•´å¤§å°çš„å°æ‰‹æŸ„ç¾åŒ– */
        .panel::-webkit-resizer {
            background-color: var(--p);
            border-radius: 10px 0 0 0;
            box-shadow: 0 0 5px var(--p);
        }

        .panel:active { cursor: grabbing; box-shadow: 0 0 30px rgba(255, 0, 127, 0.2); }
        .panel.dragging { opacity: 0.4; border: 2px dashed var(--p); }

        .header { 
            font-size: 10px; text-transform: uppercase; letter-spacing: 2px; 
            color: #888; margin-bottom: 12px; border-bottom: 1px solid #333; 
            padding-bottom: 8px; pointer-events: none;
            display: flex; justify-content: space-between;
        }

        /* å†…å®¹å®¹å™¨ï¼šå¿…é¡»é˜²æ­¢æ‹–æ‹½å†²çª */
        .content-inner { 
            flex: 1; display: flex; flex-direction: column; overflow: hidden; 
            cursor: default; pointer-events: auto;
        }

        /* å•†åº—ä¸åˆ—è¡¨ */
        .item-row { 
            background: rgba(255,255,255,0.03); border-radius: 10px; padding: 10px; 
            margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
            border-left: 3px solid var(--p);
        }

        .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        .input-bar { background: #000; border-radius: 8px; padding: 5px 10px; display: flex; gap: 5px; margin-top: 10px; border: 1px solid #333; }
        input { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 12px; }
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; padding: 5px 10px; font-size: 10px; white-space: nowrap; }
        
        .terminal { flex: 1; background: #0a0a0a; border-radius: 10px; padding: 10px; font-family: 'Consolas', monospace; font-size: 11px; color: var(--blue); }
    </style>
</head>
<body>

    <div id="workspace">
        <div class="panel" draggable="true" id="shop">
            <div class="header">SYSTEM // <span>SHOP</span> <span>[Drag to Move / Resize â†˜]</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size:24px; color:var(--g); font-weight: bold;">ğŸª™ <span id="coinsDisplay">0</span></div>
                    <div style="font-size:10px; color:#666;">å…‘æ¢åˆ¸: <span id="timeDisplay">0</span> MIN</div>
                </div>
                <div class="scroll-area" id="shopList"></div>
                <div class="input-bar">
                    <input type="text" id="shopName" placeholder="å¥–åŠ±...">
                    <input type="number" id="shopCost" placeholder="C" style="width:35px">
                    <button class="p-btn" onclick="addShopItem()">+</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="timeline" style="width: 400px;">
            <div class="header">MONITOR // <span>TIMELINE</span> <span>â†˜</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div class="scroll-area" id="timelineList"></div>
                <div class="input-bar">
                    <input type="text" id="mTitle" placeholder="ç¢ç¢å¿µæˆ–ä»»åŠ¡...">
                    <button class="p-btn" onclick="deployMission()">DEPLOY</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="routine">
            <div class="header">SCHEDULE // <span>ROUTINES</span> <span>â†˜</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div class="scroll-area" id="routineList"></div>
                <div class="input-bar">
                    <input type="time" id="rTime" value="20:00">
                    <input type="text" id="rTitle" placeholder="å›ºå®šä»»åŠ¡...">
                    <button class="p-btn" onclick="addRoutine()">ADD</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="brain" style="width: 350px;">
            <div class="header">CORE // <span>JARVIS BRAIN</span> <span>â†˜</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div class="terminal" id="terminalBox">> æ¨¡å—åŒ–å¼•æ“ V2.8 å¯åŠ¨å®Œæ¯•ã€‚<br>> æ‹–æ‹½é¡¶éƒ¨æˆ–ç©ºç™½å¤„ç§»åŠ¨ã€‚<br>> æ‹–æ‹½å³ä¸‹è§’æ‰‹æŸ„ä¿®æ”¹å°ºå¯¸ã€‚</div>
                <div class="input-bar">
                    <input type="text" id="chatInput" placeholder="æŒ‡ä»¤..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="p-btn" onclick="sendChat()">SEND</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let state = {
            coins: parseInt(localStorage.getItem('jv28_coins')) || 1000,
            shop: JSON.parse(localStorage.getItem('jv28_shop')) || [{name: "åˆ·è§†é¢‘ 30min", cost: 100}],
            routines: JSON.parse(localStorage.getItem('jv28_routines')) || [],
            missions: JSON.parse(localStorage.getItem('jv28_missions')) || []
        };

        function init() {
            render();
            setupDragAndDrop();
            printTerminal("ç³»ç»Ÿæ„ŸçŸ¥ä¸­... å¸ƒå±€å·²è§£é”ï¼Œä¸»äººå¯éšæ„è°ƒæ•´ã€‚");
        }

        // --- æ‹–æ”¾ä½ç½®é€»è¾‘ ---
        function setupDragAndDrop() {
            const workspace = document.getElementById('workspace');
            const panels = document.querySelectorAll('.panel');

            panels.forEach(panel => {
                panel.addEventListener('dragstart', (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯å³ä¸‹è§’è°ƒæ•´å¤§å°åŒºåŸŸï¼Œåˆ™ç¦æ­¢æ‹–æ‹½ï¼ˆé€šè¿‡åˆ¤æ–­ç‚¹å‡»ä½ç½®ï¼‰
                    const rect = panel.getBoundingClientRect();
                    if (e.clientX > rect.right - 20 && e.clientY > rect.bottom - 20) {
                        e.preventDefault();
                        return;
                    }
                    panel.classList.add('dragging');
                });

                panel.addEventListener('dragend', () => {
                    panel.classList.remove('dragging');
                });
            });

            workspace.addEventListener('dragover', e => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                const afterElement = getDragAfterElement(workspace, e.clientX, e.clientY);
                if (afterElement == null) {
                    workspace.appendChild(dragging);
                } else {
                    workspace.insertBefore(dragging, afterElement);
                }
            });
        }

        function getDragAfterElement(container, x, y) {
            const draggableElements = [...container.querySelectorAll('.panel:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- ä¸šåŠ¡æ¸²æŸ“é€»è¾‘ ---
        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            document.getElementById('shopList').innerHTML = state.shop.map(item => `
                <div class="item-row">
                    <span>${item.name}</span>
                    <button class="p-btn" style="background:var(--g)" onclick="buyItem(${item.cost}, '${item.name}')">${item.cost}C</button>
                </div>
            `).join('');

            document.getElementById('routineList').innerHTML = state.routines.map(r => `
                <div class="item-row" style="border-left-color:var(--blue)">
                    <span style="font-size:11px;">[${r.time}] ${r.title}</span>
                </div>
            `).join('');

            document.getElementById('timelineList').innerHTML = state.missions.map(m => `
                <div class="item-row" style="border-left-color:var(--blue); flex-direction:column; align-items:flex-start;">
                    <span style="font-size:9px; color:#666;">${m.time}</span>
                    <span style="font-size:12px;">${m.title}</span>
                </div>
            `).join('');
            save();
        }

        function addShopItem() {
            const name = document.getElementById('shopName').value;
            const cost = parseInt(document.getElementById('shopCost').value);
            if(name && cost) { state.shop.push({name, cost}); render(); }
        }

        function buyItem(cost, name) {
            if(state.coins >= cost) {
                state.coins -= cost;
                confetti({ particleCount: 150, origin: { y: 0.7 } });
                printTerminal(`å…‘æ¢æˆåŠŸ: ${name}`);
                render();
            }
        }

        function deployMission() {
            const title = document.getElementById('mTitle').value;
            if(!title) return;
            state.missions.unshift({title, time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})});
            document.getElementById('mTitle').value = '';
            render();
        }

        function addRoutine() {
            const time = document.getElementById('rTime').value;
            const title = document.getElementById('rTitle').value;
            if(title) { state.routines.push({time, title}); render(); }
        }

        function save() {
            localStorage.setItem('jv28_coins', state.coins);
            localStorage.setItem('jv28_shop', JSON.stringify(state.shop));
            localStorage.setItem('jv28_routines', JSON.stringify(state.routines));
            localStorage.setItem('jv28_missions', JSON.stringify(state.missions));
        }

        function printTerminal(t) {
            const b = document.getElementById('terminalBox');
            b.innerHTML += `<div>> ${t}</div>`;
            b.scrollTop = b.scrollHeight;
        }

        init();
    </script>
</body>
</html>
