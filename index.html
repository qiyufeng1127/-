<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - Neon Rose V23.0 Final Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #1A1A1C; --card: #2C2C2E; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #ffffff; --highlight: #FF6347; }
        body { background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; margin: 0; display: grid; grid-template-columns: 320px 1fr 380px; height: 100vh; gap: 15px; padding: 15px; overflow: hidden; }
        
        /* è­¦æŠ¥é—ªçƒ */
        @keyframes emergency-red { 0% { background: var(--bg); } 50% { background: #550000; } 100% { background: var(--bg); } }
        .emergency-active { animation: emergency-red 0.6s infinite; }
        
        .panel { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #777; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .header span { color: var(--p); text-shadow: 0 0 10px var(--p); }
        
        .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        .item-card { background: #333; border-radius: 12px; padding: 12px; margin-bottom: 10px; border-left: 4px solid var(--p); transition: 0.3s; }
        .item-card.running { border-left-color: var(--blue); box-shadow: 0 0 15px rgba(0, 210, 255, 0.2); }
        .item-card.done { opacity: 0.4; border-left-color: #555; }

        .input-bar { background: #000; border: 1px solid #444; border-radius: 12px; padding: 8px 12px; display: flex; gap: 8px; margin-top: 10px; }
        input { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 8px 12px; font-size: 11px; }
        .report-btn { background: #444; color: white; flex: 1; }

        .terminal { flex: 1; background: #111; border-radius: 15px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--blue); overflow-y: auto; line-height: 1.5; }
        .timer-text { font-family: monospace; font-size: 18px; color: var(--blue); font-weight: bold; }
        .step-item { font-size: 11px; color: #aaa; margin-top: 5px; padding-left: 10px; border-left: 1px solid #555; }
    </style>
</head>
<body>

    <div class="panel">
        <div class="header">STATUS // <span>CORE ASSETS</span></div>
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size:32px; color:var(--g); font-weight: bold;">ğŸª™ <span id="coinsDisplay">0</span></div>
            <div style="font-size:10px; color:#666;">è‡ªç”±é¢åº¦: <span id="timeDisplay">0</span> åˆ†é’Ÿ</div>
        </div>
        <div class="header">SHOP // <span>1ğŸª™ = 5min</span></div>
        <div id="shopList" class="scroll-area"></div>
        <div class="input-bar">
            <input type="text" id="shopName" placeholder="è‡ªç”±æ—¶é—´åç§°...">
            <input type="number" id="shopMins" placeholder="åˆ†é’Ÿ" style="width:40px">
            <button class="p-btn" onclick="addShopItem()">+</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">TIMELINE // <span>ACTIVE MONITORING</span></div>
        <div id="missionList" class="scroll-area"></div>
        <div class="input-bar">
            <input type="text" id="mTitle" placeholder="è´¾ç»´æ–¯ï¼Œéƒ¨ç½²æ–°ä»»åŠ¡...">
            <button class="p-btn" onclick="deploySmartMission()">æ™ºèƒ½éƒ¨ç½²</button>
        </div>
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <button class="p-btn report-btn" onclick="generateReport('daily')">ç”Ÿæˆæ—¥æŠ¥</button>
            <button class="p-btn report-btn" onclick="generateReport('weekly')">ç”Ÿæˆå‘¨æŠ¥</button>
            <button class="p-btn report-btn" onclick="generateReport('monthly')">ç”ŸæˆæœˆæŠ¥</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">JARVIS CORE // <span>DEEP MEMORY</span></div>
        <div class="terminal" id="terminalBox">> ç­‰å¾…æŒ‡ä»¤ï¼Œå…ˆç”Ÿã€‚</div>
        <div class="input-bar">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æ±‡æŠ¥ã€åæ§½æˆ–æŒ‡ä»¤..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="p-btn" onclick="sendChat()">SEND</button>
        </div>
        <button class="p-btn" style="margin-top: 10px; background: transparent; color: var(--p); border: 1px solid var(--p);" onclick="stopAlarm()">è§£é™¤ç³»ç»Ÿè­¦æŠ¥</button>
    </div>

    <audio id="alarmSfx" loop src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3"></audio>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        let state = {
            coins: parseInt(localStorage.getItem('j23_coins')) || 1000,
            missions: JSON.parse(localStorage.getItem('j23_missions')) || [],
            memories: JSON.parse(localStorage.getItem('j23_memories')) || [],
            shop: JSON.parse(localStorage.getItem('j23_shop')) || [{name: "åˆ·æ‰‹æœº", price: 6, mins: 30}],
            activeId: null
        };

        let alarmTimer = null;

        function init() {
            render();
            setInterval(tick, 1000);
            printTerminal("ç£å¯¼æ¨¡å¼å°±ç»ªã€‚ä»»åŠ¡æ‹†è§£åŠŸèƒ½å·²ä¸Šçº¿ã€‚");
        }

        // --- æ ¸å¿ƒæ¸²æŸ“ ---
        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            const mBox = document.getElementById('missionList');
            mBox.innerHTML = state.missions.map(m => `
                <div class="item-card ${m.id === state.activeId ? 'running' : ''} ${m.done ? 'done' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="flex:1; cursor:pointer;" onclick="toggleMission(${m.id})">
                            <b style="color:var(--g)">[${m.reward}ğŸª™]</b> ${m.title}
                        </span>
                        <div class="timer-text">${formatTime(m.secondsLeft)}</div>
                    </div>
                    ${m.steps ? m.steps.map(s => `<div class="step-item">â”” ${s.desc} (${s.mins}m)</div>`).join('') : ''}
                    ${!m.steps && !m.done ? `<button class="p-btn" style="margin-top:10px; width:100%; background:var(--blue)" onclick="breakdownMission(${m.id})">è´¾ç»´æ–¯ï¼Œå¸®æˆ‘æ‹†è§£</button>` : ''}
                </div>
            `).join('');

            const sBox = document.getElementById('shopList');
            sBox.innerHTML = state.shop.map((s, idx) => `
                <div class="item-card" style="border-left-color: var(--blue)" onclick="buyItem(${idx})">
                    <b>${s.name}</b> (${s.mins}åˆ†é’Ÿ) <span style="float:right; color:var(--highlight)">-${s.price}ğŸª™</span>
                </div>
            `).join('');

            save();
        }

        // --- é€»è¾‘åŠŸèƒ½ ---
        async function deploySmartMission() {
            const title = document.getElementById('mTitle').value;
            if(!title) return;
            printTerminal(`æ­£åœ¨è¯„ä¼°ä»»åŠ¡ä»·å€¼: ${title}...`);
            
            const res = await callAI(`é¢„ä¼°ä»»åŠ¡ "${title}" çš„åˆ†é’Ÿæ•°ã€‚è¿”å›JSON: {"mins":æ•°å­—}`);
            try {
                const data = JSON.parse(res.match(/\{.*\}/s)[0]);
                const newM = {
                    id: Date.now(),
                    title: title,
                    reward: Math.ceil(data.mins / 5),
                    secondsLeft: data.mins * 60,
                    done: false,
                    deployedAt: Date.now()
                };
                state.missions.unshift(newM);
                document.getElementById('mTitle').value = '';
                render();
                printTerminal("éƒ¨ç½²æˆåŠŸã€‚è¯·åœ¨60ç§’å†…å¼€å§‹ä»»åŠ¡ã€‚");
                
                // å¯åŠ¨è­¦æŠ¥æ£€æŸ¥
                clearTimeout(alarmTimer);
                alarmTimer = setTimeout(() => {
                    if(state.activeId !== newM.id) startAlarm();
                }, 60000);
            } catch(e) { printTerminal("è¯„ä¼°è§£æå¤±è´¥ã€‚"); }
        }

        async function breakdownMission(id) {
            const m = state.missions.find(x => x.id === id);
            printTerminal(`æ­£åœ¨æ‹†è§£: ${m.title}...`);
            const res = await callAI(`å°†ä»»åŠ¡ "${m.title}" æ‹†è§£æˆ3ä¸ªè¯¦ç»†æ­¥éª¤ã€‚è¿”å›JSONæ ¼å¼: [{"desc":"æ­¥éª¤å","mins":æ•°å­—}]`);
            try {
                m.steps = JSON.parse(res.match(/\[.*\]/s)[0]);
                render();
            } catch(e) { printTerminal("æ‹†è§£è§£æå¤±è´¥ã€‚"); }
        }

        function toggleMission(id) {
            const m = state.missions.find(x => x.id === id);
            if(m.done) return;
            state.activeId = (state.activeId === id) ? null : id;
            if(state.activeId) stopAlarm();
            render();
        }

        function tick() {
            if(state.activeId) {
                const m = state.missions.find(x => x.id === state.activeId);
                if(m && m.secondsLeft > 0) {
                    m.secondsLeft--;
                    render();
                } else if (m && m.secondsLeft <= 0 && !m.done) {
                    m.done = true;
                    state.coins += m.reward;
                    state.activeId = null;
                    confetti({particleCount: 150});
                    printTerminal(`ä»»åŠ¡å®Œæˆï¼æ”¶å…¥ ${m.reward} ğŸª™`);
                    render();
                }
            }
        }

        async function generateReport(type) {
            printTerminal(`è´¾ç»´æ–¯æ­£åœ¨æ’°å†™${type === 'daily' ? 'æ—¥' : type === 'weekly' ? 'å‘¨' : 'æœˆ'}æŠ¥...`);
            const history = {
                missions: state.missions.slice(0, 10),
                memories: state.memories.slice(0, 10)
            };
            const res = await callAI(`æ ¹æ®å†å²è®°å½•å†™ä¸€ä»½${type}æ€»ç»“æŠ¥å‘Šã€‚å†å²æ•°æ®: ${JSON.stringify(history)}ã€‚å£å»è¦åƒè´¾ç»´æ–¯ï¼Œè¦æœ‰å¯¹æˆ‘çš„å…³æ€€å’Œå¯¹æ‹–å»¶çš„è­¦å‘Šã€‚ä½¿ç”¨Markdownã€‚`);
            
            const box = document.getElementById('terminalBox');
            box.innerHTML += `<div style="background:#222; padding:10px; border:1px solid var(--p); border-radius:10px; margin:10px 0;">${res.replace(/\n/g, '<br>')}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value;
            if(!msg) return;
            state.memories.push({text: msg, time: new Date().toLocaleTimeString()});
            printTerminal(`<span style="color:#eee">ä¸»äºº: ${msg}</span>`);
            input.value = '';
            const reply = await callAI(msg);
            printTerminal(`<span style="color:var(--blue)">JARVIS: ${reply}</span>`);
        }

        async function callAI(prompt) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {role: "system", content: "ä½ æ˜¯è´¾ç»´æ–¯ç®¡å®¶ã€‚é€»è¾‘: 5åˆ†é’Ÿ=1é‡‘å¸ã€‚ä½ å†·é…·é«˜æ•ˆä½†å¿ è¯šã€‚"},
                            {role: "user", content: prompt}
                        ]
                    })
                });
                const data = await res.json();
                return data.choices[0].message.content;
            } catch(e) { return "è¿æ¥å¤±è´¥ã€‚"; }
        }

        function startAlarm() {
            document.body.classList.add('emergency-active');
            document.getElementById('alarmSfx').play();
            printTerminal("<span style='color:red'>è­¦å‘Šï¼šæ‚¨å·²æœ‰ä¸€åˆ†é’Ÿæœªå¼€å¯ä»»åŠ¡ï¼ç³»ç»Ÿå¼ºåˆ¶ç£å¯¼ï¼</span>");
        }

        function stopAlarm() {
            document.body.classList.remove('emergency-active');
            document.getElementById('alarmSfx').pause();
            clearTimeout(alarmTimer);
        }

        function formatTime(s) {
            const mins = Math.floor(s / 60);
            const secs = s % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function printTerminal(t) {
            const b = document.getElementById('terminalBox');
            b.innerHTML += `<div>> ${t}</div>`;
            b.scrollTop = b.scrollHeight;
        }

        function save() {
            localStorage.setItem('j23_coins', state.coins);
            localStorage.setItem('j23_missions', JSON.stringify(state.missions));
            localStorage.setItem('j23_memories', JSON.stringify(state.memories));
            localStorage.setItem('j23_shop', JSON.stringify(state.shop));
        }

        init();
    </script>
</body>
</html>
