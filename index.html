<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - Evolution System V2.6</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #1A1A1C; --card: #2C2C2E; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #ffffff;
            --color-work: #FF4757;   /* Â∑•‰ΩúÔºöÁ∫¢ */
            --color-life: #70A1FF;   /* ÁîüÊ¥ªÔºöËìù */
            --color-fixed: #2ED573;  /* Âõ∫ÂÆöÔºöÁªø */
            --color-mood: #ECCC68;   /* ÊÉÖÁª™ÔºöÈªÑ */
        }
        body { background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; margin: 0; display: grid; grid-template-columns: 320px 1fr 380px; height: 100vh; gap: 15px; padding: 15px; overflow: hidden; }
        
        .panel { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #777; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .header span { color: var(--p); text-shadow: 0 0 10px var(--p); }
        
        /* Âë®Êúü‰ªªÂä°Ê†∑Âºè */
        .routine-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; margin-bottom: 8px; border-left: 3px solid var(--color-fixed); }
        .routine-card input[type="time"] { background: transparent; border: none; color: var(--g); font-family: monospace; cursor: pointer; }

        /* Êó∂Èó¥ËΩ¥Ê†∏ÂøÉÊ†∑Âºè */
        .timeline-container { position: relative; padding-left: 40px; border-left: 2px solid #444; margin-left: 20px; }
        .timeline-item { position: relative; margin-bottom: 30px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 15px; transition: 0.3s; }
        .timeline-item::before { 
            content: attr(data-icon); position: absolute; left: -54px; top: 12px; 
            width: 28px; height: 28px; background: var(--bg); border: 2px solid;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px;
        }
        .timeline-item.active { border: 1px solid var(--blue); box-shadow: 0 0 15px rgba(0, 210, 255, 0.2); }

        .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; scroll-behavior: smooth; }
        .input-bar { background: #000; border: 1px solid #444; border-radius: 12px; padding: 8px 12px; display: flex; gap: 8px; margin-top: 10px; }
        input, select { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 8px 12px; font-size: 11px; }
        .terminal { flex: 1; background: #111; border-radius: 15px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--blue); overflow-y: auto; }
        
        /* ÂÜ≤Á™ÅÈ´ò‰∫Æ */
        .conflict-tag { color: #ff4757; font-size: 10px; font-weight: bold; margin-left: 5px; animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div class="panel">
        <div class="header">STATUS // <span>ROUTINES & ASSETS</span></div>
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size:32px; color:var(--g); font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <div style="width:24px;height:24px;background:var(--g);border-radius:50%;color:#000;font-size:14px;display:flex;align-items:center;justify-content:center;">C</div>
                <span id="coinsDisplay">0</span>
            </div>
            <div style="font-size:11px; color:#666; margin-top:5px;">Ëá™Áî±È¢ùÂ∫¶: <span id="timeDisplay">0</span> MIN</div>
        </div>

        <div class="header">DAILY ROUTINES // <span>Âë®Êúü‰ªªÂä°</span></div>
        <div id="routineList" class="scroll-area"></div>
        <div class="input-bar">
            <input type="time" id="rTime" value="20:00">
            <input type="text" id="rTitle" placeholder="Âõ∫ÂÆö‰ªªÂä°...">
            <button class="p-btn" onclick="addRoutine()">+</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">TIMELINE // <span>SMART MONITORING</span></div>
        <div id="timelineScroll" class="scroll-area">
            <div id="timelineList" class="timeline-container"></div>
        </div>
        <div class="input-bar">
            <input type="text" id="mTitle" placeholder="Á¢éÁ¢éÂøµ„ÄÅÂøÉÊÉÖÊàñÊñ∞‰ªªÂä°...">
            <button class="p-btn" onclick="deployMission()">DEPLOY</button>
        </div>
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <button class="p-btn" style="flex:1; background:#444; color:#fff" onclick="generateReport('daily')">Êó•Êä•</button>
            <button class="p-btn" style="flex:1; background:#444; color:#fff" onclick="generateReport('weekly')">Âë®Êä•</button>
            <button class="p-btn" style="flex:1; background:#444; color:#fff" onclick="generateReport('monthly')">ÊúàÊä•</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">JARVIS CORE // <span>BRAIN</span></div>
        <div class="terminal" id="terminalBox">> SYSTEM READY...</div>
        <div class="input-bar">
            <input type="text" id="chatInput" placeholder="Âú®Ê≠§Ê±áÊä•ËøõÂ∫¶ÊàñÂêêÊßΩ..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="p-btn" onclick="sendChat()">SEND</button>
        </div>
        <button class="p-btn" style="margin-top: 10px; background: var(--g); color: #000; width: 100%;" onclick="aiSuggestion()">Ë¥æÁª¥ÊñØÔºåÂª∫ËÆÆÊàëÁé∞Âú®ÂÅö‰ªÄ‰πàÔºü</button>
    </div>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        // È¢úËâ≤ÂõæÊ†áÊò†Â∞ÑË°®
        const typeStyles = {
            work: { color: "var(--color-work)", icon: "‚öíÔ∏è" },
            life: { color: "var(--color-life)", icon: "‚òï" },
            fixed: { color: "var(--color-fixed)", icon: "üìÖ" },
            mood: { color: "var(--color-mood)", icon: "üí≠" }
        };

        let state = {
            coins: parseInt(localStorage.getItem('j_v26_coins')) || 1000,
            routines: JSON.parse(localStorage.getItem('j_v26_routines')) || [
                { id: 1, time: "20:00", title: "ÂèëÂ∞èÁ∫¢‰π¶", type: 'fixed' }
            ],
            missions: JSON.parse(localStorage.getItem('j_v26_missions')) || [],
            activeId: null
        };

        function init() {
            render();
            setInterval(tick, 1000);
            printTerminal("Âõ∫ÂÆö‰ªªÂä°ÂºïÊìéÂ∑≤ÂêØÂä®ÔºåÂ§öËâ≤Êó∂Èó¥ËΩ¥Â∑≤ÂêåÊ≠•„ÄÇ");
        }

        // --- Âë®Êúü‰ªªÂä°ÈÄªËæë ---
        function addRoutine() {
            const time = document.getElementById('rTime').value;
            const title = document.getElementById('rTitle').value;
            if(!title) return;
            state.routines.push({ id: Date.now(), time, title, type: 'fixed' });
            render();
            save();
        }

        function removeRoutine(id) {
            state.routines = state.routines.filter(r => r.id !== id);
            render();
            save();
        }

        // --- Ê†∏ÂøÉÊ∏≤ÊüìÔºöÂåÖÂê´ÂÜ≤Á™ÅÊ£ÄÊµãÁöÑÊó∂Èó¥ËΩ¥ ---
        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            // Ê∏≤ÊüìÂõ∫ÂÆö‰ªªÂä°ÂàóË°®
            const rList = document.getElementById('routineList');
            rList.innerHTML = state.routines.map(r => `
                <div class="routine-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <input type="time" value="${r.time}" onchange="updateRoutineTime(${r.id}, this.value)">
                        <span style="font-size:12px; font-weight:bold;">${r.title}</span>
                        <span style="cursor:pointer; color:#777;" onclick="removeRoutine(${r.id})">√ó</span>
                    </div>
                </div>
            `).join('');

            // Ê∏≤ÊüìÊó∂Èó¥ËΩ¥
            const tList = document.getElementById('timelineList');
            // ÂêàÂπ∂ÂΩìÂâç‰ªªÂä°‰∏é‰ªäÊó•Âë®Êúü‰ªªÂä°Áî®‰∫éÊòæÁ§∫
            let combinedNodes = [
                ...state.missions.map(m => ({ ...m, isMission: true })),
                ...state.routines.map(r => ({ ...r, isRoutine: true, startTime: r.time }))
            ];

            // ÊåâÊó∂Èó¥ÊéíÂ∫èÔºàÊúÄËøëÁöÑÂú®‰∏äÈù¢Ôºâ
            combinedNodes.sort((a,b) => (b.startTime || "00:00") > (a.startTime || "00:00") ? 1 : -1);

            tList.innerHTML = combinedNodes.map(node => {
                const style = typeStyles[node.type || 'work'];
                return `
                    <div class="timeline-item ${node.id === state.activeId ? 'active' : ''}" 
                         data-icon="${node.icon || style.icon}" 
                         style="border-left: 4px solid ${style.color}; border-color: ${style.color}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:10px; color:#777;">${node.startTime || 'NOW'}</span>
                            ${node.isRoutine ? '<span class="conflict-tag">DAILY</span>' : ''}
                        </div>
                        <div style="margin-top:5px; cursor:pointer;" onclick="${node.isMission ? `toggleMission(${node.id})` : ''}">
                            <b style="color:${style.color}">${node.title}</b>
                            ${node.isMission ? `<span style="font-size:12px; color:var(--blue); float:right;">${formatTime(node.secondsLeft)}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            save();
        }

        // --- Êô∫ËÉΩÂÜ≤Á™ÅÊ£ÄÊµãÈÉ®ÁΩ≤ ---
        async function deployMission() {
            const input = document.getElementById('mTitle').value;
            if(!input) return;

            printTerminal(`Ë¥æÁª¥ÊñØÊ≠£Âú®ÂàÜÊûê‰ªªÂä°Â±ûÊÄßÂπ∂Ê£ÄÊµãÊΩúÂú®Êó∂Èó¥ÂÜ≤Á™Å...`);
            
            // AI ËØ≠‰πâÂàÜÊûêÔºöÁ±ªÂà´„ÄÅÊó∂Èïø„ÄÅÂõæÊ†á
            const prompt = `ÂàÜÊûêËæìÂÖ•: "${input}"„ÄÇ
            1. È¢Ñ‰º∞ÈúÄË¶ÅÂ§öÂ∞ëÂàÜÈíü(Êï∞Â≠ó)„ÄÇ
            2. Á±ªÂà´(work/life/mood)„ÄÇ
            3. Â¶ÇÊûúÁé∞Âú®ÊòØ ${new Date().toLocaleTimeString()}ÔºåÂèÇËÄÉÂõ∫ÂÆö‰ªªÂä° ${JSON.stringify(state.routines)}Ôºå
               Â¶ÇÊúâÊó∂Èó¥ÈáçÂè†ÔºåËØ∑ÁÆÄËø∞Â¶Ç‰Ωï[Âª∂Âêé]Êàñ[ÂàáÂàÜ]Âª∫ËÆÆ„ÄÇ
            ËøîÂõû‰∏•Ê†ºJSON: {"mins":Êï∞Â≠ó, "type":"Á±ªÂà´", "icon":"ÂõæÊ†á", "advice":"Âª∫ËÆÆÂÜÖÂÆπ"}`;

            try {
                const res = await callAI(prompt);
                const data = JSON.parse(res.match(/\{.*\}/s)[0]);
                
                const now = new Date();
                const startTimeStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');

                const newM = {
                    id: Date.now(),
                    title: input,
                    startTime: startTimeStr,
                    secondsLeft: data.mins * 60,
                    reward: Math.ceil(data.mins / 5),
                    type: data.type,
                    icon: data.icon,
                    done: false
                };

                state.missions.unshift(newM);
                document.getElementById('mTitle').value = '';
                printTerminal(`Ë¥æÁª¥ÊñØÔºö‰ªªÂä°Â∑≤Âä†ÂÖ•„ÄÇÂª∫ËÆÆÔºö${data.advice}`);
                render();
            } catch(e) { 
                printTerminal("ÂàÜÊûêÂºïÊìéÊ≥¢Âä®ÔºåÂ∑≤ÊâßË°åÈªòËÆ§ÈÉ®ÁΩ≤„ÄÇ");
                // ÈªòËÆ§ÈÉ®ÁΩ≤ÂõûÈÄÄ
            }
        }

        // --- Âü∫Á°ÄÂ∑•ÂÖ∑ÂáΩÊï∞ ---
        function tick() {
            if(state.activeId) {
                const m = state.missions.find(x => x.id === state.activeId);
                if(m && m.secondsLeft > 0) {
                    m.secondsLeft--;
                    if(m.secondsLeft % 10 === 0) render();
                } else if(m && m.secondsLeft <= 0) {
                    m.done = true; state.coins += m.reward; state.activeId = null;
                    confetti({particleCount: 150}); render();
                }
            }
        }

        function toggleMission(id) {
            state.activeId = (state.activeId === id) ? null : id;
            render();
        }

        async function callAI(p) {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                body: JSON.stringify({ model: "deepseek-chat", messages: [{role:"system",content:"‰Ω†ÊòØ‰∫∫Â∑•Êô∫ËÉΩÁÆ°ÂÆ∂Ë¥æÁª¥ÊñØ„ÄÇ"},{role:"user",content:p}] })
            });
            const d = await res.json(); return d.choices[0].message.content;
        }

        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function printTerminal(t) { const b = document.getElementById('terminalBox'); b.innerHTML += `<div>> ${t}</div>`; b.scrollTop = b.scrollHeight; }
        function save() { localStorage.setItem('j_v26_coins', state.coins); localStorage.setItem('j_v26_missions', JSON.stringify(state.missions)); localStorage.setItem('j_v26_routines', JSON.stringify(state.routines)); }

        async function sendChat() {
            const i = document.getElementById('chatInput'); if(!i.value) return;
            printTerminal(`‰∏ª‰∫∫: ${i.value}`);
            const r = await callAI(`‰∏ª‰∫∫ËØ¥: "${i.value}"„ÄÇËØ∑‰ª•ÁÆ°ÂÆ∂Ë¥æÁª¥ÊñØÁöÑËØ≠Ê∞îÂõûÂ§ç„ÄÇ`);
            printTerminal(`JARVIS: ${r}`); i.value = '';
        }

        init();
    </script>
</body>
</html>
