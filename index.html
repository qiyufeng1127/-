<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - Evolution System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #1A1A1C; --card: #2C2C2E; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #ffffff; --highlight: #FF6347; }
        body { background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; margin: 0; display: grid; grid-template-columns: 320px 1fr 380px; height: 100vh; gap: 15px; padding: 15px; overflow: hidden; transition: background 0.1s; }
        
        /* æè‡´çˆ†é—ªåŠ¨ç”» */
        @keyframes emergency-red { 0% { background: #000; } 50% { background: #ff0000; } 100% { background: #000; } }
        .emergency-active { animation: emergency-red 0.1s infinite !important; }
        .emergency-active .panel { opacity: 0.1; }

        .panel { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #777; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .header span { color: var(--p); text-shadow: 0 0 10px var(--p); }
        
        /* çº¯ CSS é‡‘å¸å›¾æ ‡ */
        .coin-icon { width: 24px; height: 24px; background: var(--g); border-radius: 50%; position: relative; box-shadow: 0 0 10px var(--g); display: inline-block; flex-shrink: 0; }
        .coin-icon::after { content: 'C'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #000; font-size: 14px; font-weight: 900; }

        .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; }
        .item-card { background: #333; border-radius: 12px; padding: 12px; margin-bottom: 10px; border-left: 4px solid var(--p); transition: 0.3s; position: relative; }
        .item-card.running { border-left-color: var(--blue); box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); }
        .item-card.done { opacity: 0.4; border-left-color: #555; }

        .input-bar { background: #000; border: 1px solid #444; border-radius: 12px; padding: 8px 12px; display: flex; gap: 8px; margin-top: 10px; }
        input { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 8px 12px; font-size: 11px; }
        
        /* æŠ¥è¡¨é®ç½©å±‚ */
        #reportOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; padding: 50px; align-items: center; overflow-y: auto; }
        .report-content { max-width: 800px; width: 100%; color: #fff; line-height: 1.6; font-size: 14px; background: #222; padding: 30px; border-radius: 20px; border: 1px solid var(--p); }

        .terminal { flex: 1; background: #111; border-radius: 15px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--blue); overflow-y: auto; }
        .timer-text { font-family: monospace; font-size: 18px; color: var(--blue); font-weight: bold; }
        
        .step-item { display: flex; align-items: center; gap: 8px; margin-top: 8px; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 4px; }
        .step-input { flex: 1; background: transparent; border: none; color: #aaa; font-size: 12px; outline: none; border-bottom: 1px solid transparent; }
        .step-input:focus { border-bottom: 1px solid var(--blue); color: #fff; }
        .check-box { cursor: pointer; color: var(--p); font-weight: bold; font-family: monospace; }
    </style>
</head>
<body onclick="stopAlarmInterference()">

    <div id="reportOverlay">
        <button class="p-btn" style="align-self: flex-end; margin-bottom: 20px;" onclick="closeReport()">å…³é—­æŠ¥å‘Š [ESC]</button>
        <div class="report-content" id="reportData"></div>
    </div>

    <div class="panel">
        <div class="header">STATUS // <span>CORE ASSETS</span></div>
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size:32px; color:var(--g); font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 12px;">
                <div class="coin-icon"></div>
                <span id="coinsDisplay">0</span>
            </div>
            <div style="font-size:11px; color:#777; margin-top: 5px;">
                [TIME] è‡ªç”±é¢åº¦: <span id="timeDisplay">0</span> MIN
            </div>
        </div>
        <div class="header">SHOP // <span>REWARDS</span></div>
        <div id="shopList" class="scroll-area"></div>
        <div class="input-bar">
            <input type="text" id="shopName" placeholder="è‡ªç”±æ´»åŠ¨...">
            <input type="number" id="shopMins" placeholder="MIN" style="width:45px">
            <button class="p-btn" onclick="addShopItem()">+</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">TIMELINE // <span>MONITORING</span></div>
        <div id="missionList" class="scroll-area"></div>
        <div class="input-bar">
            <input type="text" id="mTitle" placeholder="æ–°ä»»åŠ¡åç§°...">
            <button class="p-btn" onclick="deploySmartMission()">DEPLOY</button>
        </div>
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <button class="p-btn" style="flex:1; background:#444; color:#fff" onclick="realReport('daily')">æ—¥æŠ¥</button>
            <button class="p-btn" style="flex:1; background:#444; color:#fff" onclick="realReport('weekly')">å‘¨æŠ¥</button>
            <button class="p-btn" style="flex:1; background:#444; color:#fff" onclick="realReport('monthly')">æœˆæŠ¥</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">JARVIS CORE // <span>BRAIN</span></div>
        <div class="terminal" id="terminalBox">> SYSTEM READY...</div>
        <div class="input-bar">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æŒ‡ä»¤æˆ–æ±‡æŠ¥ä¹ æƒ¯..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="p-btn" onclick="sendChat()">SEND</button>
        </div>
        <button class="p-btn" style="margin-top: 10px; background: var(--g); color: #000; width: 100%;" onclick="autoAssignMission()">è´¾ç»´æ–¯ï¼Œå»ºè®®æˆ‘ç°åœ¨åšä»€ä¹ˆï¼Ÿ</button>
    </div>

    <audio id="alarmSfx" loop src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3"></audio>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        let state = {
            coins: parseInt(localStorage.getItem('j_v25_coins')) || 1000,
            missions: JSON.parse(localStorage.getItem('j_v25_missions')) || [],
            memories: JSON.parse(localStorage.getItem('j_v25_memories')) || [],
            learningMemories: JSON.parse(localStorage.getItem('j_v25_learning')) || [],
            shop: JSON.parse(localStorage.getItem('j_v25_shop')) || [],
            activeId: null
        };

        let alarmTimer = null;
        let titleInterval = null;
        let interferenceInterval = null;

        function init() {
            render();
            setInterval(tick, 1000);
            Notification.requestPermission();
            printTerminal("ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆã€‚é‡‘å¸å›¾æ ‡å·²åˆ‡æ¢ä¸º CSS æ¸²æŸ“æ¨¡å¼ã€‚");
        }

        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            const mBox = document.getElementById('missionList');
            mBox.innerHTML = state.missions.map(m => `
                <div class="item-card ${m.id === state.activeId ? 'running' : ''} ${m.done ? 'done' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="flex:1; cursor:pointer;" onclick="toggleMission(${m.id})">
                            <b style="color:var(--g)">[${m.reward}C]</b> ${m.title}
                        </span>
                        <div class="timer-text">${formatTime(m.secondsLeft)}</div>
                    </div>
                    ${m.steps ? m.steps.map((s, idx) => `
                        <div class="step-item">
                            <span class="check-box" onclick="completeStep(${m.id}, ${idx})">${s.completed ? '[V]' : '[O]'}</span>
                            <input type="text" class="step-input" value="${s.desc}" onchange="editAndLearnStep(${m.id}, ${idx}, this.value)">
                        </div>
                    `).join('') : ''}
                    ${!m.steps && !m.done ? `<button class="p-btn" style="margin-top:10px; width:100%; background:var(--blue)" onclick="breakdownMission(${m.id})">æ‹†è§£å¹¶å¼€å¯ç£å¯¼</button>` : ''}
                </div>
            `).join('');
            save();
        }

        // --- æŠ¥è¡¨å®ä½“åŠŸèƒ½ ---
        async function realReport(type) {
            const overlay = document.getElementById('reportOverlay');
            const dataBox = document.getElementById('reportData');
            overlay.style.display = 'flex';
            dataBox.innerHTML = `<h2>æ­£åœ¨ç”Ÿæˆ ${type.toUpperCase()} REPORT...</h2><p>è´¾ç»´æ–¯æ­£åœ¨æ‰«ææ‚¨çš„è¡Œä¸ºè®°å½•å’Œé‡‘å¸æµæ°´...</p>`;
            
            const history = state.missions.slice(0, 15);
            const prompt = `ä½ æ˜¯äººå·¥æ™ºèƒ½ç®¡å®¶è´¾ç»´æ–¯ã€‚è¯·æ ¹æ®æ•°æ®ç”Ÿæˆä¸€ä»½${type}åˆ†ææŠ¥å‘Šï¼š${JSON.stringify(history)}ã€‚è¦æ±‚ï¼šä½¿ç”¨Markdownï¼Œè¯­æ°”å†·é…·ä½†å¿ è¯šï¼Œå¿…é¡»åŒ…å«ä¸»äººçš„è¿›æ­¥åˆ†æå’Œä»Šæ—¥å»ºè®®ã€‚`;

            try {
                const res = await callAI(prompt);
                dataBox.innerHTML = `<div style="text-align:left; white-space: pre-wrap;">${res}</div>`;
            } catch(e) { dataBox.innerHTML = "æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚"; }
        }

        function closeReport() { document.getElementById('reportOverlay').style.display = 'none'; }

        // --- å¼ºåˆ¶è­¦æŠ¥ï¼ˆé˜²é€ƒé¿ï¼‰ ---
        function startAlarm() {
            document.body.classList.add('emergency-active');
            document.getElementById('alarmSfx').play();
            
            if(!titleInterval) {
                titleInterval = setInterval(() => {
                    document.title = document.title.includes("!!!") ? "[ MISSION WAITING ]" : "[ !!! WARNING !!! ]";
                }, 100);
            }

            if(Notification.permission === "granted") {
                new Notification("ğŸš¨ è´¾ç»´æ–¯ç£å¯¼ï¼šæ£€æµ‹åˆ°æ— æ•ˆæ¸¸è¡ï¼", { body: "ä»»åŠ¡å·²åœæ»ï¼Œè¯·ç«‹å³è¿”å›å·¥ä½œç«™ï¼" });
            }

            if(!interferenceInterval) {
                interferenceInterval = setInterval(() => {
                    if (document.hidden) {
                        alert("!!! è­¦å‘Šï¼šæ£€æµ‹åˆ°é€ƒé¿è¡Œä¸º !!!\nè¯·ç«‹å³è¿”å›å®Œæˆä»»åŠ¡æ­¥éª¤ï¼");
                    }
                }, 3000);
            }
        }

        function stopAlarmInterference() {
            document.body.classList.remove('emergency-active');
            document.getElementById('alarmSfx').pause();
            clearInterval(titleInterval);
            clearInterval(interferenceInterval);
            titleInterval = null;
            interferenceInterval = null;
            document.title = "Jarvis - Active";
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---
        function tick() {
            if(state.activeId) {
                const m = state.missions.find(x => x.id === state.activeId);
                if(m && m.secondsLeft > 0) {
                    m.secondsLeft--;
                    document.title = `[${formatTime(m.secondsLeft)}] ${m.title}`;
                } else if(m && m.secondsLeft <= 0 && !m.done) {
                    m.done = true; state.coins += m.reward; state.activeId = null;
                    document.title = "MISSION COMPLETE";
                    confetti({particleCount: 150}); render();
                }
            }
        }

        async function deploySmartMission() {
            const title = document.getElementById('mTitle').value;
            if(!title) return;
            printTerminal(`æ­£åœ¨è¯„ä¼° [${title}] çš„å·¥ç¨‹é‡...`);
            const res = await callAI(`ä¼°ç®—ä»»åŠ¡ "${title}" çš„æ—¶é—´ã€‚è¿”å›JSON: {"mins":æ•°å­—}`);
            try {
                const data = JSON.parse(res.match(/\{.*\}/s)[0]);
                const newM = { id: Date.now(), title, reward: Math.ceil(data.mins / 5), secondsLeft: data.mins * 60, done: false };
                state.missions.unshift(newM);
                document.getElementById('mTitle').value = '';
                render();
                resetAlarmTimer(newM.id);
            } catch(e) { printTerminal("è¯„ä¼°å¼‚å¸¸ã€‚"); }
        }

        function resetAlarmTimer(id) {
            clearTimeout(alarmTimer);
            alarmTimer = setTimeout(() => {
                if(state.activeId !== id) startAlarm();
            }, 60000);
        }

        function toggleMission(id) {
            const m = state.missions.find(x => x.id === id);
            if(m.done) return;
            state.activeId = (state.activeId === id) ? null : id;
            if(state.activeId) stopAlarmInterference();
            render();
        }

        function completeStep(mId, sIdx) {
            const m = state.missions.find(x => x.id === mId);
            if(m) {
                m.steps[sIdx].completed = true;
                stopAlarmInterference();
                printTerminal(`æ­¥éª¤å·²å®Œæˆã€‚ç£å¯¼è­¦æŠ¥æš‚æ—¶è§£é™¤ã€‚`);
                render();
            }
        }

        function editAndLearnStep(mId, sIdx, val) {
            const m = state.missions.find(x => x.id === mId);
            if(m) {
                m.steps[sIdx].desc = val;
                state.learningMemories.push({ action: `ä¿®æ”¹æ­¥éª¤: ${val}`, time: Date.now() });
                save();
            }
        }

        async function autoAssignMission() {
            printTerminal("æ­£åœ¨æ ¹æ®å†å²è®°å½•åˆ†é…ä»»åŠ¡...");
            const context = { history: state.missions.slice(0,5).map(m=>m.title), memories: state.memories.slice(0,5).map(m=>m.text) };
            const res = await callAI(`å‚è€ƒä¹ æƒ¯ ${JSON.stringify(context.history)}ï¼Œå»ºè®®ä¸€ä¸ªä»»åŠ¡ã€‚è¿”å›JSON: {"title":"å","mins":åˆ†,"reason":"ç†"}`);
            try {
                const data = JSON.parse(res.match(/\{.*\}/s)[0]);
                const newM = { id: Date.now(), title: `[å»ºè®®] ${data.title}`, reward: Math.ceil(data.mins / 5), secondsLeft: data.mins * 60, done: false };
                state.missions.unshift(newM);
                render();
                printTerminal(`å»ºè®®ç†ç”±: ${data.reason}`);
                resetAlarmTimer(newM.id);
            } catch(e) {}
        }

        async function breakdownMission(id) {
            const m = state.missions.find(x => x.id === id);
            printTerminal("æ­£åœ¨æ ¹æ®æ‚¨çš„ä¹ æƒ¯è¿›è¡Œè¿›åŒ–æ‹†è§£...");
            const res = await callAI(`æ‹†è§£ä»»åŠ¡ "${m.title}"ã€‚è¿”å›JSONæ•°ç»„: [{"desc":"æ­¥éª¤"}]`);
            try {
                m.steps = JSON.parse(res.match(/\[.*\]/s)[0]).map(s => ({...s, completed: false}));
                render();
            } catch(e) {}
        }

        async function callAI(p) {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                body: JSON.stringify({ model: "deepseek-chat", messages: [{role:"system",content:"ä½ æ˜¯äººå·¥æ™ºèƒ½ç®¡å®¶è´¾ç»´æ–¯ã€‚"},{role:"user",content:p}] })
            });
            const d = await res.json(); return d.choices[0].message.content;
        }

        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function printTerminal(t) { const b = document.getElementById('terminalBox'); b.innerHTML += `<div>> ${t}</div>`; b.scrollTop = b.scrollHeight; }
        function save() { 
            localStorage.setItem('j_v25_coins', state.coins); 
            localStorage.setItem('j_v25_missions', JSON.stringify(state.missions)); 
            localStorage.setItem('j_v25_memories', JSON.stringify(state.memories)); 
            localStorage.setItem('j_v25_learning', JSON.stringify(state.learningMemories)); 
            localStorage.setItem('j_v25_shop', JSON.stringify(state.shop)); 
        }
        async function sendChat() { 
            const i = document.getElementById('chatInput'); if(!i.value) return;
            state.memories.push({text: i.value, time: new Date().toISOString()});
            printTerminal(`ä¸»äºº: ${i.value}`); 
            const r = await callAI(i.value); printTerminal(`JARVIS: ${r}`); i.value = '';
        }

        init();
    </script>
</body>
</html>
