<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - Floating Command Station V3.1</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #131314; --card: #1E1E20; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #E3E3E3;
            --color-work: #FF4757; --color-life: #70A1FF; --color-fixed: #2ED573; --color-mood: #ECCC68;
        }
        
        body { 
            background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; 
            margin: 0; padding: 20px; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 2px 2px, #333 1px, transparent 0);
            background-size: 40px 40px;
        }

        /* è‡ªç”±æ¡Œé¢å®¹å™¨ */
        #workspace { display: flex; flex-wrap: wrap; gap: 20px; align-content: flex-start; height: 100%; }

        /* æ¨¡å—åŸºç¡€æ ·å¼ï¼šæ”¯æŒæ‹–æ‹½å’Œç¼©æ”¾ */
        .panel { 
            background: var(--card); border-radius: 20px; padding: 18px; 
            border: 1px solid #333; display: flex; flex-direction: column; 
            position: relative; resize: both; overflow: hidden;
            min-width: 300px; min-height: 250px;
            cursor: grab; transition: box-shadow 0.2s;
        }
        .panel:active { cursor: grabbing; box-shadow: 0 0 30px rgba(255, 0, 127, 0.2); }
        .panel.dragging { opacity: 0.4; border: 2px dashed var(--p); }

        /* å³ä¸‹è§’æ‹‰ä¼¸æ‰‹æŸ„ç¾åŒ– */
        .panel::-webkit-resizer { background-color: var(--p); border-radius: 10px 0 0 0; }

        .header { 
            font-size: 10px; text-transform: uppercase; letter-spacing: 2px; 
            color: #888; margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 8px;
            display: flex; justify-content: space-between; pointer-events: none;
        }
        .header span { color: var(--p); text-shadow: 0 0 10px var(--p); }

        /* å…³é”®ï¼šæ‚¬æµ®è¾“å…¥æ¡†çš„å®¹å™¨é€»è¾‘ */
        .content-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; cursor: default; }

        /* æ»šåŠ¨åŒºåŸŸ */
        .scroll-area { 
            flex: 1; overflow-y: auto; padding-right: 5px; scroll-behavior: smooth; 
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨æ‚¬æµ®æ¡†ç•™å‡ºç¼“å†²ç©ºé—´ */
        }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        /* åˆ—è¡¨é¡¹æ ·å¼ */
        .item-row { 
            background: rgba(255,255,255,0.03); border-radius: 12px; padding: 12px; 
            margin-bottom: 10px; border-left: 3px solid var(--p);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- æ ¸å¿ƒï¼šçœŸæ­£æ‚¬æµ®çš„åº•éƒ¨éƒ¨ç½²å° --- */
        .floating-command-deck {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.9); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            backdrop-filter: blur(10px); /* ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
            border: 2px solid var(--p); border-radius: 12px;
            padding: 8px 12px; display: flex; gap: 10px; 
            margin: 10px; /* ä¸è¾¹ç¼˜ä¿æŒè·ç¦» */
            box-shadow: 0 -5px 25px rgba(255, 0, 127, 0.3);
            z-index: 100;
        }
        /* æˆªå›¾åŒæ¬¾éœ“è™¹ç²‰è‰²ç›´è§’ */
        .floating-command-deck::after {
            content: ''; position: absolute; right: -2px; bottom: -2px;
            width: 15px; height: 15px; background: var(--p);
            clip-path: polygon(100% 0, 100% 100%, 0 100%); border-radius: 0 0 12px 0;
            filter: drop-shadow(0 0 5px var(--p));
        }

        input, select { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 6px 12px; font-size: 11px; }
        .terminal { flex: 1; background: #0a0a0a; border-radius: 12px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--blue); overflow-y: auto; margin-bottom: 60px;}
        
        /* æ—¶é—´è½´èŠ‚ç‚¹ */
        .timeline-node { position: relative; padding-left: 45px; margin-bottom: 25px; }
        .timeline-node::before {
            content: ''; position: absolute; left: 19px; top: 20px; bottom: -25px; width: 2px; background: #333;
        }
        .timeline-icon {
            position: absolute; left: 5px; top: 0; width: 30px; height: 30px; 
            background: var(--bg); border: 2px solid var(--p); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 14px; z-index: 2;
        }
    </style>
</head>
<body>

    <div id="workspace">
        <div class="panel" draggable="true" id="mod-assets" style="width: 320px; height: 480px;">
            <div class="header">STATUS // <span>CORE ASSETS</span></div>
            <div class="content-wrapper" onmousedown="event.stopPropagation()">
                <div class="scroll-area">
                    <div style="text-align: center; margin: 15px 0;">
                        <div style="font-size:32px; color:var(--g); font-weight: bold;">ğŸª™ <span id="coinsDisplay">0</span></div>
                        <div style="font-size:11px; color:#666;">âŒ› è‡ªç”±é¢åº¦: <span id="timeDisplay">0</span> MIN</div>
                    </div>
                    <div class="header">SHOP // <span>REWARDS</span></div>
                    <div id="shopList"></div>
                </div>
                <div class="floating-command-deck">
                    <input type="text" id="shopName" placeholder="æ–°å¥–å“...">
                    <input type="number" id="shopCost" placeholder="C" style="width:40px">
                    <button class="p-btn" onclick="addShopItem()">+</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-timeline" style="width: 480px; height: 550px;">
            <div class="header">TIMELINE // <span>MONITORING</span></div>
            <div class="content-wrapper" onmousedown="event.stopPropagation()">
                <div class="scroll-area" id="timelineList">
                    </div>
                <div class="floating-command-deck">
                    <input type="text" id="mTitle" placeholder="ç¢ç¢å¿µã€å¿ƒæƒ…æˆ–æ–°ä»»åŠ¡..." onkeypress="if(event.key==='Enter') deployMission()">
                    <button class="p-btn" style="padding: 6px 15px;" onclick="deployMission()">DEPLOY</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-routine" style="width: 320px; height: 400px;">
            <div class="header">ROUTINES // <span>DAILY</span></div>
            <div class="content-wrapper" onmousedown="event.stopPropagation()">
                <div class="scroll-area" id="routineList"></div>
                <div class="floating-command-deck">
                    <input type="time" id="rTime" value="20:00">
                    <input type="text" id="rTitle" placeholder="å›ºå®šå‘¨æœŸä»»åŠ¡...">
                    <button class="p-btn" onclick="addRoutine()">ADD</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-brain" style="width: 380px; height: 400px;">
            <div class="header">JARVIS // <span>CORE</span></div>
            <div class="content-wrapper" onmousedown="event.stopPropagation()">
                <div class="terminal" id="terminalBox">> æ‚¬æµ®éƒ¨ç½²å° V3.1 å·²é”å®šåº•éƒ¨ä½ç½®ã€‚</div>
                <div class="floating-command-deck">
                    <input type="text" id="chatInput" placeholder="åœ¨æ­¤æ±‡æŠ¥æˆ–åæ§½..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="p-btn" onclick="sendChat()">SEND</button>
                </div>
                <button class="p-btn" style="position:absolute; bottom:65px; left:10px; right:10px; background: var(--g); color: #000;" onclick="aiSuggestion()">è´¾ç»´æ–¯ï¼Œå»ºè®®æˆ‘ç°åœ¨åšä»€ä¹ˆï¼Ÿ</button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        let state = {
            coins: parseInt(localStorage.getItem('j_v31_coins')) || 1000,
            shop: JSON.parse(localStorage.getItem('j_v31_shop')) || [
                { name: "åˆ· 30 åˆ†é’Ÿè§†é¢‘", cost: 100 },
                { name: "ä¼‘æ¯ 15 åˆ†é’Ÿ", cost: 50 }
            ],
            routines: JSON.parse(localStorage.getItem('j_v31_routines')) || [],
            missions: JSON.parse(localStorage.getItem('j_v31_missions')) || [],
            activeId: null
        };

        function init() {
            render();
            setupDragAndDrop();
            setInterval(tick, 1000);
            printTerminal("æŒ‡æŒ¥ä¸­å¿ƒå°±ç»ªã€‚æ‰€æœ‰è¾“å…¥æ¡†å·²å¼ºåˆ¶æ‚¬æµ®äºæ¨¡å—åº•éƒ¨ã€‚");
        }

        // --- æ‹–æ‹½å¸ƒå±€é€»è¾‘ ---
        function setupDragAndDrop() {
            const workspace = document.getElementById('workspace');
            const panels = document.querySelectorAll('.panel');

            panels.forEach(panel => {
                panel.addEventListener('dragstart', (e) => {
                    const rect = panel.getBoundingClientRect();
                    // é¿å¼€å³ä¸‹è§’ç¼©æ”¾æ‰‹æŸ„
                    if (e.clientX > rect.right - 25 && e.clientY > rect.bottom - 25) {
                        e.preventDefault(); return; 
                    }
                    panel.classList.add('dragging');
                });
                panel.addEventListener('dragend', () => panel.classList.remove('dragging'));
            });

            workspace.addEventListener('dragover', e => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                const afterElement = getDragAfterElement(workspace, e.clientX);
                if (afterElement == null) workspace.appendChild(dragging);
                else workspace.insertBefore(dragging, afterElement);
            });
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.panel:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- æ•°æ®æ¸²æŸ“ ---
        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            // å•†åº—
            document.getElementById('shopList').innerHTML = state.shop.map((item, idx) => `
                <div class="item-row">
                    <span>${item.name}</span>
                    <button class="p-btn" style="background:var(--g)" onclick="buyItem(${idx})">${item.cost}C</button>
                </div>
            `).join('');

            // æ—¶é—´è½´
            document.getElementById('timelineList').innerHTML = state.missions.map(m => `
                <div class="timeline-node">
                    <div class="timeline-icon">${m.icon || 'ğŸ“'}</div>
                    <div style="font-size:10px; color:#666; margin-bottom:4px;">${m.startTime}</div>
                    <div style="font-weight:bold; color:${m.active ? 'var(--blue)' : 'inherit'}; cursor:pointer" onclick="toggleMission(${m.id})">
                        ${m.title} ${m.active ? `<span style="color:var(--p)">(${formatTime(m.secondsLeft)})</span>` : ''}
                    </div>
                </div>
            `).join('');

            // å‘¨æœŸ
            document.getElementById('routineList').innerHTML = state.routines.map(r => `
                <div class="item-row" style="border-left-color:var(--color-fixed)">
                    <span><b>[${r.time}]</b> ${r.title}</span>
                    <span style="cursor:pointer" onclick="removeRoutine(${r.id})">Ã—</span>
                </div>
            `).join('');
            save();
        }

        // --- æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ ---
        async function deployMission() {
            const input = document.getElementById('mTitle'); if(!input.value) return;
            printTerminal("è´¾ç»´æ–¯æ­£åœ¨æ¥å…¥ç¥ç»åˆ†æ...");
            const res = await callAI(`åˆ†æä»»åŠ¡: "${input.value}"ï¼Œè¿”å›JSON: {"mins":æ•°å­—, "icon":"å›¾æ ‡"}`);
            const data = JSON.parse(res.match(/\{.*\}/s)[0]);
            
            state.missions.unshift({
                id: Date.now(), title: input.value, startTime: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                secondsLeft: data.mins * 60, icon: data.icon, active: false, reward: Math.ceil(data.mins/5)
            });
            input.value = ''; render();
            const scrollArea = document.querySelector('#mod-timeline .scroll-area');
            scrollArea.scrollTop = 0; // è‡ªåŠ¨æ»šå›é¡¶éƒ¨çœ‹æ–°ä»»åŠ¡
        }

        function buyItem(idx) {
            const item = state.shop[idx];
            if(state.coins >= item.cost) {
                state.coins -= item.cost;
                confetti({ particleCount: 100, origin: { y: 0.7 } });
                printTerminal(`æ¶ˆè´¹æˆåŠŸï¼š${item.name}`);
                render();
            }
        }

        function toggleMission(id) {
            state.missions.forEach(m => m.active = (m.id === id ? !m.active : false));
            render();
        }

        function tick() {
            const active = state.missions.find(m => m.active);
            if(active && active.secondsLeft > 0) {
                active.secondsLeft--;
                if(active.secondsLeft % 10 === 0) render();
            } else if(active && active.secondsLeft <= 0) {
                active.active = false; state.coins += active.reward;
                confetti({ particleCount: 150 });
                printTerminal(`ä»»åŠ¡è¾¾æˆï¼è·å¾—é…¬åŠ³: ${active.reward}C`);
                render();
            }
        }

        function addShopItem() {
            const name = document.getElementById('shopName').value;
            const cost = parseInt(document.getElementById('shopCost').value);
            if(name && cost) { state.shop.push({name, cost}); render(); }
        }

        function addRoutine() {
            const time = document.getElementById('rTime').value;
            const title = document.getElementById('rTitle').value;
            if(title) { state.routines.push({id: Date.now(), time, title}); render(); }
        }

        function removeRoutine(id) { state.routines = state.routines.filter(r => r.id !== id); render(); }

        // --- é€šä¿¡ä¸å·¥å…· ---
        async function callAI(p) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role:"system",content:"ä½ æ˜¯ç®¡å®¶è´¾ç»´æ–¯"},{role:"user",content:p}] })
                });
                const d = await res.json(); return d.choices[0].message.content;
            } catch(e) { return '{"mins":25, "icon":"âš¡"}'; }
        }

        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function printTerminal(t) { const b = document.getElementById('terminalBox'); b.innerHTML += `<div>> ${t}</div>`; b.scrollTop = b.scrollHeight; }
        function save() { 
            localStorage.setItem('j_v31_coins', state.coins); 
            localStorage.setItem('j_v31_shop', JSON.stringify(state.shop));
            localStorage.setItem('j_v31_missions', JSON.stringify(state.missions));
            localStorage.setItem('j_v31_routines', JSON.stringify(state.routines));
        }

        init();
    </script>
</body>
</html>
