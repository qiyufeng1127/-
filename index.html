<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - Evolution System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #1A1A1C; --card: #2C2C2E; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #ffffff; --highlight: #FF6347; }
        body { background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; margin: 0; display: grid; grid-template-columns: 320px 1fr 380px; height: 100vh; gap: 15px; padding: 15px; overflow: hidden; }
        
        /* æè‡´çˆ†é—ª */
        @keyframes emergency-red { 0% { background: #000; } 50% { background: #ff0000; } 100% { background: #000; } }
        .emergency-active { animation: emergency-red 0.1s infinite !important; }
        .emergency-active .panel { opacity: 0.1; }

        .panel { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #777; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .header span { color: var(--p); text-shadow: 0 0 10px var(--p); }
        
        .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; }
        .item-card { background: #333; border-radius: 12px; padding: 12px; margin-bottom: 10px; border-left: 4px solid var(--p); transition: 0.3s; position: relative; }
        .item-card.running { border-left-color: var(--blue); box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); }
        .item-card.done { opacity: 0.4; border-left-color: #555; }

        .input-bar { background: #000; border: 1px solid #444; border-radius: 12px; padding: 8px 12px; display: flex; gap: 8px; margin-top: 10px; }
        input { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 8px 12px; font-size: 11px; }
        
        /* æŠ¥è¡¨é®ç½©å±‚ */
        #reportOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 9999; display: none; 
            flex-direction: column; padding: 50px; align-items: center; overflow-y: auto;
        }
        .report-content { max-width: 800px; width: 100%; color: #fff; line-height: 1.6; }

        .terminal { flex: 1; background: #111; border-radius: 15px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--blue); overflow-y: auto; }
        .timer-text { font-family: monospace; font-size: 18px; color: var(--blue); font-weight: bold; }
        .step-item { display: flex; align-items: center; gap: 8px; margin-top: 8px; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 4px; }
        .step-input { flex: 1; background: transparent; border: none; color: #aaa; font-size: 12px; outline: none; }
    </style>
</head>
<body onclick="stopAlarmInterference()">

    <div id="reportOverlay">
        <button class="p-btn" style="align-self: flex-end;" onclick="closeReport()">å…³é—­æŠ¥å‘Š [ESC]</button>
        <div class="report-content" id="reportData"></div>
    </div>

    <div class="panel">
        <div class="header">STATUS // <span>CORE ASSETS</span></div>
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size:32px; color:var(--g); font-weight: bold;">ğŸª™ <span id="coinsDisplay">0</span></div>
            <div style="font-size:10px; color:#666;">â³ è‡ªç”±é¢åº¦: <span id="timeDisplay">0</span> åˆ†é’Ÿ</div>
        </div>
        <div class="header">SHOP // <span>REWARDS</span></div>
        <div id="shopList" class="scroll-area"></div>
        <div class="input-bar">
            <input type="text" id="shopName" placeholder="è‡ªç”±æ´»åŠ¨...">
            <input type="number" id="shopMins" placeholder="åˆ†é’Ÿ" style="width:40px">
            <button class="p-btn" onclick="addShopItem()">+</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">TIMELINE // <span>MONITORING</span></div>
        <div id="missionList" class="scroll-area"></div>
        <div class="input-bar">
            <input type="text" id="mTitle" placeholder="æ–°ä»»åŠ¡...">
            <button class="p-btn" onclick="deploySmartMission()">éƒ¨ç½²ä»»åŠ¡</button>
        </div>
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <button class="p-btn" style="flex:1; background:#444; color:#fff" onclick="realReport('daily')">ğŸ“Š æ—¥æŠ¥</button>
            <button class="p-btn" style="flex:1; background:#444; color:#fff" onclick="realReport('weekly')">ğŸ“… å‘¨æŠ¥</button>
            <button class="p-btn" style="flex:1; background:#444; color:#fff" onclick="realReport('monthly')">ğŸ† æœˆæŠ¥</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">JARVIS CORE // <span>BRAIN</span></div>
        <div class="terminal" id="terminalBox">> ç›‘å¬ä¸­...</div>
        <div class="input-bar">
            <input type="text" id="chatInput" placeholder="æ±‡æŠ¥è¿›åº¦æˆ–åæ§½..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="p-btn" onclick="sendChat()">SEND</button>
        </div>
        <button class="p-btn" style="margin-top: 10px; background: var(--g); color: #000;" onclick="autoAssignMission()">è´¾ç»´æ–¯ï¼Œå»ºè®®æˆ‘ç°åœ¨åšä»€ä¹ˆï¼Ÿ</button>
    </div>

    <audio id="alarmSfx" loop src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3"></audio>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        let state = {
            coins: parseInt(localStorage.getItem('j_v25_coins')) || 1000,
            missions: JSON.parse(localStorage.getItem('j_v25_missions')) || [],
            memories: JSON.parse(localStorage.getItem('j_v25_memories')) || [],
            learningMemories: JSON.parse(localStorage.getItem('j_v24_learning')) || [],
            shop: JSON.parse(localStorage.getItem('j_v25_shop')) || [],
            activeId: null
        };

        let alarmTimer = null;
        let titleInterval = null;
        let interferenceInterval = null;

        function init() {
            render();
            setInterval(tick, 1000);
            Notification.requestPermission();
            printTerminal("Jarvis ç³»ç»Ÿå·²ä¸Šçº¿ã€‚å…¨åŸŸç£å¯¼æ¨¡å¼æ¿€æ´»ã€‚");
        }

        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            const mBox = document.getElementById('missionList');
            mBox.innerHTML = state.missions.map(m => `
                <div class="item-card ${m.id === state.activeId ? 'running' : ''} ${m.done ? 'done' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="flex:1; cursor:pointer;" onclick="toggleMission(${m.id})">
                            <b style="color:var(--g)">[${m.reward}ğŸª™]</b> ${m.title}
                        </span>
                        <div class="timer-text">${formatTime(m.secondsLeft)}</div>
                    </div>
                    ${m.steps ? m.steps.map((s, idx) => `
                        <div class="step-item">
                            <span style="cursor:pointer" onclick="completeStep(${m.id}, ${idx})">${s.completed ? 'âœ…' : 'â­•'}</span>
                            <input type="text" class="step-input" value="${s.desc}" onchange="editAndLearnStep(${m.id}, ${idx}, this.value)">
                        </div>
                    `).join('') : ''}
                    ${!m.steps && !m.done ? `<button class="p-btn" style="margin-top:10px; width:100%; background:var(--blue)" onclick="breakdownMission(${m.id})">æ‹†è§£ä»»åŠ¡å¹¶å­¦ä¹ </button>` : ''}
                </div>
            `).join('');
            save();
        }

        // --- æŠ¥è¡¨å®ä½“åŠŸèƒ½ ---
        async function realReport(type) {
            const overlay = document.getElementById('reportOverlay');
            const dataBox = document.getElementById('reportData');
            overlay.style.display = 'flex';
            dataBox.innerHTML = `<h2>æ­£åœ¨ç”Ÿæˆ ${type === 'daily' ? 'æ—¥æŠ¥' : type === 'weekly' ? 'å‘¨æŠ¥' : 'æœˆæŠ¥'}...</h2><p>è´¾ç»´æ–¯æ­£åœ¨æ‰«ææ‚¨çš„è¡Œä¸ºæ¨¡å¼å’Œé‡‘å¸æµåŠ¨...</p>`;
            
            const history = state.missions.slice(0, 15);
            const prompt = `ä½ ç°åœ¨æ˜¯è´¾ç»´æ–¯ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ•°æ®å†™ä¸€ä»½${type}æŠ¥å‘Šã€‚æ•°æ®ï¼š${JSON.stringify(history)}ã€‚
            è¦æ±‚ï¼š1. ä½¿ç”¨Markdownæ ¼å¼ã€‚2. åŒ…å«ä¸€ä¸ªä»Šæ—¥é‡‘å¥ã€‚3. è¯­æ°”è¦åƒä¸ªä¸¥å‰ä½†å¿ è¯šçš„ç®¡å®¶ã€‚4. åˆ†æä¸»äººçš„æ•ˆç‡ã€‚`;

            const res = await callAI(prompt);
            dataBox.innerHTML = `<div style="text-align:left">${res.replace(/\n/g, '<br>')}</div>`;
        }

        function closeReport() { document.getElementById('reportOverlay').style.display = 'none'; }

        // --- å¼ºåˆ¶è­¦æŠ¥ï¼ˆå…¨ç½‘é¡µç”Ÿæ•ˆï¼‰ ---
        function startAlarm() {
            document.body.classList.add('emergency-active');
            document.getElementById('alarmSfx').play();
            
            // 1. æ ‡é¢˜çˆ†é—ª
            if(!titleInterval) {
                titleInterval = setInterval(() => {
                    document.title = document.title.includes("ğŸš¨") ? "ã€ï¼ï¼ä»»åŠ¡å¾…å‘½ï¼ï¼ã€‘" : "ã€ğŸš¨ å‘ç°é€ƒé¿è¡Œä¸º ğŸš¨ã€‘";
                }, 100);
            }

            // 2. å¼ºåŠ›é€šçŸ¥
            if(Notification.permission === "granted") {
                new Notification("ğŸš¨ è´¾ç»´æ–¯ç£å¯¼ï¼šæ£€æµ‹åˆ°æ‚¨æ­£åœ¨æ¸¸è¡ï¼", { body: "ä»»åŠ¡å·²åœæ» 60 ç§’ï¼Œè¯·ç«‹å³å›åˆ°å·¥ä½œç«™å®Œæˆç¬¬ä¸€ä¸ªæ­¥éª¤ï¼" });
            }

            // 3. é˜»å¡å¹²æ‰°ï¼ˆå¦‚æœä½ ä¸åœ¨æœ¬ç½‘é¡µï¼Œå¼¹çª—ä¼šå¼ºåˆ¶è®©ä»»åŠ¡æ é—ªçƒï¼‰
            if(!interferenceInterval) {
                interferenceInterval = setInterval(() => {
                    if (document.hidden) { // å¦‚æœä½ ä¸åœ¨è¿™ä¸ªæ ‡ç­¾é¡µ
                        console.error("DETECTED ESCAPE");
                        // è¿™æ˜¯ä¸€ä¸ªè™½ç„¶çƒ¦äººä½†æåº¦æœ‰æ•ˆçš„æ–¹æ³•ï¼Œå¼ºåˆ¶è®©æµè§ˆå™¨è·å¾—ç„¦ç‚¹
                        alert("ğŸš¨ è´¾ç»´æ–¯è­¦å‘Šï¼šä»»åŠ¡æ­£åœ¨ç­‰å¾…ï¼è¯·å‹¿ç¦»å¼€ï¼");
                    }
                }, 3000);
            }
        }

        function stopAlarmInterference() {
            document.body.classList.remove('emergency-active');
            document.getElementById('alarmSfx').pause();
            clearInterval(titleInterval);
            clearInterval(interferenceInterval);
            titleInterval = null;
            interferenceInterval = null;
            document.title = "Jarvis - Focus Mode";
        }

        // --- åŸºç¡€é€»è¾‘ä¿®å¤ ---
        function tick() {
            if(state.activeId) {
                const m = state.missions.find(x => x.id === state.activeId);
                if(m && m.secondsLeft > 0) {
                    m.secondsLeft--;
                    document.title = `[${formatTime(m.secondsLeft)}] ${m.title}`;
                    if(m.secondsLeft % 10 === 0) render();
                } else if(m && m.secondsLeft <= 0 && !m.done) {
                    m.done = true; state.coins += m.reward; state.activeId = null;
                    confetti({particleCount: 150}); render();
                }
            }
        }

        async function deploySmartMission() {
            const title = document.getElementById('mTitle').value;
            if(!title) return;
            printTerminal(`æ­£åœ¨è¯„ä¼°ä»»åŠ¡é‡...`);
            const res = await callAI(`ä¼°ç®—ä»»åŠ¡ "${title}" çš„æ—¶é—´ã€‚è¿”å›JSON: {"mins":æ•°å­—}`);
            try {
                const data = JSON.parse(res.match(/\{.*\}/s)[0]);
                const newM = { id: Date.now(), title, reward: Math.ceil(data.mins / 5), secondsLeft: data.mins * 60, done: false };
                state.missions.unshift(newM);
                document.getElementById('mTitle').value = '';
                render();
                resetAlarmTimer(newM.id);
            } catch(e) { printTerminal("éƒ¨ç½²å¤±è´¥ã€‚"); }
        }

        function resetAlarmTimer(id) {
            clearTimeout(alarmTimer);
            alarmTimer = setTimeout(() => {
                if(state.activeId !== id) startAlarm();
            }, 60000);
        }

        function toggleMission(id) {
            const m = state.missions.find(x => x.id === id);
            if(m.done) return;
            state.activeId = (state.activeId === id) ? null : id;
            if(state.activeId) stopAlarmInterference();
            render();
        }

        function completeStep(mId, sIdx) {
            const m = state.missions.find(x => x.id === mId);
            if(m) {
                m.steps[sIdx].completed = true;
                stopAlarmInterference();
                render();
            }
        }

        async function callAI(p) {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                body: JSON.stringify({ model: "deepseek-chat", messages: [{role:"system",content:"ä½ æ˜¯è´¾ç»´æ–¯ï¼Œé«˜æ•ˆç£å¯¼ç®¡å®¶ã€‚"},{role:"user",content:p}] })
            });
            const d = await res.json(); return d.choices[0].message.content;
        }

        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function printTerminal(t) { const b = document.getElementById('terminalBox'); b.innerHTML += `<div>> ${t}</div>`; b.scrollTop = b.scrollHeight; }
        function save() { 
            localStorage.setItem('j_v25_coins', state.coins); 
            localStorage.setItem('j_v25_missions', JSON.stringify(state.missions)); 
            localStorage.setItem('j_v25_memories', JSON.stringify(state.memories)); 
        }

        async function breakdownMission(id) {
            const m = state.missions.find(x => x.id === id);
            printTerminal("æ­£åœ¨æ‹†è§£æ­¥éª¤...");
            const res = await callAI(`æ‹†è§£ä»»åŠ¡ "${m.title}"ã€‚JSON: [{"desc":"æ­¥éª¤"}]`);
            try {
                m.steps = JSON.parse(res.match(/\[.*\]/s)[0]).map(s => ({...s, completed: false}));
                render();
            } catch(e) {}
        }

        init();
    </script>
</body>
</html>
