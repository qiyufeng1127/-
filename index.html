<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Jarvis Matrix V3.9 - Part 1</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #0d0d0e; --card: #161617; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #E3E3E3;
            --c-work: #FF4757; --c-life: #70A1FF; --c-routine: #2ED573; --c-mood: #ECCC68;
        }
        
        body { 
            background: var(--bg); color: var(--text); font-family: 'Inter', 'PingFang SC', sans-serif; 
            margin: 0; padding: 15px; height: 100vh; overflow: hidden;
            background-image: radial-gradient(#222 1px, transparent 1px); background-size: 25px 25px;
        }

        /* å¼ºåˆ¶ 5 åˆ—å¹³é“ºå¸ƒå±€ï¼Œç»ä¸ç¼©å‡ */
        #matrix-shell { 
            display: grid; grid-template-columns: repeat(5, minmax(320px, 1fr)); 
            gap: 15px; height: 95vh; overflow-x: auto; padding-bottom: 10px;
        }

        .panel { 
            background: var(--card); border-radius: 16px; border: 1px solid #2d2d2d; 
            display: flex; flex-direction: column; position: relative; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        /* æ»šåŠ¨å†…å®¹åŒºä¸åº•éƒ¨è¾“å…¥æ ç‰©ç†éš”ç¦» */
        .content { flex: 1; overflow-y: auto; padding: 15px 15px 120px; scrollbar-width: none; }
        .content::-webkit-scrollbar { display: none; }

        /* éœ“è™¹åˆ‡è§’è¾“å…¥æ  */
        .dock {
            position: absolute; bottom: 15px; left: 12px; right: 12px;
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(12px);
            border: 1.8px solid var(--p); border-radius: 10px; padding: 8px 12px;
            display: flex; gap: 10px; z-index: 1000; box-shadow: 0 0 20px rgba(255, 0, 127, 0.2);
        }
        .dock::after { content:''; position:absolute; right:-2px; bottom:-2px; width:14px; height:14px; background:var(--p); clip-path:polygon(100% 0, 100% 100%, 0 100%); }

        /* 24å°æ—¶åŸç”Ÿæ—¶é—´è½´ */
        .row { display: flex; gap: 12px; margin-bottom: 18px; position: relative; }
        .time-tag { width: 45px; font-size: 10px; color: #555; text-align: right; font-family: monospace; padding-top: 4px; }
        .axis { position: relative; width: 16px; display: flex; justify-content: center; }
        .axis-line { position: absolute; top: 20px; bottom: -25px; width: 2px; background: #252525; }
        .axis-dot { width: 10px; height: 10px; border-radius: 50%; background: #000; border: 2px solid #333; z-index: 2; margin-top: 5px; }
        
        .card { 
            flex: 1; background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px; 
            border-left: 4px solid #333; transition: 0.3s;
        }

        /* åŠ¨æ€é…è‰²å¼•æ“ */
        .type-work { border-left-color: var(--c-work); }
        .type-life { border-left-color: var(--c-life); }
        .type-routine { border-left-color: var(--c-routine); }
        .type-mood { border-left-color: var(--c-mood); }
        .active-dot { border-color: var(--p) !important; box-shadow: 0 0 12px var(--p); }

        /* æˆªå›¾åŒæ¬¾é‡‘å¸èµ„äº§ç›’ */
        .asset-box { border: 2px solid var(--g); border-radius: 12px; padding: 20px; text-align: center; background: rgba(255,215,0,0.05); margin-bottom: 25px; }
        .coin-val { font-size: 38px; font-weight: bold; color: var(--g); display: block; }

        .p-btn { background: var(--p); color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; padding: 7px 15px; font-size: 11px; flex-shrink: 0; }
        input { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        
        /* å­ä»»åŠ¡æ ·å¼ */
        .sub-item { font-size: 11px; color: #888; margin-top: 8px; display: flex; align-items: center; gap: 8px; }
        .sub-dot { width: 6px; height: 6px; border: 1.5px solid var(--p); border-radius: 50%; }
    </style>
</head>
<body>

<div id="matrix-shell">
    <div class="panel">
        <div style="padding:15px; font-size:10px; color:#555;">STATUS // <span style="color:var(--p)">ASSETS</span></div>
        <div class="content">
            <div class="asset-box">
                <span class="coin-val">ğŸª™ <span id="c_val">1000</span></span>
                <span style="font-size:11px; color:#666;">è‡ªç”±æ—¶é—´é¢åº¦: <span id="m_val">5000</span> MIN</span>
            </div>
            <div id="shop_list"></div>
        </div>
        <div class="dock"><input type="text" id="s_n" placeholder="æ–°å¥–åŠ±é¡¹ç›®..."><button class="p-btn" onclick="addShop()">+</button></div>
    </div>

    <div class="panel" style="grid-column: span 1.2;">
        <div style="padding:15px; font-size:10px; color:#555;">DAILY // <span style="color:var(--p)">FLOW</span></div>
        <div class="content" id="flow_list"></div>
        <div class="dock"><input type="text" id="f_n" placeholder="å†™ç‚¹ç¢ç¢å¿µæˆ–æ—¥å¸¸..."><button class="p-btn" onclick="addFlow()">LOG</button></div>
    </div>

    <div class="panel" style="grid-column: span 1.2;">
        <div style="padding:15px; font-size:10px; color:#555;">TIMELINE // <span style="color:var(--p)">MONITORING</span></div>
        <div class="content" id="mission_list"></div>
        <div class="dock"><input type="text" id="m_n" placeholder="éƒ¨ç½²æ–°ä»»åŠ¡æˆ–å¿ƒæƒ…..."><button class="p-btn" onclick="deploy()">DEPLOY</button></div>
    </div>

    <div class="panel">
        <div style="padding:15px; font-size:10px; color:#555;">ROUTINES // <span style="color:var(--p)">FIXED</span></div>
        <div class="content" id="routine_list"></div>
        <div class="dock"><input type="time" id="r_t" value="09:00"><input type="text" id="r_n" placeholder="å›ºå®šå‘¨æœŸé¡¹..."><button class="p-btn" onclick="addRoutine()">ADD</button></div>
    </div>

    <div class="panel">
        <div style="padding:15px; font-size:10px; color:#555;">JARVIS // <span style="color:var(--p)">CORE</span></div>
        <div class="content" id="term" style="font-family:monospace; font-size:11px; color:var(--blue)">
            <div>> çŸ©é˜µ V3.9 UI Part 1 åŠ è½½æˆåŠŸã€‚</div>
        </div>
        <div class="dock"><input type="text" id="chat_i" placeholder="æ±‡æŠ¥è¿›åº¦..."><button class="p-btn" onclick="chat()">SEND</button></div>
    </div>
</div>
<script>
    // 1. æ ¸å¿ƒçŠ¶æ€åˆå§‹åŒ–
    let state = {
        coins: 1000,
        missions: [],
        flow: [],
        routines: [
            {time: "09:00", title: "æ™¨é—´å”¤é†’/æ´—æ¼±", type: "routine"},
            {time: "12:00", title: "èƒ½é‡åˆé¤", type: "routine"},
            {time: "20:00", title: "å½“æ—¥è¿›åº¦å¤ç›˜", type: "routine"},
            {time: "23:30", title: "ç³»ç»Ÿä¼‘çœ æ¨¡å¼", type: "routine"}
        ],
        shop: [
            {n: "åˆ·30minè§†é¢‘", c: 100},
            {n: "ç¾å‘³é›¶é£Ÿå¥–åŠ±", c: 50}
        ]
    };

    // 2. æ ¸å¿ƒæ¸²æŸ“å¼•æ“ï¼šå¤„ç† 24H åŸç”Ÿæ—¶é—´è½´
    function render() {
        // æ›´æ–°èµ„äº§æ•°å€¼
        document.getElementById('c_val').innerText = state.coins;
        document.getElementById('m_val').innerText = state.coins * 5;

        // æ¸²æŸ“å…¨æ—¥æµ (åŒºå— 2)
        let flowH = '';
        for(let i=8; i<=24; i++) {
            const hourStr = i.toString().padStart(2,'0') + ":00";
            // ç­›é€‰è¯¥æ—¶æ®µå†…çš„æ‰€æœ‰ä»»åŠ¡ä¸è®°å½•
            const hourItems = [...state.flow, ...state.routines].filter(it => 
                it.time.startsWith(i.toString().padStart(2,'0'))
            );
            
            flowH += `
                <div class="row">
                    <div class="time-tag">${hourStr}</div>
                    <div class="axis">
                        <div class="axis-dot"></div>
                        <div class="axis-line"></div>
                    </div>
                    <div class="card ${hourItems.length ? 'type-'+(hourItems[0].type||'mood') : ''}">
                        ${hourItems.map(it => `<div style="margin-bottom:4px;">${it.title}</div>`).join('') || '<span style="color:#222">---</span>'}
                    </div>
                </div>`;
        }
        document.getElementById('flow_list').innerHTML = flowH;

        // æ¸²æŸ“ä»»åŠ¡ç›‘æ§ (åŒºå— 3)
        document.getElementById('mission_list').innerHTML = state.missions.map(m => `
            <div class="row">
                <div class="time-tag">${m.start}</div>
                <div class="axis">
                    <div class="axis-dot ${m.active ? 'active-dot' : ''}"></div>
                    <div class="axis-line"></div>
                </div>
                <div class="card type-${m.type}" onclick="toggleM(${m.id})">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>${m.title}</span>
                        <span style="color:var(--p)">${Math.floor(m.rem/60)}m</span>
                    </div>
                    ${m.steps ? m.steps.map(s => `<div class="sub-item"><div class="sub-dot"></div>${s}</div>`).join('') : ''}
                </div>
            </div>
        `).join('');

        // æ¸²æŸ“å›ºå®šä»»åŠ¡ä¸å•†åº—
        document.getElementById('routine_list').innerHTML = state.routines.map(r => `
            <div class="card type-routine" style="margin-bottom:10px"><b>[${r.time}]</b> ${r.title}</div>
        `).join('');
        
        document.getElementById('shop_list').innerHTML = state.shop.map((s, idx) => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                <span>${s.n}</span>
                <button class="p-btn" style="background:var(--g)" onclick="buy(${idx})">${s.c}C</button>
            </div>
        `).join('');
        
        save();
    }

    // 3. ä¸šåŠ¡é€»è¾‘å‡½æ•°
    async function deploy() {
        const input = document.getElementById('m_n');
        if(!input.value) return;
        
        printTerm(`æ­£åœ¨åˆ†æä»»åŠ¡ç»´åº¦...`);
        try {
            const res = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer sk-520f594ef712411d97f24cf387047c1c'
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {role: "system", content: "è¿”å›JSON:{mins:æ•°å­—,type:'work/life',steps:['æ­¥éª¤1','æ­¥éª¤2']}"},
                        {role: "user", content: input.value}
                    ]
                })
            });
            const d = await res.json();
            const data = JSON.parse(d.choices[0].message.content.match(/\{.*\}/s)[0]);
            
            state.missions.unshift({
                id: Date.now(),
                title: input.value,
                start: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                rem: data.mins * 60,
                type: data.type,
                steps: data.steps,
                active: false,
                reward: Math.ceil(data.mins / 5)
            });
            input.value = '';
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
            render();
        } catch(e) {
            printTerm("AI æ¥å£è¿æ¥å¤±è´¥ï¼Œå·²è½¬å…¥æœ¬åœ°ä»»åŠ¡æ¨¡å¼ã€‚");
        }
    }

    function toggleM(id) {
        state.missions.forEach(m => m.active = (m.id === id ? !m.active : false));
        render();
    }

    function addFlow() {
        const input = document.getElementById('f_n');
        if(!input.value) return;
        state.flow.push({
            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            title: input.value,
            type: 'mood'
        });
        input.value = '';
        render();
    }

    function addRoutine() {
        const t = document.getElementById('r_t').value;
        const n = document.getElementById('r_n').value;
        if(!n) return;
        state.routines.push({time: t, title: n, type: 'routine'});
        render();
    }

    // 4. ç³»ç»Ÿè®¡æ—¶å™¨
    setInterval(() => {
        const active = state.missions.find(m => m.active);
        if(active && active.rem > 0) {
            active.rem--;
            if(active.rem % 10 === 0) render(); // æ¯10ç§’åˆ·æ–°UIå‡è½»å‹åŠ›
        } else if(active && active.rem <= 0) {
            active.active = false;
            state.coins += active.reward;
            confetti({ particleCount: 150 });
            printTerm(`ä»»åŠ¡å®Œæˆï¼å…¥è´¦ ${active.reward}C`);
            render();
        }
    }, 1000);

    // 5. è¾…åŠ©åŠŸèƒ½
    function printTerm(t) {
        const box = document.getElementById('term');
        box.innerHTML += `<div>> ${t}</div>`;
        box.scrollTop = box.scrollHeight;
    }
    function save() { localStorage.setItem('jarvis_v39_state', JSON.stringify(state)); }
    function load() {
        const s = localStorage.getItem('jarvis_v39_state');
        if(s) state = JSON.parse(s);
    }

    load();
    render();
</script>
</body>
</html>
