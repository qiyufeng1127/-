<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - EXTREME CONTROL</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #1A1A1C; --card: #2C2C2E; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #ffffff; --highlight: #FF6347; }
        body { background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; margin: 0; display: grid; grid-template-columns: 320px 1fr 380px; height: 100vh; gap: 15px; padding: 15px; overflow: hidden; }
        
        /* æè‡´çˆ†é—ªåŠ¨ç”» */
        @keyframes emergency-red { 
            0% { background: var(--bg); } 25% { background: #660000; } 50% { background: #000000; } 75% { background: #bb0000; } 100% { background: var(--bg); } 
        }
        .emergency-active { animation: emergency-red 0.15s infinite !important; }
        .emergency-active .panel { opacity: 0.5; }

        .panel { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #777; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .header span { color: var(--p); text-shadow: 0 0 10px var(--p); }
        
        .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; }
        .item-card { background: #333; border-radius: 12px; padding: 12px; margin-bottom: 10px; border-left: 4px solid var(--p); transition: 0.3s; position: relative; }
        .item-card.running { border-left-color: var(--blue); box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); }
        .item-card.done { opacity: 0.4; border-left-color: #555; }

        .input-bar { background: #000; border: 1px solid #444; border-radius: 12px; padding: 8px 12px; display: flex; gap: 8px; margin-top: 10px; }
        input { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 8px 12px; font-size: 11px; }
        .report-btn { background: #444; color: white; flex: 1; }

        .terminal { flex: 1; background: #111; border-radius: 15px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--blue); overflow-y: auto; }
        .timer-text { font-family: monospace; font-size: 18px; color: var(--blue); font-weight: bold; }
        .step-item { font-size: 12px; margin-top: 8px; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="panel">
        <div class="header">STATUS // <span>CORE ASSETS</span></div>
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size:32px; color:var(--g); font-weight: bold;">ğŸª™ <span id="coinsDisplay">0</span></div>
            <div style="font-size:10px; color:#666;">è‡ªç”±é¢åº¦: <span id="timeDisplay">0</span> åˆ†é’Ÿ</div>
        </div>
        <div class="header">SHOP // <span>REWARDS</span></div>
        <div id="shopList" class="scroll-area"></div>
        <div class="input-bar">
            <input type="text" id="shopName" placeholder="è‡ªç”±æ´»åŠ¨...">
            <input type="number" id="shopMins" placeholder="åˆ†é’Ÿ" style="width:40px">
            <button class="p-btn" onclick="addShopItem()">+</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">TIMELINE // <span>MONITORING</span></div>
        <div id="missionList" class="scroll-area"></div>
        <div class="input-bar">
            <input type="text" id="mTitle" placeholder="æ–°ä»»åŠ¡...">
            <button class="p-btn" onclick="deploySmartMission()">æ™ºèƒ½éƒ¨ç½²</button>
        </div>
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <button class="p-btn report-btn" onclick="generateReport('daily')">æ—¥æŠ¥</button>
            <button class="p-btn report-btn" onclick="generateReport('weekly')">å‘¨æŠ¥</button>
            <button class="p-btn report-btn" onclick="generateReport('monthly')">æœˆæŠ¥</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">JARVIS CORE // <span>BRAIN</span></div>
        <div class="terminal" id="terminalBox">> ç›‘å¬ä¸­...</div>
        <div class="input-bar">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æ±‡æŠ¥..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="p-btn" onclick="sendChat()">SEND</button>
        </div>
        <button class="p-btn" style="margin-top: 10px; background: var(--g); color: #000;" onclick="autoAssignMission()">è´¾ç»´æ–¯ï¼Œæˆ‘ç°åœ¨è¯¥å¹²ä»€ä¹ˆï¼Ÿ</button>
    </div>

    <audio id="alarmSfx" loop src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3"></audio>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        let state = {
            coins: parseInt(localStorage.getItem('j_v23_coins')) || 1000,
            missions: JSON.parse(localStorage.getItem('j_v23_missions')) || [],
            memories: JSON.parse(localStorage.getItem('j_v23_memories')) || [],
            shop: JSON.parse(localStorage.getItem('j_v23_shop')) || [],
            activeId: null
        };

        let alarmTimer = null;
        let titleInterval = null;

        function init() {
            render();
            setInterval(tick, 1000);
            Notification.requestPermission();
            printTerminal("ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸã€‚è­¦æŠ¥å·²é”å®šï¼Œåªèƒ½é€šè¿‡è¡ŒåŠ¨è§£é™¤ã€‚");
        }

        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            const mBox = document.getElementById('missionList');
            mBox.innerHTML = state.missions.map(m => `
                <div class="item-card ${m.id === state.activeId ? 'running' : ''} ${m.done ? 'done' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="flex:1; cursor:pointer;" onclick="toggleMission(${m.id})">
                            <b style="color:var(--g)">[${m.reward}ğŸª™]</b> ${m.title}
                        </span>
                        <div class="timer-text">${formatTime(m.secondsLeft)}</div>
                    </div>
                    ${m.steps ? m.steps.map((s, idx) => `
                        <div class="step-item" onclick="completeStep(${m.id}, ${idx})">
                            ${s.completed ? 'âœ…' : 'â­•'} ${s.desc} (${s.mins}m)
                        </div>
                    `).join('') : ''}
                    ${!m.steps && !m.done ? `<button class="p-btn" style="margin-top:10px; width:100%; background:var(--blue)" onclick="breakdownMission(${m.id})">æ‹†è§£å¹¶å¼€å¯è­¦æŠ¥é”å®š</button>` : ''}
                </div>
            `).join('');

            const sBox = document.getElementById('shopList');
            sBox.innerHTML = state.shop.map((s, idx) => `
                <div class="item-card" style="border-left-color: var(--blue)" onclick="buyItem(${idx})">
                    <b>${s.name}</b> (${s.mins}m) <span style="float:right; color:var(--highlight)">-${s.price}ğŸª™</span>
                </div>
            `).join('');
            save();
        }

        async function deploySmartMission() {
            const title = document.getElementById('mTitle').value;
            if(!title) return;
            printTerminal(`æ­£åœ¨è¯„ä¼°: ${title}...`);
            const res = await callAI(`é¢„ä¼°ä»»åŠ¡ "${title}" çš„åˆ†é’Ÿæ•°ã€‚è¿”å›JSON: {"mins":æ•°å­—}`);
            try {
                const data = JSON.parse(res.match(/\{.*\}/s)[0]);
                const newM = { id: Date.now(), title, reward: Math.ceil(data.mins / 5), secondsLeft: data.mins * 60, done: false };
                state.missions.unshift(newM);
                document.getElementById('mTitle').value = '';
                render();
                resetAlarmTimer(newM.id);
            } catch(e) { printTerminal("éƒ¨ç½²å¼‚å¸¸ã€‚"); }
        }

        async function autoAssignMission() {
            printTerminal("æ­£åœ¨åˆ†ææ‚¨çš„è¿‘æœŸè®°å¿†å’Œä¹ æƒ¯...");
            const context = { history: state.missions.slice(0,5).map(m=>m.title), memories: state.memories.slice(0,5).map(m=>m.text) };
            const res = await callAI(`å‚è€ƒå†å² ${JSON.stringify(context.history)} å’Œè®°å¿† ${JSON.stringify(context.memories)}ï¼Œå»ºè®®ä¸€ä¸ªæˆ‘ç°åœ¨è¯¥åšçš„ä»»åŠ¡ã€‚è¿”å›JSON: {"title":"ä»»åŠ¡å","mins":åˆ†é’Ÿ,"reason":"ç†ç”±"}`);
            try {
                const data = JSON.parse(res.match(/\{.*\}/s)[0]);
                const newM = { id: Date.now(), title: `[å»ºè®®] ${data.title}`, reward: Math.ceil(data.mins / 5), secondsLeft: data.mins * 60, done: false };
                state.missions.unshift(newM);
                render();
                printTerminal(`è´¾ç»´æ–¯å»ºè®®: ${data.reason}`);
                resetAlarmTimer(newM.id);
            } catch(e) { printTerminal("æ— æ³•è·å–å»ºè®®ã€‚"); }
        }

        async function breakdownMission(id) {
            const m = state.missions.find(x => x.id === id);
            const res = await callAI(`æ‹†è§£ä»»åŠ¡ "${m.title}" ä¸º3æ­¥ã€‚JSONæ ¼å¼: [{"desc":"æ­¥éª¤å","mins":æ•°å­—}]`);
            try {
                m.steps = JSON.parse(res.match(/\[.*\]/s)[0]).map(s => ({...s, completed: false}));
                render();
            } catch(e) { printTerminal("æ‹†è§£å¤±è´¥ã€‚"); }
        }

        function completeStep(mId, sIdx) {
            const m = state.missions.find(x => x.id === mId);
            if(m && m.steps[sIdx]) {
                m.steps[sIdx].completed = true;
                printTerminal(`å­æ­¥éª¤å®Œæˆã€‚è­¦æŠ¥å·²è§£é™¤ã€‚`);
                stopAlarm();
                render();
            }
        }

        function toggleMission(id) {
            const m = state.missions.find(x => x.id === id);
            if(m.done) return;
            state.activeId = (state.activeId === id) ? null : id;
            if(state.activeId) stopAlarm();
            render();
        }

        function resetAlarmTimer(id) {
            clearTimeout(alarmTimer);
            alarmTimer = setTimeout(() => {
                if(state.activeId !== id) startAlarm();
            }, 60000);
        }

        function startAlarm() {
            document.body.classList.add('emergency-active');
            document.getElementById('alarmSfx').play();
            if(!titleInterval) {
                titleInterval = setInterval(() => {
                    document.title = document.title.includes("ğŸš¨") ? "ã€ï¼ï¼ä»»åŠ¡ï¼ï¼ã€‘" : "ã€ğŸš¨ è­¦å‘Š ğŸš¨ã€‘";
                }, 100);
            }
            if(Notification.permission === "granted") new Notification("ğŸš¨ è´¾ç»´æ–¯ç£å¯¼ï¼šç«‹å³å¼€å§‹ä»»åŠ¡ï¼");
        }

        function stopAlarm() {
            document.body.classList.remove('emergency-active');
            document.getElementById('alarmSfx').pause();
            clearInterval(titleInterval);
            titleInterval = null;
            document.title = "Jarvis - Active";
            clearTimeout(alarmTimer);
        }

        function tick() {
            if(state.activeId) {
                const m = state.missions.find(x => x.id === state.activeId);
                if(m && m.secondsLeft > 0) { m.secondsLeft--; render(); }
                else if(m && m.secondsLeft <= 0 && !m.done) {
                    m.done = true; state.coins += m.reward; state.activeId = null;
                    confetti({particleCount: 150}); render();
                }
            }
        }

        async function callAI(p) {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                body: JSON.stringify({ model: "deepseek-chat", messages: [{role:"system",content:"ä½ æ˜¯è´¾ç»´æ–¯ï¼Œé«˜æ•ˆç£å¯¼ã€‚"},{role:"user",content:p}] })
            });
            const d = await res.json(); return d.choices[0].message.content;
        }

        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function printTerminal(t) { const b = document.getElementById('terminalBox'); b.innerHTML += `<div>> ${t}</div>`; b.scrollTop = b.scrollHeight; }
        function save() { localStorage.setItem('j_v23_coins', state.coins); localStorage.setItem('j_v23_missions', JSON.stringify(state.missions)); localStorage.setItem('j_v23_memories', JSON.stringify(state.memories)); localStorage.setItem('j_v23_shop', JSON.stringify(state.shop)); }
        async function sendChat() { 
            const i = document.getElementById('chatInput'); if(!i.value) return;
            state.memories.push({text: i.value, time: new Date().toISOString()});
            printTerminal(`ä¸»äºº: ${i.value}`); 
            const r = await callAI(i.value); printTerminal(`JARVIS: ${r}`); i.value = '';
        }

        init();
    </script>
</body>
</html>
