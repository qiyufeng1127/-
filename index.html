<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - Five-Dimensional Command Center V3.5</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #131314; --card: #1E1E20; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #E3E3E3;
            --c-work: #FF4757; --c-life: #70A1FF; --c-routine: #2ED573; --c-mood: #ECCC68; --c-empty: #333;
        }
        
        body { 
            background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; 
            margin: 0; padding: 15px; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 1px 1px, #2a2a2a 1px, transparent 0);
            background-size: 30px 30px;
        }

        /* Â∏ÉÂ±ÄÂºïÊìé */
        #workspace { 
            display: grid; 
            grid-template-columns: repeat(5, minmax(300px, 1fr)); 
            gap: 15px; height: 95vh; overflow-x: auto; padding-bottom: 20px;
        }

        .panel { 
            background: var(--card); border-radius: 20px; border: 1px solid #333; 
            display: flex; flex-direction: column; position: relative; overflow: visible;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); min-width: 300px;
        }

        .panel-header { padding: 15px 18px; cursor: grab; display: flex; justify-content: space-between; align-items: center; }
        .header-tag { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: #777; }
        .header-tag span { color: var(--p); font-weight: bold; text-shadow: 0 0 8px var(--p); }

        .module-body { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; padding: 0 15px; }
        .scroll-area { flex: 1; overflow-y: auto; padding-bottom: 100px; scrollbar-width: none; }
        .scroll-area::-webkit-scrollbar { display: none; }

        /* --- Ê†∏ÂøÉÔºöÊÇ¨ÊµÆÈÉ®ÁΩ≤Âè∞ --- */
        .floating-dock {
            position: absolute; bottom: 15px; left: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px);
            border: 2px solid var(--p); border-radius: 12px;
            padding: 8px 12px; display: flex; gap: 8px; align-items: center;
            z-index: 1000; box-shadow: 0 0 20px rgba(255, 0, 127, 0.3);
        }
        .floating-dock::after {
            content: ''; position: absolute; right: -2px; bottom: -2px;
            width: 12px; height: 12px; background: var(--p);
            clip-path: polygon(100% 0, 100% 100%, 0 100%); border-radius: 0 0 12px 0;
        }

        /* --- ÂàóË°®‰∏éÊó∂Èó¥ËΩ¥ÁæéÂåñ --- */
        .flow-item { 
            display: flex; gap: 15px; margin-bottom: 20px; position: relative; 
            padding-left: 10px;
        }
        .time-col { width: 50px; font-size: 10px; color: #666; text-align: right; padding-top: 5px; }
        .node-col { position: relative; width: 20px; display: flex; justify-content: center; }
        .node-line { position: absolute; top: 25px; bottom: -25px; width: 2px; background: #333; }
        .node-dot { 
            width: 14px; height: 14px; border-radius: 50%; background: var(--bg); 
            border: 2px solid var(--c-empty); z-index: 2; margin-top: 5px;
        }
        .content-card { 
            flex: 1; background: rgba(255,255,255,0.03); border-radius: 12px; 
            padding: 12px; border-left: 4px solid var(--c-empty);
        }

        /* ÈáëÂ∏ÅÁõíÊ†∑Âºè */
        .coin-box { 
            border: 2px solid var(--g); border-radius: 8px; padding: 15px;
            text-align: center; background: rgba(255, 215, 0, 0.05); margin: 10px 0;
        }

        input { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; padding: 6px 12px; font-size: 11px; }
        .yellow-btn { background: var(--g); width: 100%; margin-top: 10px; color: #000; border-radius: 8px; padding: 10px; font-weight: bold; border: none; cursor: pointer; }

        /* ÂΩ©Ëâ≤Ê†áÁ≠æÊò†Â∞Ñ */
        .c-work { border-left-color: var(--c-work) !important; }
        .c-life { border-left-color: var(--c-life) !important; }
        .c-routine { border-left-color: var(--c-routine) !important; }
        .c-mood { border-left-color: var(--c-mood) !important; }
        .dot-active { border-color: var(--p) !important; box-shadow: 0 0 8px var(--p); }

        .sub-step { font-size: 11px; color: #888; margin-top: 6px; display: flex; align-items: center; gap: 5px; }
        .sub-circle { width: 6px; height: 6px; border: 1px solid var(--p); border-radius: 50%; }
    </style>
</head>
<body>

    <div id="workspace">
        <div class="panel">
            <div class="panel-header"><div class="header-tag">STATUS // <span>ASSETS</span></div></div>
            <div class="module-body">
                <div class="scroll-area">
                    <div class="coin-box">
                        <div style="font-size:32px; font-weight:bold; color:var(--g);">ü™ô <span id="coinsDisplay">1000</span></div>
                        <div style="font-size:10px; color:#555; margin-top:5px;">‚è≥ Ëá™Áî±È¢ùÂ∫¶: <span id="timeDisplay">5000</span> MIN</div>
                    </div>
                    <div class="header-tag" style="margin: 15px 0;">SHOP // <span>REWARDS</span></div>
                    <div id="shopList"></div>
                </div>
                <div class="floating-dock">
                    <input type="text" id="shopName" placeholder="Êñ∞Â•ñÂä±...">
                    <input type="number" id="shopCost" placeholder="C" style="width:40px">
                    <button class="p-btn" onclick="addShopItem()">+</button>
                </div>
            </div>
        </div>

        <div class="panel" style="grid-column: span 1.2;">
            <div class="panel-header"><div class="header-tag">DAILY // <span>FLOW</span></div></div>
            <div class="module-body">
                <div class="scroll-area" id="dailyFlowList">
                    </div>
                <div class="floating-dock">
                    <input type="text" id="flowInput" placeholder="ËÆ∞ÂΩïÊ≠§ÂàªÁöÑÊó•Â∏∏ÊàñÂøÉÊÉÖ..." onkeypress="if(event.key==='Enter') addFlow()">
                    <button class="p-btn" onclick="addFlow()">LOG</button>
                </div>
            </div>
        </div>

        <div class="panel" style="grid-column: span 1.2;">
            <div class="panel-header"><div class="header-tag">TIMELINE // <span>MONITORING</span></div></div>
            <div class="module-body">
                <div class="scroll-area" id="timelineList"></div>
                <div class="floating-dock">
                    <input type="text" id="mTitle" placeholder="Á¢éÁ¢éÂøµÊàñÊ≠£Âºè‰ªªÂä°..." onkeypress="if(event.key==='Enter') deployMission()">
                    <button class="p-btn" onclick="deployMission()">DEPLOY</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><div class="header-tag">ROUTINES // <span>FIXED</span></div></div>
            <div class="module-body">
                <div class="scroll-area" id="routineList"></div>
                <div class="floating-dock">
                    <input type="time" id="rTime" value="09:00">
                    <input type="text" id="rTitle" placeholder="Âõ∫ÂÆöÂë®ÊúüÈ°π...">
                    <button class="p-btn" onclick="addRoutine()">ADD</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><div class="header-tag">JARVIS // <span>CORE</span></div></div>
            <div class="module-body">
                <div class="scroll-area" id="terminalBox" style="font-family:monospace; font-size:11px; color:var(--blue)">
                    <div>> ‰∫îÁª¥ÊåáÊå•Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê„ÄÇ</div>
                    <div>> DAILY FLOW Â∑≤Ê≥®ÂÖ•ÂéüÁîüÊó∂Èó¥ÂàªÂ∫¶„ÄÇ</div>
                </div>
                <button class="yellow-btn" onclick="aiSuggestion()">Ë¥æÁª¥ÊñØÔºåÂª∫ËÆÆÊàëÁé∞Âú®ÂÅö‰ªÄ‰πàÔºü</button>
                <div class="floating-dock" style="bottom: 70px;">
                    <input type="text" id="chatInput" placeholder="Ê±áÊä•ÊàñÂêêÊßΩ..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="p-btn" onclick="sendChat()">SEND</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        let state = {
            coins: parseInt(localStorage.getItem('jv35_coins')) || 1000,
            shop: JSON.parse(localStorage.getItem('jv35_shop')) || [{name:"‰ºëÊÅØ15min", cost:50}],
            missions: JSON.parse(localStorage.getItem('jv35_missions')) || [],
            routines: JSON.parse(localStorage.getItem('jv35_routines')) || [
                {time: "09:00", title: "Êô®Èó¥Ê∏ÖÁêÜ", type: "routine"},
                {time: "12:00", title: "ÂçàÈ§ê/ËÉΩÈáèË°•Áªô", type: "routine"}
            ],
            flow: JSON.parse(localStorage.getItem('jv35_flow')) || []
        };

        function init() {
            render();
            setInterval(tick, 1000);
            printTerminal("ÂÖàÁîüÔºåÊâÄÊúâÂå∫ÂùóÂ∑≤Â∞±Áª™„ÄÇÂÖ®Êó•ÊµÅÊó∂Èó¥ËΩ¥Â∑≤ÂØπÈΩê„ÄÇ");
        }

        // --- Ê∏≤ÊüìÂºïÊìé ---
        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            // 1. Ê∏≤ÊüìÂÖ®Êó•ÊµÅ (ÂåÖÂê´Âõ∫ÂÆö‰ªªÂä°ÂíåÁ©∫ÁôΩÂàªÂ∫¶)
            const flowArea = document.getElementById('dailyFlowList');
            let flowHTML = '';
            const hours = Array.from({length: 15}, (_, i) => i + 8); // 08:00 - 22:00
            
            hours.forEach(h => {
                const timeStr = `${h.toString().padStart(2,'0')}:00`;
                const items = [...state.flow, ...state.routines].filter(i => i.time.startsWith(h.toString().padStart(2,'0')));
                
                flowHTML += `
                    <div class="flow-item">
                        <div class="time-col">${timeStr}</div>
                        <div class="node-col"><div class="node-dot"></div><div class="node-line"></div></div>
                        <div class="content-card">
                            ${items.length > 0 ? items.map(it => `
                                <div style="margin-bottom:5px; color:${it.type==='routine'?'var(--c-routine)':'#fff'}">
                                    ${it.type==='routine'?'üìÖ':'üìç'} ${it.title}
                                </div>
                            `).join('') : '<span style="color:#333">Á©∫Èó≤Êó∂ÊÆµ</span>'}
                        </div>
                    </div>
                `;
            });
            flowArea.innerHTML = flowHTML;

            // 2. Ê∏≤ÊüìÊó∂Èó¥ËΩ¥ÁõëÊéß
            document.getElementById('timelineList').innerHTML = state.missions.map(m => `
                <div class="flow-item">
                    <div class="time-col">${m.startTime}</div>
                    <div class="node-col"><div class="node-dot ${m.active?'dot-active':''}"></div><div class="node-line"></div></div>
                    <div class="content-card c-${m.type || 'work'}" onclick="toggleMission(${m.id})">
                        <div style="font-weight:bold; display:flex; justify-content:space-between">
                            <span>${m.icon || '‚ö°'} ${m.title}</span>
                            <span style="color:var(--p)">${formatTime(m.secondsLeft)}</span>
                        </div>
                        ${m.steps ? m.steps.map(s => `<div class="sub-step"><span class="sub-circle"></span>${s}</div>`).join('') : ''}
                    </div>
                </div>
            `).join('');

            // 3. Ê∏≤ÊüìÂõ∫ÂÆöÂë®Êúü
            document.getElementById('routineList').innerHTML = state.routines.map(r => `
                <div class="content-card c-routine" style="margin-bottom:10px">
                    <b>[${r.time}]</b> ${r.title}
                </div>
            `).join('');

            // 4. Ê∏≤ÊüìÂïÜÂ∫ó
            document.getElementById('shopList').innerHTML = state.shop.map((item, idx) => `
                <div class="content-card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                    <span>${item.name}</span>
                    <button class="p-btn" style="background:var(--g)" onclick="buyItem(${idx})">${item.cost}C</button>
                </div>
            `).join('');

            save();
        }

        // --- Ê†∏ÂøÉÈÄªËæë ---
        async function deployMission() {
            const input = document.getElementById('mTitle'); if(!input.value) return;
            printTerminal("Ê≠£Âú®ÊãÜËß£‰ªªÂä°Áª¥Â∫¶...");
            const res = await callAI(`‰ªªÂä°:"${input.value}"„ÄÇËøîÂõûJSON:{"mins":Êï∞Â≠ó,"type":"work/life/mood","icon":"ÂõæÊ†á","steps":["Ê≠•È™§1","Ê≠•È™§2"]}`);
            const data = JSON.parse(res.match(/\{.*\}/s)[0]);
            
            state.missions.unshift({
                id: Date.now(), title: input.value, startTime: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                secondsLeft: data.mins * 60, type: data.type, icon: data.icon, steps: data.steps, active: false, reward: Math.ceil(data.mins/5)
            });
            input.value = ''; render();
        }

        function addFlow() {
            const input = document.getElementById('flowInput'); if(!input.value) return;
            state.flow.push({
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                title: input.value, type: 'mood'
            });
            input.value = ''; render();
        }

        function toggleMission(id) {
            state.missions.forEach(m => m.active = (m.id === id ? !m.active : false));
            render();
        }

        function tick() {
            const active = state.missions.find(m => m.active);
            if(active && active.secondsLeft > 0) {
                active.secondsLeft--;
                if(active.secondsLeft % 10 === 0) render();
            } else if(active && active.secondsLeft <= 0) {
                active.active = false; state.coins += active.reward;
                confetti({ particleCount: 100 });
                render();
            }
        }

        async function callAI(p) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role:"system",content:"‰Ω†ÊòØÁÆ°ÂÆ∂Ë¥æÁª¥ÊñØ"},{role:"user",content:p}] })
                });
                const d = await res.json(); return d.choices[0].message.content;
            } catch(e) { return '{"mins":25, "type":"work", "steps":["ÊâãÂä®ÊâßË°å‰∏≠"]}'; }
        }

        function printTerminal(t) { const b = document.getElementById('terminalBox'); b.innerHTML += `<div>> ${t}</div>`; b.scrollTop = b.scrollHeight; }
        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function save() { Object.keys(state).forEach(k => localStorage.setItem('jv35_'+k, JSON.stringify(state[k]))); }

        init();
    </script>
</body>
</html>
