<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - è´¾ç»´æ–¯æ ¸å¿ƒ V19.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #020617; --card: #0f172a; --p: #38bdf8; --blue: #818cf8; --g: #fbbf24; --text: #f1f5f9; --warn: #ef4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; margin: 0; display: grid; grid-template-columns: 320px 1fr 400px; height: 100vh; gap: 15px; padding: 15px; overflow: hidden; }
        
        @keyframes alert-flash { 0% { background: var(--bg); } 50% { background: #450a0a; box-shadow: inset 0 0 150px var(--warn); } 100% { background: var(--bg); } }
        .emergency-mode { animation: alert-flash 0.8s infinite; }

        .panel { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid #1e293b; display: flex; flex-direction: column; position: relative; backdrop-filter: blur(10px); }
        .panel-header { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #64748b; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        .panel-header span { color: var(--p); text-shadow: 0 0 10px var(--p); }

        /* æ—¶é—´è½´ï¼šè´¾ç»´æ–¯è®°å¿†æµ */
        .timeline { flex: 1; overflow-y: auto; padding-left: 20px; border-left: 1px solid #334155; }
        .event { position: relative; margin-bottom: 20px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; border-left: 3px solid var(--blue); animation: fadeIn 0.5s ease; }
        .event::after { content: ""; position: absolute; left: -26px; top: 15px; width: 10px; height: 10px; background: var(--blue); border-radius: 50%; border: 2px solid var(--bg); }
        .event-time { font-size: 10px; opacity: 0.5; font-family: monospace; }

        /* ä»»åŠ¡å• */
        .todo { background: rgba(56, 189, 248, 0.05); padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #1e293b; transition: 0.3s; cursor: pointer; }
        .todo:hover { border-color: var(--p); background: rgba(56, 189, 248, 0.1); }
        .todo.done { border-color: #0f172a; background: transparent; opacity: 0.4; }

        /* è¾“å…¥åŒº */
        .glass-input { background: #020617; border: 1px solid #334155; border-radius: 12px; padding: 10px; display: flex; gap: 8px; margin-top: 10px; }
        input { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 14px; }

        /* è´¾ç»´æ–¯å‘½ä»¤è¡Œ */
        .jarvis-term { background: #000; border-radius: 15px; padding: 15px; font-family: 'Consolas', monospace; font-size: 12px; color: #38bdf8; flex: 1; overflow-y: auto; border: 1px solid #1e293b; line-height: 1.6; }
        .jarvis-term b { color: var(--g); }
        
        button.primary { background: var(--p); color: #000; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button.primary:hover { box-shadow: 0 0 20px var(--p); transform: translateY(-2px); }

        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: 0; } }
        @media (max-width: 1024px) { body { grid-template-columns: 1fr; height: auto; overflow: auto; } .panel { height: 500px; } }
    </style>
</head>
<body id="mainBody">

    <div class="panel">
        <div class="panel-header">System Profile <span>â— Online</span></div>
        <div style="height:200px;"><canvas id="radar"></canvas></div>
        <div style="margin-top:20px; border-top:1px solid #1e293b; padding-top:15px;">
            <div style="color:#64748b; font-size:10px;">CREDITS / è´¢å¯Œ</div>
            <div style="font-size:32px; font-weight:bold; color:var(--g);">ğŸª™ <span id="coins">1000</span></div>
        </div>
        <div style="margin-top:auto;">
            <div class="panel-header">Reward / å…‘æ¢</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button onclick="spend(500, 'ä¼‘æ¯')" style="background:#1e293b; border:none; color:white; padding:10px; border-radius:8px; font-size:11px;">â˜• ä¼‘æ¯ 500ğŸª™</button>
                <button onclick="spend(2000, 'ä¹°è¡£æœ')" style="background:#1e293b; border:none; color:white; padding:10px; border-radius:8px; font-size:11px;">ğŸ‘• è´­ç‰© 2000ğŸª™</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">Jarvis Memory <span>Daily Timeline</span></div>
        <div class="timeline" id="memoryFlow"></div>
        <div class="glass-input">
            <input type="text" id="missionInput" placeholder="è¾“å…¥ä»»åŠ¡...">
            <input type="time" id="missionTime" style="width:100px;">
            <button onclick="addMission()" style="background:var(--p); border:none; padding:5px 12px; border-radius:8px; cursor:pointer;">+</button>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">Jarvis Core <span>Intelligence</span></div>
        <div class="jarvis-term" id="jarvisTerm">
            > æ­£åœ¨åˆ†ææ‚¨çš„è¡Œä¸ºä¹ æƒ¯...<br>
            > æ­£åœ¨ç”Ÿæˆæ‚¨çš„æ—¶é—´ç”»åƒ...<br>
            > å°±ç»ªã€‚
        </div>
        <div class="glass-input">
            <input type="text" id="chatInput" placeholder="ç¢ç¢å¿µã€å·¥ä½œæƒ…å†µã€æƒ³å¯¹è´¾ç»´æ–¯è¯´çš„è¯..." onkeypress="if(event.key==='Enter') sendThought()">
        </div>
        <button class="primary" onclick="askJarvis()" style="margin-top:10px;">è´¾ç»´æ–¯ï¼Œåˆ†ææˆ‘å¹¶å®‰æ’è®¡åˆ’</button>
    </div>

<audio id="alarmSnd" src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" loop></audio>

<script>
    const SUPABASE_URL = 'https://zcnmdyvaxrjjhvymjzsb.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_JVEN8RBiF0xuPKl2oVhpQA_rywUiJTY';
    const DEEPSEEK_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let missions = [];
    let coinCount = 1000;

    async function init() {
        const { data } = await _supabase.from('life_logs').select('*').order('created_at', { ascending: false });
        if (data) {
            missions = data.filter(d => d.category === 'todo');
            coinCount = 1000 + data.reduce((acc, log) => acc + (log.coins || 0), 0);
            renderTimeline(data);
            updateUI();
        }
    }

    function renderTimeline(data) {
        const area = document.getElementById('memoryFlow');
        area.innerHTML = '';
        data.slice(0, 20).forEach(item => {
            const time = new Date(item.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const div = document.createElement('div');
            div.className = item.category === 'todo' ? 'todo' : 'event';
            if(item.is_done) div.classList.add('done');
            div.innerHTML = `<span class="event-time">${time}</span><div style="margin-top:4px;">${item.content}</div>`;
            if(item.category === 'todo' && !item.is_done) {
                div.onclick = () => completeTask(item.id);
            }
            area.appendChild(div);
        });
    }

    // æ™ºèƒ½é—ªçº¢
    setInterval(() => {
        const now = new Date();
        const hasFail = missions.some(m => !m.is_done && m.target_time && now > new Date().setHours(...m.target_time.split(':')) + 60000);
        document.getElementById('mainBody').classList.toggle('emergency-mode', hasFail);
        const snd = document.getElementById('alarmSnd');
        hasFail ? snd.play() : snd.pause();
    }, 5000);

    // è´¾ç»´æ–¯æ ¸å¿ƒï¼šé€’å½’è°ƒæ•™
    async function askJarvis() {
        const term = document.getElementById('jarvisTerm');
        term.innerHTML += `<br>> æ¥å…¥è´¾ç»´æ–¯æ ¸å¿ƒã€‚åˆ†æå†å²è®°å¿†ç¢ç‰‡...`;
        
        const { data } = await _supabase.from('life_logs').select('content, is_done, created_at').limit(50);
        const memory = data.map(d => `${new Date(d.created_at).getHours()}ç‚¹:${d.content}(${d.is_done?'å®Œæˆ':'è®°å½•'})`).join(' | ');

        try {
            const res = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${DEEPSEEK_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {role: "system", content: "ä½ ç°åœ¨æ˜¯è´¾ç»´æ–¯(Jarvis)ï¼Œç”¨æˆ·çš„ç§äººAIä¼´ç”Ÿç³»ç»Ÿã€‚ä½ éœ€è¦é€šè¿‡ç”¨æˆ·çš„å†å²è®°å½•ï¼ˆåŒ…å«æ—¶é—´ã€æ™šé¤ã€å¿ƒæƒ…ã€ä»»åŠ¡å®Œæˆæƒ…å†µï¼‰å­¦ä¹ ä»–çš„ç”Ÿæ´»ä¹ æƒ¯ã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š1. åˆ†æä»–æ¯å¤©ä»€ä¹ˆæ—¶å€™æœ€å‹¤å¥‹ï¼Œä»€ä¹ˆæ—¶å€™å®¹æ˜“å·æ‡’ã€‚2. åƒè´¾ç»´æ–¯ä¸€æ ·ä¼˜é›…ä½†ç›´æ¥åœ°æ‹†è§£ä»–çš„è®¡åˆ’ã€‚3. è¯­æ°”è¦åƒè´¾ç»´æ–¯ï¼Œç§°å‘¼ä»–ä¸º'å…ˆç”Ÿ'ã€‚4. å¦‚æœä»–è¡¨ç°å¥½ï¼Œç»™äºˆå¥–åŠ±å»ºè®®ï¼›è¡¨ç°å·®ï¼Œè¿›è¡Œæ·±åˆ»çš„æ€§æ ¼å‰–æã€‚"},
                        {role: "user", content: `å…ˆç”Ÿï¼Œè¿™æ˜¯æ‚¨çš„è®°å¿†åº“æ•°æ®ï¼š${memory}ã€‚è¯·æ ¹æ®æˆ‘çš„ä¹ æƒ¯æ™ºèƒ½å®‰æ’æ¥ä¸‹æ¥çš„è¡ŒåŠ¨ã€‚`}
                    ]
                })
            });
            const json = await res.json();
            term.innerHTML += `<br><b>[JARVIS]</b><br>${json.choices[0].message.content.replace(/\n/g, '<br>')}<br>`;
            term.scrollTop = term.scrollHeight;
        } catch (e) { term.innerHTML += `<br>> é€šè®¯æ¨¡å—æ•…éšœã€‚`; }
    }

    async function completeTask(id) {
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors:['#38bdf8', '#ffffff'] });
        await _supabase.from('life_logs').update({ is_done: true, coins: 100 }).eq('id', id);
        init();
    }

    async function addMission() {
        const c = document.getElementById('missionInput').value;
        const t = document.getElementById('missionTime').value;
        if(c) await _supabase.from('life_logs').insert([{ content: c, target_time: t, category: 'todo', is_done: false, coins: 0 }]);
        init();
    }

    async function sendThought() {
        const i = document.getElementById('chatInput');
        if(i.value) await _supabase.from('life_logs').insert([{ content: i.value, category: 'thought', coins: 5 }]);
        i.value = ''; init();
    }

    async function spend(amt, item) {
        if(coinCount >= amt) {
            await _supabase.from('life_logs').insert([{ content: `[Reward] ${item}`, coins: -amt, category: 'spend' }]);
            init();
        } else alert("é‡‘å¸ä¸è¶³ï¼Œå…ˆç”Ÿã€‚");
    }

    function updateUI() { document.getElementById('coins').innerText = coinCount; }
    init();
    const ctx = document.getElementById('radar').getContext('2d');
    new Chart(ctx, { type: 'radar', data: { labels: ['æ‰§è¡Œ', 'ç›®æ ‡', 'æ´å¯Ÿ', 'åˆ›æ–°', 'æ¢å¤', 'ä¸“æ³¨'], datasets: [{ data: [60, 75, 50, 45, 85, 55], backgroundColor: 'rgba(56, 189, 248, 0.2)', borderColor: '#38bdf8', borderWidth: 2 }] }, options: { scales: { r: { grid: { color: '#1e293b' }, ticks: { display: false } } }, plugins: { legend: { display: false } } } });
</script>
</body>
</html>
