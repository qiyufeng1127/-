<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - Penta-Matrix Evolution V3.6</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #131314; --card: #1E1E20; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #E3E3E3;
            --c-work: #FF4757; --c-life: #70A1FF; --c-routine: #2ED573; --c-mood: #ECCC68; --c-empty: #2A2A2A;
        }
        
        body { 
            background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; 
            margin: 0; padding: 15px; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 1px 1px, #2a2a2a 1px, transparent 0);
            background-size: 30px 30px;
        }

        /* 5åˆ—ç½‘æ ¼å¸ƒå±€ï¼šä»£ç é‡æ‰©å……æ ¸å¿ƒ */
        #workspace { 
            display: grid; grid-template-columns: repeat(5, minmax(320px, 1fr)); 
            gap: 15px; height: 96vh; overflow-x: auto; padding-bottom: 20px;
        }

        .panel { 
            background: var(--card); border-radius: 20px; border: 1px solid #333; 
            display: flex; flex-direction: column; position: relative; overflow: visible;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }

        .panel-header { padding: 18px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .header-tag { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: #777; }
        .header-tag span { color: var(--p); font-weight: bold; text-shadow: 0 0 10px var(--p); }

        /* å†…å®¹ä¸æ‚¬æµ®é€»è¾‘å¢å¼º */
        .module-body { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .scroll-area { 
            flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 110px; /* ç•™è¶³æ‚¬æµ®ç©ºé—´ */
            scrollbar-width: none; 
        }
        .scroll-area::-webkit-scrollbar { display: none; }

        /* ç»ˆææ‚¬æµ®è¾“å…¥æ¡† */
        .floating-dock {
            position: absolute; bottom: 15px; left: 12px; right: 12px;
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(15px);
            border: 2px solid var(--p); border-radius: 12px;
            padding: 10px 15px; display: flex; gap: 10px; align-items: center;
            z-index: 2000; box-shadow: 0 -5px 25px rgba(0,0,0,0.8);
        }
        .floating-dock::after {
            content: ''; position: absolute; right: -2px; bottom: -2px;
            width: 15px; height: 15px; background: var(--p);
            clip-path: polygon(100% 0, 100% 100%, 0 100%); border-radius: 0 0 12px 0;
        }

        /* å…¨æ—¥æµæ—¶é—´è½´æ¸²æŸ“ */
        .timeline-row { display: flex; gap: 15px; margin-bottom: 15px; position: relative; }
        .time-label { width: 45px; font-size: 10px; color: #555; text-align: right; font-family: monospace; }
        .time-axis { position: relative; width: 20px; display: flex; justify-content: center; }
        .axis-line { position: absolute; top: 20px; bottom: -20px; width: 2px; background: #2A2A2A; z-index: 1; }
        .axis-dot { 
            width: 12px; height: 12px; border-radius: 50%; background: var(--bg); 
            border: 2px solid var(--c-empty); z-index: 2; margin-top: 2px; transition: 0.3s;
        }
        .flow-card { 
            flex: 1; background: rgba(255,255,255,0.02); border-radius: 12px; 
            padding: 12px; border-left: 4px solid var(--c-empty); min-height: 40px;
        }

        /* æˆªå›¾åŒæ¬¾æ ·å¼è¡¥å®Œ */
        .coin-box { border: 2px solid var(--g); border-radius: 10px; padding: 20px; text-align: center; background: rgba(255,215,0,0.05); margin-bottom: 20px; }
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 7px 15px; font-size: 11px; }
        .yellow-btn { background: var(--g); width: 100%; border: none; border-radius: 8px; padding: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* ä¸åŒä»»åŠ¡çš„çŠ¶æ€é¢œè‰² */
        .c-work { border-left-color: var(--c-work); }
        .c-life { border-left-color: var(--c-life); }
        .c-routine { border-left-color: var(--c-routine); }
        .c-mood { border-left-color: var(--c-mood); }
        .dot-active { border-color: var(--p) !important; box-shadow: 0 0 10px var(--p); }

        .sub-task { font-size: 11px; color: #888; margin-top: 8px; display: flex; align-items: center; gap: 8px; }
        .sub-dot { width: 7px; height: 7px; border: 1.5px solid var(--p); border-radius: 50%; }
    </style>
</head>
<body>

    <div id="workspace">
        <div class="panel">
            <div class="panel-header"><div class="header-tag">STATUS // <span>CORE ASSETS</span></div></div>
            <div class="module-body">
                <div class="scroll-area">
                    <div class="coin-box">
                        <div style="font-size:36px; font-weight:bold; color:var(--g);">ğŸª™ <span id="coinsDisplay">1000</span></div>
                        <div style="font-size:11px; color:#666; margin-top:5px;">â³ è‡ªç”±é¢åº¦: <span id="timeDisplay">5000</span> MIN</div>
                    </div>
                    <div class="header-tag" style="margin-bottom:12px">SHOP // <span>REWARDS</span></div>
                    <div id="shopList"></div>
                </div>
                <div class="floating-dock">
                    <input type="text" id="shopName" placeholder="æ–°å¥–åŠ±é¡¹ç›®...">
                    <input type="number" id="shopCost" placeholder="C" style="width:40px">
                    <button class="p-btn" onclick="addShopItem()">+</button>
                </div>
            </div>
        </div>

        <div class="panel" style="grid-column: span 1.2;">
            <div class="panel-header"><div class="header-tag">DAILY // <span>FLOW</span></div></div>
            <div class="module-body">
                <div class="scroll-area" id="dailyFlowList">
                    </div>
                <div class="floating-dock">
                    <input type="text" id="flowInput" placeholder="è®°å½•æ­¤åˆ»çš„æ—¥å¸¸ã€ç¢ç¢å¿µæˆ–åæ§½..." onkeypress="if(event.key==='Enter') addFlow()">
                    <button class="p-btn" onclick="addFlow()">LOG</button>
                </div>
            </div>
        </div>

        <div class="panel" style="grid-column: span 1.2;">
            <div class="panel-header"><div class="header-tag">TIMELINE // <span>MONITORING</span></div></div>
            <div class="module-body">
                <div class="scroll-area" id="timelineList"></div>
                <div class="floating-dock">
                    <input type="text" id="mTitle" placeholder="ç¢ç¢å¿µã€å¿ƒæƒ…æˆ–æ–°ä»»åŠ¡..." onkeypress="if(event.key==='Enter') deployMission()">
                    <button class="p-btn" onclick="deployMission()">DEPLOY</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><div class="header-tag">ROUTINES // <span>FIXED</span></div></div>
            <div class="module-body">
                <div class="scroll-area" id="routineList"></div>
                <div class="floating-dock">
                    <input type="time" id="rTime" value="09:00">
                    <input type="text" id="rTitle" placeholder="å›ºå®šå‘¨æœŸé¡¹...">
                    <button class="p-btn" onclick="addRoutine()">ADD</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><div class="header-tag">JARVIS // <span>CORE</span></div></div>
            <div class="module-body">
                <div class="scroll-area" id="terminalBox" style="font-family:monospace; color:var(--blue); font-size:11px;">
                    <div>> äº”ç»´çŸ©é˜µ V3.6 åˆå§‹åŒ–...</div>
                    <div>> ç‹¬ç«‹æ—¶é—´è½´å¼•æ“å·²åŠ è½½ã€‚</div>
                </div>
                <div style="padding:0 15px 110px">
                    <button class="yellow-btn" onclick="aiSuggestion()">è´¾ç»´æ–¯ï¼Œå»ºè®®æˆ‘ç°åœ¨åšä»€ä¹ˆï¼Ÿ</button>
                </div>
                <div class="floating-dock">
                    <input type="text" id="chatInput" placeholder="æ±‡æŠ¥è¿›åº¦æˆ–è°ƒæˆè´¾ç»´æ–¯..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="p-btn" onclick="sendChat()">SEND</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        // åˆå§‹å›ºå®šä»»åŠ¡
        let state = {
            coins: 1000,
            shop: [{name:"åˆ·30minè§†é¢‘", cost:100}, {name:"åƒä¸ªé›¶é£Ÿ", cost:50}],
            missions: [],
            routines: [
                {time: "09:00", title: "æ™¨é—´å”¤é†’/æ´—æ¼±", type: "routine", icon: "ğŸŒ…"},
                {time: "12:00", title: "åˆé¤èƒ½é‡è¡¥ç»™", type: "routine", icon: "ğŸ±"},
                {time: "20:00", title: "å½“æ—¥å¤ç›˜æ€»ç»“", type: "routine", icon: "ğŸ“"}
            ],
            flow: []
        };

        function init() {
            load();
            render();
            setInterval(() => { tick(); }, 1000);
            printTerminal("ç³»ç»Ÿå°±ç»ªã€‚å…¨æ—¥æ—¶é—´è½´å·²æŒ‰ç…§ 08:00 - 24:00 ç”Ÿæˆåˆ»åº¦ã€‚");
        }

        // --- æ ¸å¿ƒæ¸²æŸ“ï¼šè‡ªåŠ¨ç”Ÿæˆæ—¶é—´è½´ ---
        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            // æ¸²æŸ“å…¨æ—¥æµï¼šç”Ÿæˆå›ºå®šåˆ»åº¦
            const flowArea = document.getElementById('dailyFlowList');
            let flowHTML = '';
            for(let h=8; h<=23; h++) {
                const timeStr = `${h.toString().padStart(2,'0')}:00`;
                const matchedItems = [...state.flow, ...state.routines].filter(i => i.time.startsWith(h.toString().padStart(2,'0')));
                
                flowHTML += `
                    <div class="timeline-row">
                        <div class="time-label">${timeStr}</div>
                        <div class="time-axis"><div class="axis-dot"></div><div class="axis-line"></div></div>
                        <div class="flow-card ${matchedItems.length>0 ? 'c-'+(matchedItems[0].type||'mood') : ''}">
                            ${matchedItems.length > 0 ? matchedItems.map(it => `
                                <div style="margin-bottom:5px;">${it.icon||'ğŸ“'} ${it.title}</div>
                            `).join('') : '<span style="color:#2a2a2a">ç©ºé—²æ—¶æ®µ</span>'}
                        </div>
                    </div>
                `;
            }
            flowArea.innerHTML = flowHTML;

            // æ¸²æŸ“ä»»åŠ¡ç›‘æ§ï¼šå¤šè‰²æ¸²æŸ“
            document.getElementById('timelineList').innerHTML = state.missions.map(m => `
                <div class="timeline-row">
                    <div class="time-label">${m.startTime}</div>
                    <div class="time-axis">
                        <div class="axis-dot ${m.active?'dot-active':''}"></div>
                        <div class="axis-line"></div>
                    </div>
                    <div class="flow-card c-${m.type || 'work'}" onclick="toggleMission(${m.id})">
                        <div style="font-weight:bold; display:flex; justify-content:space-between">
                            <span>${m.icon || 'âš¡'} ${m.title}</span>
                            <span style="color:var(--p)">${formatTime(m.secondsLeft)}</span>
                        </div>
                        ${m.steps ? m.steps.map(s => `<div class="sub-task"><span class="sub-dot"></span>${s}</div>`).join('') : ''}
                    </div>
                </div>
            `).join('');

            // å…¶ä½™æ¨¡å—æ¸²æŸ“
            document.getElementById('routineList').innerHTML = state.routines.map(r => `
                <div class="flow-card c-routine" style="margin-bottom:10px"><b>[${r.time}]</b> ${r.title}</div>
            `).join('');
            
            document.getElementById('shopList').innerHTML = state.shop.map((item, idx) => `
                <div class="flow-card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
                    <span>${item.name}</span>
                    <button class="p-btn" style="background:var(--g)" onclick="buyItem(${idx})">${item.cost}C</button>
                </div>
            `).join('');
            save();
        }

        // --- ä¸šåŠ¡é€»è¾‘ ---
        async function deployMission() {
            const input = document.getElementById('mTitle'); if(!input.value) return;
            printTerminal("æ­£åœ¨åˆ†æä»»åŠ¡ç»´åº¦å¹¶æ‹†è§£å­ä»»åŠ¡...");
            const res = await callAI(`ä»»åŠ¡:"${input.value}"ã€‚è¿”å›JSON:{"mins":æ•°å­—,"type":"work/life/mood","icon":"å›¾æ ‡","steps":["æ­¥éª¤1","æ­¥éª¤2"]}`);
            try {
                const data = JSON.parse(res.match(/\{.*\}/s)[0]);
                state.missions.unshift({
                    id: Date.now(), title: input.value, startTime: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                    secondsLeft: data.mins * 60, type: data.type, icon: data.icon, steps: data.steps, active: false, reward: Math.ceil(data.mins/5)
                });
                input.value = ''; render();
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
            } catch(e) { printTerminal("è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚"); }
        }

        function addFlow() {
            const input = document.getElementById('flowInput'); if(!input.value) return;
            state.flow.push({
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                title: input.value, type: 'mood', icon: 'ğŸ’­'
            });
            input.value = ''; render();
        }

        function toggleMission(id) {
            state.missions.forEach(m => m.active = (m.id === id ? !m.active : false));
            render();
        }

        function tick() {
            const active = state.missions.find(m => m.active);
            if(active && active.secondsLeft > 0) {
                active.secondsLeft--;
                if(active.secondsLeft % 10 === 0) render();
            } else if(active && active.secondsLeft <= 0) {
                active.active = false; state.coins += active.reward;
                confetti({ particleCount: 150 });
                printTerminal(`ä»»åŠ¡å®Œæˆï¼Œå·²å…¥è´¦ ${active.reward}Cã€‚`);
                render();
            }
        }

        async function callAI(p) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role:"system",content:"ä½ æ˜¯AIç®¡å®¶è´¾ç»´æ–¯"},{role:"user",content:p}] })
                });
                const d = await res.json(); return d.choices[0].message.content;
            } catch(e) { return '{"mins":25, "type":"work", "steps":["é»˜è®¤æ‰§è¡Œç¬¬ä¸€æ­¥"]}'; }
        }

        function printTerminal(t) { const b = document.getElementById('terminalBox'); b.innerHTML += `<div>> ${t}</div>`; b.scrollTop = b.scrollHeight; }
        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function save() { localStorage.setItem('jv36_state', JSON.stringify(state)); }
        function load() { const s = localStorage.getItem('jv36_state'); if(s) state = JSON.parse(s); }

        init();
    </script>
</body>
</html>
