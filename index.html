<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Great Me - ç‰¹å·¥æŒ‡æŒ¥éƒ¨ V17.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #050505; --card: #111113; --p: #ff4d94; --blue: #00d2ff; --g: #ffb800; --text: #e0e0e0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; margin: 0; display: grid; grid-template-columns: 320px 1fr 350px; height: 100vh; gap: 15px; padding: 15px; overflow: hidden; }
        
        /* å“åº”å¼é€‚é… */
        @media (max-width: 1024px) { body { grid-template-columns: 1fr; overflow-y: auto; height: auto; } .panel { min-height: 500px; height: auto; } }

        .panel { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid #222; display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h3 { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #666; margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px; }
        h3::before { content: ""; width: 6px; height: 6px; background: var(--p); border-radius: 50%; }

        /* ä»»åŠ¡æ¸…å•åŒº */
        .todo-list { flex: 1; overflow-y: auto; }
        .todo-item { background: #1a1a1e; padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid #28282d; display: flex; align-items: center; transition: 0.3s; }
        .todo-item.done { opacity: 0.5; border-color: #333; }
        .todo-info { flex: 1; }
        .todo-time { font-size: 11px; color: var(--blue); margin-top: 4px; }
        .check-btn { width: 24px; height: 24px; border: 2px solid var(--p); border-radius: 50%; cursor: pointer; margin-right: 15px; position: relative; }
        .check-btn.active::after { content: "âœ”"; position: absolute; left: 4px; top: -2px; color: var(--p); }

        /* è¾“å…¥ä¸é‡‘å¸ */
        .input-group { background: #1a1a1e; border-radius: 16px; padding: 10px; margin-top: 10px; border: 1px solid #333; }
        input, select { background: transparent; border: none; color: white; outline: none; width: 100%; padding: 8px; font-size: 14px; }
        .coin-display { font-size: 24px; font-weight: 900; color: var(--g); text-shadow: 0 0 10px rgba(255,184,0,0.3); }

        /* AI ç»ˆç«¯ */
        .terminal { background: #08080a; border-radius: 16px; padding: 15px; font-family: monospace; font-size: 12px; line-height: 1.6; color: #00ffaa; flex: 1; overflow-y: auto; border: 1px solid #222; }
        
        /* å•†åº—åŒº */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .shop-item { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; border: 1px solid #333; font-size: 12px; cursor: pointer; text-align: center; }
        .shop-item:hover { background: rgba(255,255,255,0.08); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="panel">
        <h3>AGENT PROFILE / ç‰¹å·¥æ¡£æ¡ˆ</h3>
        <canvas id="radar" style="max-height: 200px;"></canvas>
        <div style="margin: 20px 0; display:flex; justify-content:space-between; align-items:end;">
            <div><div style="color:#666; font-size:10px;">CREDITS / é‡‘å¸</div><div class="coin-display">ğŸª™ <span id="coins">1000</span></div></div>
            <div style="text-align:right;"><div style="color:#666; font-size:10px;">RANK</div><div style="font-weight:bold; color:var(--p)">LV.01 åˆçº§ç‰¹å·¥</div></div>
        </div>
        
        <h3>UPGRADE SHOP / è¡¥ç»™å•†åº—</h3>
        <div class="shop-grid">
            <div class="shop-item" onclick="buy(200, '30åˆ†é’Ÿæ¸¸æˆæ—¶é—´')">ğŸ® æ¸¸æˆ 30min<br><small>200ğŸª™</small></div>
            <div class="shop-item" onclick="buy(500, 'è´­ä¹°ä¸€ä»¶æ–°è¡£æœ')">ğŸ‘• æ–°è¡£æœå¥–åŠ±<br><small>5000ğŸª™</small></div>
            <div class="shop-item" onclick="buy(100, 'å¥–åŠ±ä¸€æ¯å¥¶èŒ¶')">ğŸ§‹ å¥¶èŒ¶å¥–åŠ±<br><small>1000ğŸª™</small></div>
            <div class="shop-item" onclick="buy(0, 'è‡ªå®šä¹‰å¥–åŠ±')">ğŸ è‡ªå®šä¹‰<br><small>åå•†</small></div>
        </div>
    </div>

    <div class="panel">
        <h3>MISSION CONTROL / ä»»åŠ¡ä¸»çº¿</h3>
        <div class="todo-list" id="todoArea">
            </div>
        
        <div class="input-group">
            <input type="text" id="todoInput" placeholder="è¾“å…¥æ–°ä»»åŠ¡ (ä¾‹å¦‚: å½•åˆ¶å‰ªè¾‘è§†é¢‘)">
            <div style="display:flex; gap:10px; margin-top:5px; border-top:1px solid #333; padding-top:5px;">
                <input type="time" id="todoTime" style="width:120px; color:var(--blue)">
                <button onclick="addMission()" style="background:var(--p); border:none; color:white; border-radius:8px; padding:0 15px; cursor:pointer; font-weight:bold;">å‘å¸ƒä»»åŠ¡</button>
            </div>
        </div>

        <h3 style="margin-top:20px;">BRAIN DUMP / æ„è¯†æµ (ç¢ç¢å¿µ/æ™šé¤)</h3>
        <div class="input-group">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æ­¤åˆ»å¿ƒæƒ…ã€æ™šé¤ã€æˆ–æ˜¯ä»»ä½•æƒ³å¯¹AIè¯´çš„è¯..." onkeypress="if(event.key==='Enter') sendChat()">
        </div>
    </div>

    <div class="panel">
        <h3>STRATEGIC HQ / AI æˆ˜ç•¥æŒ‡æŒ¥éƒ¨</h3>
        <div class="terminal" id="aiTerminal">
            > ç³»ç»Ÿå·²å°±ç»ª...<br>
            > æ­£åœ¨åˆ†ææ‚¨çš„è¿‘æœŸçŠ¶æ€...<br>
            <span id="aiTyping"></span>
        </div>
        <button onclick="askAIForPlan()" style="margin-top:15px; background:transparent; border:1px solid var(--blue); color:var(--blue); padding:12px; border-radius:12px; font-weight:bold; cursor:pointer;">è¯·æ±‚ AI æ™ºèƒ½æ‹†è§£ä»Šæ—¥ä»»åŠ¡</button>
    </div>

<audio id="ding" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    const SUPABASE_URL = 'https://zcnmdyvaxrjjhvymjzsb.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_JVEN8RBiF0xuPKl2oVhpQA_rywUiJTY';
    const DEEPSEEK_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let missions = [];
    let coinCount = 1000;

    // 1. åˆå§‹åŒ–ä¸åŒæ­¥
    async function init() {
        // è¯·æ±‚é€šçŸ¥æƒé™
        if (Notification.permission !== 'granted') Notification.requestPermission();

        const { data } = await _supabase.from('life_logs').select('*').order('created_at', { ascending: false });
        if (data) {
            missions = data.filter(d => d.category === 'todo');
            coinCount = 1000 + data.reduce((acc, log) => acc + (log.coins || 0), 0);
            renderMissions();
            updateUI();
        }
    }

    // 2. æ¸²æŸ“ä»»åŠ¡å¹¶è®¾ç½®å®šæ—¶æé†’
    function renderMissions() {
        const area = document.getElementById('todoArea');
        area.innerHTML = '';
        missions.forEach((m, idx) => {
            const div = document.createElement('div');
            div.className = `todo-item ${m.is_done ? 'done' : ''}`;
            div.innerHTML = `
                <div class="check-btn ${m.is_done ? 'active' : ''}" onclick="completeMission('${m.id}', ${m.coins || 50})"></div>
                <div class="todo-info">
                    <div style="font-weight:bold;">${m.content}</div>
                    <div class="todo-time">ğŸ•’ ç›®æ ‡æ—¶é—´: ${m.target_time || 'æœªè®¾ç½®'}</div>
                </div>
            `;
            area.appendChild(div);

            // å®šæ—¶æ£€æµ‹æé†’
            if (m.target_time && !m.is_done) {
                checkAlarm(m);
            }
        });
    }

    // 3. é—¹é’Ÿé€»è¾‘
    function checkAlarm(mission) {
        const now = new Date();
        const [h, m] = mission.target_time.split(':');
        const target = new Date(); target.setHours(h, m, 0);

        if (now >= target && now < target.getTime() + 60000) {
            if (!mission.notified) {
                document.getElementById('ding').play();
                new Notification("ç‰¹å·¥ä»»åŠ¡æé†’", { body: `æ—¶é—´åˆ°ï¼è¯·æ±‡æŠ¥ä»»åŠ¡ï¼š${mission.content}` });
                mission.notified = true; 
            }
        }
    }

    // 4. é‡‘å¸ç‰¹æ•ˆä¸å®Œæˆ
    async function completeMission(id, reward) {
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#ffb800', '#ffffff'] });
        document.getElementById('ding').play();
        await _supabase.from('life_logs').update({ is_done: true, coins: reward }).eq('id', id);
        init();
    }

    // 5. AI æ™ºèƒ½ï¼šæ ¹æ®ç¢ç¢å¿µ/æ™šé¤æ™ºèƒ½è®¡åˆ’
    async function sendChat() {
        const input = document.getElementById('chatInput');
        const val = input.value;
        if (!val) return;
        
        addLog(val, 'chat');
        input.value = '';
        
        talkToAI(`è¿™æ˜¯æˆ‘åˆšæ‰çš„å¿ƒæƒ…/ç”Ÿæ´»è®°å½•: "${val}"ã€‚è¯·ä»¥æ­¤æ›´æ–°æˆ‘çš„ç‰¹å·¥çŠ¶æ€ã€‚å¦‚æœæ˜¯å…³äºæ™šé¤ï¼Œè¯„ä»·æˆ‘çš„è‡ªå¾‹ã€‚å¦‚æœæ˜¯ç¢ç¢å¿µï¼Œè¯·ä»¥å¯¼å¸ˆèº«ä»½å›åº”ã€‚`);
    }

    async function askAIForPlan() {
        const currentMissions = missions.map(m => m.content).join(',');
        talkToAI(`æˆ‘ç°åœ¨çš„ä»»åŠ¡æœ‰ï¼š${currentMissions}ã€‚è¯·å¸®æˆ‘æ™ºèƒ½æ‹†è§£è¿™äº›ä»»åŠ¡ï¼ŒæŒ‰ç…§æˆ‘çš„æ€§æ ¼ï¼ˆå¯èƒ½å­˜åœ¨çš„æ‹–å»¶ï¼‰ç»™å‡ºå†·é…·çš„æ‰§è¡Œæ­¥éª¤ã€‚å¹¶æ£€æŸ¥æˆ‘è¿™å‘¨æ˜¯å¦æ‡ˆæ€ ï¼Œå¦‚æœæˆ‘è¡¨ç°ä¸å¥½ï¼Œè¯·ç‹ ç‹ éª‚é†’æˆ‘ã€‚`);
    }

    async function talkToAI(prompt) {
        const term = document.getElementById('aiTerminal');
        term.innerHTML += `<br>> æ­£åœ¨æ¥å…¥ AI æ€»éƒ¨...`;
        
        try {
            const res = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${DEEPSEEK_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ—¢åƒä¸¥å‰å¯¼å¸ˆåˆåƒè´´å¿ƒç®¡å®¶çš„AIã€‚ä½ éœ€è¦æ ¹æ®ç”¨æˆ·çš„ç¢ç¢å¿µã€æ™šé¤æƒ…å†µå’Œä»»åŠ¡å®Œæˆç‡ï¼Œè¿›è¡Œæ™ºèƒ½åˆ†æã€‚ç”¨æˆ·æ‡ˆæ€ æ—¶è¦æ¯’èˆŒéª‚é†’ï¼Œç”¨æˆ·åŠªåŠ›æ—¶è¦ç»™äºˆé‡‘å¸å¥–åŠ±æ‰¿è¯ºã€‚ä»»åŠ¡æ‹†è§£è¦æå…¶ç»†è‡´ã€‚"},
                        {role: "user", content: prompt}
                    ]
                })
            });
            const json = await res.json();
            const reply = json.choices[0].message.content;
            term.innerHTML += `<br><span style="color:var(--p)">[AI æŠ¥å‘Š]</span><br>${reply.replace(/\n/g, '<br>')}<br>`;
            term.scrollTop = term.scrollHeight;
        } catch (e) { term.innerHTML += `<br>> é€šè®¯å¤±è´¥ã€‚`; }
    }

    // é€šç”¨å‡½æ•°
    async function addMission() {
        const content = document.getElementById('todoInput').value;
        const time = document.getElementById('todoTime').value;
        if (!content) return;
        await _supabase.from('life_logs').insert([{ content, category: 'todo', target_time: time, coins: 0, is_done: false }]);
        document.getElementById('todoInput').value = '';
        init();
    }

    async function addLog(content, cat) {
        await _supabase.from('life_logs').insert([{ content, category: cat, coins: 5 }]);
        init();
    }

    function buy(cost, item) {
        if (coinCount >= cost) {
            if (confirm(`ç¡®å®šèŠ±è´¹ ${cost} ğŸª™ å…‘æ¢ [${item}] å—ï¼Ÿ`)) {
                addLog(`å…‘æ¢å¥–åŠ±: ${item}`, 'shop');
                _supabase.from('life_logs').insert([{ content: `æ”¯å‡ºé‡‘å¸: ${item}`, coins: -cost, category: 'spend' }]).then(()=>init());
            }
        } else {
            alert("é‡‘å¸ä¸è¶³ï¼Œç‰¹å·¥ï¼Œå»æ‰§è¡Œä»»åŠ¡ï¼");
        }
    }

    function updateUI() {
        document.getElementById('coins').innerText = coinCount;
    }

    // é›·è¾¾å›¾åˆå§‹åŒ–
    const ctx = document.getElementById('radar').getContext('2d');
    new Chart(ctx, { type: 'radar', data: { labels: ['æ‰§è¡Œ', 'ç›®æ ‡', 'æ´å¯Ÿ', 'åˆ›æ–°', 'æ¢å¤', 'ä¸“æ³¨'], datasets: [{ data: [65, 80, 55, 45, 90, 60], backgroundColor: 'rgba(255, 77, 148, 0.2)', borderColor: '#ff4d94', borderWidth: 2 }] }, options: { scales: { r: { grid: { color: '#222' }, ticks: { display: false }, pointLabels: { color: '#555' } } }, plugins: { legend: { display: false } } } });

    init();
    setInterval(init, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡é—¹é’Ÿ
</script>
</body>
</html>
