<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - Evolution Station V3.3 (Ultimate Edition)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #131314; --card: #1E1E20; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #E3E3E3;
            --color-work: #FF4757; --color-life: #70A1FF; --color-fixed: #2ED573; --color-mood: #ECCC68;
        }
        
        body { 
            background: var(--bg); color: var(--text); font-family: 'PingFang SC', -apple-system, sans-serif; 
            margin: 0; padding: 15px; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 1px 1px, #2a2a2a 1px, transparent 0);
            background-size: 30px 30px;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ è£…é¥° */
        .system-top-bar { height: 2px; background: linear-gradient(90deg, transparent, var(--p), transparent); margin-bottom: 10px; }

        #workspace { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 20px; height: calc(100vh - 50px); align-content: flex-start;
        }

        /* æ¨¡å—åŸºç¡€æ ·å¼ï¼šæ”¯æŒæ‹–æ‹½å’Œç¼©æ”¾ */
        .panel { 
            background: var(--card); border-radius: 20px; padding: 0; 
            border: 1px solid #333; display: flex; flex-direction: column; 
            position: relative; resize: both; overflow: visible; 
            min-height: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .panel-header-drag { 
            padding: 15px 18px 8px; cursor: grab; user-select: none;
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-header-drag:active { cursor: grabbing; }

        .header-tag { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: #777; }
        .header-tag span { color: var(--p); font-weight: bold; text-shadow: 0 0 8px var(--p); }

        /* å†…å®¹åŒºå®¹å™¨ï¼šç¡®ä¿å†…å®¹æ»šåŠ¨ä½†ä¸å½±å“æ‚¬æµ®æ  */
        .module-body { 
            flex: 1; overflow: hidden; position: relative; 
            display: flex; flex-direction: column; padding: 0 18px;
        }

        /* ç‹¬ç«‹æ»šåŠ¨åŒºåŸŸ */
        .scroll-area { 
            flex: 1; overflow-y: auto; overflow-x: hidden; 
            padding-bottom: 100px; /* ç•™å‡ºåº•éƒ¨æ‚¬æµ®æ é«˜åº¦ */
            scrollbar-width: thin; scrollbar-color: #444 transparent;
        }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        /* --- æ ¸å¿ƒï¼šçœŸæ­£ç‹¬ç«‹äºæ»šåŠ¨å±‚çš„æ‚¬æµ®éƒ¨ç½²å° --- */
        .floating-input-bar {
            position: absolute; bottom: 15px; left: 12px; right: 12px;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(12px);
            border: 2px solid var(--p); border-radius: 12px;
            padding: 10px 14px; display: flex; gap: 10px; align-items: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.6), 0 0 15px rgba(255, 0, 127, 0.2);
            z-index: 1000;
        }
        /* æˆªå›¾åŒæ¬¾éœ“è™¹è§’ */
        .floating-input-bar::after {
            content: ''; position: absolute; right: -2px; bottom: -2px;
            width: 14px; height: 14px; background: var(--p);
            clip-path: polygon(100% 0, 100% 100%, 0 100%); border-radius: 0 0 12px 0;
        }

        /* åˆ—è¡¨é¡¹ç¾åŒ– */
        .card-item { 
            background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; 
            margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05);
            transition: 0.2s; position: relative;
        }
        .card-item:hover { background: rgba(255,255,255,0.06); transform: translateX(2px); }
        .type-indicator { width: 3px; height: 100%; position: absolute; left: 0; top: 0; border-radius: 15px 0 0 15px; }

        /* é‡‘å¸æ˜¾ç¤ºç›’ */
        .coin-box { 
            border: 2px solid var(--g); border-radius: 8px; padding: 10px 20px;
            display: inline-block; margin: 10px 0; background: rgba(255, 215, 0, 0.05);
        }

        /* åŸºç¡€ç»„ä»¶ */
        input { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        .p-btn { 
            background: var(--p); color: #000; border: none; border-radius: 8px; 
            font-weight: bold; cursor: pointer; padding: 7px 14px; font-size: 11px;
            transition: 0.2s; flex-shrink: 0;
        }
        .p-btn:hover { filter: brightness(1.2); transform: scale(1.05); }
        .p-btn:active { transform: scale(0.95); }

        .terminal-text { font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.6; color: var(--blue); }
        
        /* æ—¶é—´è½´æ­¥éª¤ */
        .step-row { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #999; margin-top: 8px; }
        .step-dot { width: 8px; height: 8px; border: 1.5px solid var(--p); border-radius: 50%; }

        /* åŠ¨ç”» */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .active-glow { animation: pulse 2s infinite; color: var(--blue) !important; }
    </style>
</head>
<body>

    <div class="system-top-bar"></div>

    <div id="workspace">
        <div class="panel" draggable="true" id="mod-assets">
            <div class="panel-header-drag">
                <div class="header-tag">STATUS // <span>CORE ASSETS</span></div>
            </div>
            <div class="module-body">
                <div class="scroll-area">
                    <div style="text-align: center;">
                        <div class="coin-box">
                            <span style="font-size:24px; vertical-align: middle;">ğŸª™</span>
                            <span id="coinsDisplay" style="font-size:32px; font-weight: bold; color:var(--g);">0</span>
                        </div>
                        <div style="font-size:11px; color:#666;">âŒ› è‡ªç”±å…‘æ¢é¢åº¦: <span id="timeDisplay">0</span> MIN</div>
                    </div>
                    <div class="header-tag" style="margin: 20px 0 10px;">SHOP // <span>REWARDS</span></div>
                    <div id="shopList"></div>
                </div>
                <div class="floating-input-bar">
                    <input type="text" id="shopName" placeholder="æ–°å¥–åŠ±åç§°...">
                    <input type="number" id="shopCost" placeholder="C" style="width:40px">
                    <button class="p-btn" onclick="addShopItem()">+</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-timeline" style="grid-column: span 1.5;">
            <div class="panel-header-drag">
                <div class="header-tag">TIMELINE // <span>MONITORING</span></div>
                <div style="display:flex; gap:5px;">
                    <button class="p-btn" style="background:#333; color:#fff; font-size:9px" onclick="generateReport('daily')">æ—¥æŠ¥</button>
                </div>
            </div>
            <div class="module-body">
                <div class="scroll-area" id="timelineList">
                    </div>
                <div class="floating-input-bar">
                    <input type="text" id="mTitle" placeholder="ç¢ç¢å¿µã€å¿ƒæƒ…æˆ–æ–°ä»»åŠ¡..." onkeypress="if(event.key==='Enter') deployMission()">
                    <button class="p-btn" onclick="deployMission()">DEPLOY</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-brain">
            <div class="panel-header-drag">
                <div class="header-tag">JARVIS // <span>BRAIN CORE</span></div>
            </div>
            <div class="module-body">
                <div class="scroll-area terminal-text" id="terminalBox">
                    <div>> ç³»ç»Ÿç‰ˆæœ¬ V3.3 åˆå§‹åŒ–å®Œæ¯•ã€‚</div>
                    <div>> ç‹¬ç«‹è§†å£æ‚¬æµ®é€»è¾‘å·²é”å®šã€‚</div>
                </div>
                <div class="floating-input-bar">
                    <input type="text" id="chatInput" placeholder="æ±‡æŠ¥è¿›åº¦æˆ–è°ƒæˆè´¾ç»´æ–¯..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="p-btn" onclick="sendChat()">SEND</button>
                </div>
                <button class="p-btn" style="position:absolute; bottom:75px; left:12px; right:12px; background:var(--g); color:#000" onclick="aiSuggestion()">è´¾ç»´æ–¯ï¼Œå»ºè®®æˆ‘ç°åœ¨åšä»€ä¹ˆï¼Ÿ</button>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-routine">
            <div class="panel-header-drag">
                <div class="header-tag">ROUTINES // <span>DAILY</span></div>
            </div>
            <div class="module-body">
                <div class="scroll-area" id="routineList"></div>
                <div class="floating-input-bar">
                    <input type="time" id="rTime" value="09:00">
                    <input type="text" id="rTitle" placeholder="å›ºå®šä»»åŠ¡...">
                    <button class="p-btn" onclick="addRoutine()">ADD</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        // æ ·å¼æ˜ å°„
        const typeStyles = {
            work: { color: "var(--color-work)", icon: "âš’ï¸" },
            life: { color: "var(--color-life)", icon: "â˜•" },
            mood: { color: "var(--color-mood)", icon: "ğŸ’­" },
            fixed: { color: "var(--color-fixed)", icon: "ğŸ“…" }
        };

        let state = {
            coins: parseInt(localStorage.getItem('j_v33_coins')) || 1000,
            shop: JSON.parse(localStorage.getItem('j_v33_shop')) || [{ name: "åˆ· 30 åˆ†é’Ÿå°çº¢ä¹¦", cost: 100 }],
            routines: JSON.parse(localStorage.getItem('j_v33_routines')) || [],
            missions: JSON.parse(localStorage.getItem('j_v33_missions')) || [],
            activeId: null
        };

        function init() {
            render();
            setupDraggables();
            setInterval(tick, 1000);
            printTerminal("æ¬¢è¿å›æ¥ï¼Œå…ˆç”Ÿã€‚æ‰€æœ‰åŠŸèƒ½æ¨¡å—å·²åŒæ­¥ï¼Œæ‚¬æµ®éƒ¨ç½²å°å·²é€šè¿‡åŒé‡è§†å£é”å®šã€‚");
        }

        // --- æ‹–æ‹½æ’åºé€»è¾‘ ---
        function setupDraggables() {
            const container = document.getElementById('workspace');
            document.querySelectorAll('.panel').forEach(panel => {
                panel.addEventListener('dragstart', (e) => {
                    if (e.target.closest('.module-body')) { e.preventDefault(); return; }
                    panel.classList.add('dragging');
                });
                panel.addEventListener('dragend', () => panel.classList.remove('dragging'));
            });
            container.addEventListener('dragover', e => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                if (!dragging) return;
                const afterElement = [...container.querySelectorAll('.panel:not(.dragging)')].reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = e.clientX - box.left - box.width / 2;
                    if (offset < 0 && offset > closest.offset) return { offset, element: child };
                    return closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
                if (afterElement) container.insertBefore(dragging, afterElement);
                else container.appendChild(dragging);
            });
        }

        // --- æ ¸å¿ƒæ¸²æŸ“ ---
        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            // æ¸²æŸ“æ—¶é—´è½´
            const tList = document.getElementById('timelineList');
            tList.innerHTML = state.missions.map(m => {
                const style = typeStyles[m.type || 'work'];
                return `
                    <div class="card-item" onclick="toggleMission(${m.id})">
                        <div class="type-indicator" style="background:${style.color}"></div>
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <div style="font-size:10px; color:#555; margin-bottom:4px;">${m.startTime} ${style.icon}</div>
                                <div style="font-weight:bold; ${m.active ? 'color:var(--blue)' : ''}" class="${m.active ? 'active-glow' : ''}">
                                    ${m.title}
                                </div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-size:12px; font-weight:bold; color:var(--p)">${formatTime(m.secondsLeft)}</div>
                                <div style="font-size:9px; color:#444">+${m.reward}C</div>
                            </div>
                        </div>
                        ${m.steps ? m.steps.map(s => `<div class="step-row"><span class="step-dot"></span>${s}</div>`).join('') : ''}
                    </div>
                `;
            }).join('');

            // æ¸²æŸ“èµ„äº§å•†åº—
            document.getElementById('shopList').innerHTML = state.shop.map((item, idx) => `
                <div class="card-item" style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:12px;">${item.name}</span>
                    <button class="p-btn" style="background:var(--g)" onclick="buyItem(${idx})">${item.cost}C</button>
                </div>
            `).join('');

            // æ¸²æŸ“å‘¨æœŸä»»åŠ¡
            document.getElementById('routineList').innerHTML = state.routines.map(r => `
                <div class="card-item" style="display:flex; justify-content:space-between;">
                    <span><b>[${r.time}]</b> ${r.title}</span>
                    <span style="color:#444; cursor:pointer;" onclick="removeRoutine(${r.id})">Ã—</span>
                </div>
            `).join('');
            save();
        }

        // --- ä¸šåŠ¡é€»è¾‘ ---
        async function deployMission() {
            const input = document.getElementById('mTitle'); if(!input.value) return;
            printTerminal("è´¾ç»´æ–¯æ­£åœ¨æ‰§è¡Œæ·±åº¦è¯­ä¹‰æ‰«æ...");
            const res = await callAI(`åˆ†æä»»åŠ¡: "${input.value}"ã€‚è¿”å›ä¸¥æ ¼JSON: {"mins":æ•°å­—, "type":"work/life/mood", "icon":"å›¾æ ‡", "steps":["æ­¥éª¤1","æ­¥éª¤2"]}`);
            try {
                const data = JSON.parse(res.match(/\{.*\}/s)[0]);
                state.missions.unshift({
                    id: Date.now(), title: input.value, startTime: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                    secondsLeft: data.mins * 60, type: data.type, icon: data.icon, steps: data.steps, active: false, reward: Math.ceil(data.mins/5)
                });
                input.value = ''; render();
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
            } catch(e) { printTerminal("è§£æå¤±è´¥ï¼Œå·²æŒ‰é»˜è®¤ä»»åŠ¡éƒ¨ç½²ã€‚"); }
        }

        function toggleMission(id) {
            state.missions.forEach(m => m.active = (m.id === id ? !m.active : false));
            render();
        }

        function tick() {
            const active = state.missions.find(m => m.active);
            if(active && active.secondsLeft > 0) {
                active.secondsLeft--;
                if(active.secondsLeft % 5 === 0) render();
            } else if(active && active.secondsLeft <= 0) {
                active.active = false; state.coins += active.reward;
                confetti({ particleCount: 150 });
                printTerminal(`ä»»åŠ¡å®Œæˆï¼æ­å–œè·å¾— ${active.reward} é‡‘å¸ã€‚`);
                render();
            }
        }

        function buyItem(idx) {
            const item = state.shop[idx];
            if(state.coins >= item.cost) {
                state.coins -= item.cost;
                printTerminal(`æˆåŠŸå…‘æ¢: ${item.name}`);
                confetti({ particleCount: 50 });
                render();
            }
        }

        function addShopItem() {
            const name = document.getElementById('shopName').value;
            const cost = parseInt(document.getElementById('shopCost').value);
            if(name && cost) { state.shop.push({name, cost}); render(); }
        }

        function addRoutine() {
            const time = document.getElementById('rTime').value;
            const title = document.getElementById('rTitle').value;
            if(title) { state.routines.push({id: Date.now(), time, title}); render(); }
        }

        function removeRoutine(id) { state.routines = state.routines.filter(r => r.id !== id); render(); }

        // --- ç³»ç»Ÿå·¥å…· ---
        async function callAI(p) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role:"system",content:"ä½ æ˜¯AIç®¡å®¶è´¾ç»´æ–¯"},{role:"user",content:p}] })
                });
                const d = await res.json(); return d.choices[0].message.content;
            } catch(e) { return '{"mins":25, "type":"work", "steps":["ä»»åŠ¡è‡ªåŠ¨æ‹†è§£ä¸­..."]}'; }
        }

        async function sendChat() {
            const i = document.getElementById('chatInput'); if(!i.value) return;
            printTerminal(`ä¸»äºº: ${i.value}`);
            const r = await callAI(`ä¸»äººè¯´: "${i.value}"ã€‚è¯·ä»¥è´¾ç»´æ–¯çš„è¯­æ°”ç®€çŸ­å›å¤ã€‚`);
            printTerminal(`JARVIS: ${r}`); i.value = '';
        }

        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function printTerminal(t) { const b = document.getElementById('terminalBox'); b.innerHTML += `<div>> ${t}</div>`; b.scrollTop = b.scrollHeight; }
        function save() { 
            const prefix = 'j_v33_';
            localStorage.setItem(prefix+'coins', state.coins); 
            localStorage.setItem(prefix+'shop', JSON.stringify(state.shop));
            localStorage.setItem(prefix+'missions', JSON.stringify(state.missions));
            localStorage.setItem(prefix+'routines', JSON.stringify(state.routines));
        }

        init();
    </script>
</body>
</html>
