<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - Omnipotence Station V3.0</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #131314; --card: #1E1E20; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #E3E3E3;
            --color-work: #FF4757; --color-life: #70A1FF; --color-fixed: #2ED573; --color-mood: #ECCC68;
        }
        
        body { 
            background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; 
            margin: 0; padding: 20px; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 2px 2px, #333 1px, transparent 0);
            background-size: 40px 40px;
        }

        /* è‡ªç”±æ¡Œé¢å®¹å™¨ */
        #workspace {
            display: flex; flex-wrap: wrap; gap: 20px; align-content: flex-start; height: 100%;
        }

        /* æ¨¡å—åŸºç¡€æ ·å¼ï¼šæ”¯æŒæ‹–æ‹½å’Œç¼©æ”¾ */
        .panel { 
            background: var(--card); border-radius: 20px; padding: 18px; 
            border: 1px solid #333; display: flex; flex-direction: column; 
            position: relative; resize: both; overflow: hidden;
            min-width: 300px; min-height: 250px;
            cursor: grab; transition: box-shadow 0.2s;
        }
        .panel:active { cursor: grabbing; box-shadow: 0 0 30px rgba(255, 0, 127, 0.2); }
        .panel.dragging { opacity: 0.4; border: 2px dashed var(--p); }

        /* å³ä¸‹è§’æ‹‰ä¼¸æ‰‹æŸ„ç¾åŒ– */
        .panel::-webkit-resizer {
            background-color: var(--p); border-radius: 10px 0 0 0;
        }

        .header { 
            font-size: 10px; text-transform: uppercase; letter-spacing: 2px; 
            color: #888; margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 8px;
            display: flex; justify-content: space-between; pointer-events: none;
        }
        .header span { color: var(--p); text-shadow: 0 0 10px var(--p); }

        /* å†…å®¹åŒºå®¹å™¨ */
        .content-inner { flex: 1; display: flex; flex-direction: column; overflow: hidden; cursor: default; }
        .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; scroll-behavior: smooth; }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        /* åˆ—è¡¨é¡¹æ ·å¼ */
        .item-row { 
            background: rgba(255,255,255,0.03); border-radius: 12px; padding: 12px; 
            margin-bottom: 10px; border-left: 3px solid var(--p);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* åº•éƒ¨å›ºå®šéƒ¨ç½²å°æ ·å¼ */
        .fixed-command-deck {
            background: #000; border: 2px solid var(--p); border-radius: 12px;
            padding: 8px 12px; display: flex; gap: 10px; margin-top: 10px;
            box-shadow: 0 -5px 15px rgba(255, 0, 127, 0.1); position: relative;
        }
        /* æˆªå›¾åŒæ¬¾ç²‰è‰²è§’è£…é¥° */
        .fixed-command-deck::after {
            content: ''; position: absolute; right: -2px; bottom: -2px;
            width: 12px; height: 12px; background: var(--p);
            clip-path: polygon(100% 0, 100% 100%, 0 100%); border-radius: 0 0 12px 0;
        }

        input, select { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 6px 12px; font-size: 11px; }
        .terminal { flex: 1; background: #0a0a0a; border-radius: 12px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--blue); overflow-y: auto; }
        
        /* æ—¶é—´è½´èŠ‚ç‚¹ */
        .timeline-node { position: relative; padding-left: 30px; border-left: 2px solid #333; margin-left: 10px; margin-bottom: 20px; }
        .timeline-node::before {
            content: attr(data-icon); position: absolute; left: -16px; top: 0;
            width: 30px; height: 30px; background: var(--bg); border: 1px solid var(--p);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="workspace">
        <div class="panel" draggable="true" id="mod-assets" style="width: 320px; height: 450px;">
            <div class="header">STATUS // <span>CORE ASSETS</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div style="text-align: center; margin: 15px 0;">
                    <div style="font-size:32px; color:var(--g); font-weight: bold;">ğŸª™ <span id="coinsDisplay">0</span></div>
                    <div style="font-size:11px; color:#666;">è‡ªç”±é¢åº¦: <span id="timeDisplay">0</span> MIN</div>
                </div>
                <div class="header">SHOP // <span>REWARDS</span></div>
                <div class="scroll-area" id="shopList"></div>
                <div class="fixed-command-deck">
                    <input type="text" id="shopName" placeholder="å¥–åŠ±...">
                    <input type="number" id="shopCost" placeholder="C" style="width:40px">
                    <button class="p-btn" onclick="addShopItem()">+</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-timeline" style="width: 450px; height: 500px;">
            <div class="header">TIMELINE // <span>MONITORING</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div class="scroll-area" id="timelineList"></div>
                <div class="fixed-command-deck">
                    <input type="text" id="mTitle" placeholder="ç¢ç¢å¿µã€å¿ƒæƒ…æˆ–æ–°ä»»åŠ¡..." onkeypress="if(event.key==='Enter') deployMission()">
                    <button class="p-btn" onclick="deployMission()">DEPLOY</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-routine" style="width: 320px; height: 400px;">
            <div class="header">ROUTINES // <span>DAILY</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div class="scroll-area" id="routineList"></div>
                <div class="fixed-command-deck">
                    <input type="time" id="rTime" value="20:00">
                    <input type="text" id="rTitle" placeholder="å›ºå®šå‘¨æœŸä»»åŠ¡...">
                    <button class="p-btn" onclick="addRoutine()">ADD</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-brain" style="width: 350px; height: 350px;">
            <div class="header">JARVIS // <span>CORE</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div class="terminal" id="terminalBox">> æ¨¡å—åŒ–ç³»ç»Ÿ V3.0 å°±ç»ªã€‚</div>
                <div class="fixed-command-deck">
                    <input type="text" id="chatInput" placeholder="åœ¨æ­¤æ±‡æŠ¥æˆ–åæ§½..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="p-btn" onclick="sendChat()">SEND</button>
                </div>
                <button class="p-btn" style="margin-top: 10px; background: var(--g); color: #000;" onclick="aiSuggestion()">è´¾ç»´æ–¯ï¼Œå»ºè®®æˆ‘ç°åœ¨åšä»€ä¹ˆï¼Ÿ</button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        let state = {
            coins: parseInt(localStorage.getItem('j_v3_coins')) || 1000,
            shop: JSON.parse(localStorage.getItem('j_v3_shop')) || [
                { name: "åˆ· 30 åˆ†é’Ÿè§†é¢‘", cost: 100 },
                { name: "åƒä¸ªé›¶é£Ÿ", cost: 50 }
            ],
            routines: JSON.parse(localStorage.getItem('j_v3_routines')) || [],
            missions: JSON.parse(localStorage.getItem('j_v3_missions')) || [],
            activeId: null
        };

        function init() {
            render();
            setupDragAndDrop();
            setInterval(tick, 1000);
            printTerminal("æ¬¢è¿å›æ¥ï¼ŒæŒ‡æŒ¥ä¸­å¿ƒå·²å®Œæˆ DIY æ¨¡å—åŒ–å‡çº§ã€‚");
        }

        // --- æ ¸å¿ƒæ‹–æ‹½é€»è¾‘ ---
        function setupDragAndDrop() {
            const workspace = document.getElementById('workspace');
            const panels = document.querySelectorAll('.panel');

            panels.forEach(panel => {
                panel.addEventListener('dragstart', (e) => {
                    const rect = panel.getBoundingClientRect();
                    if (e.clientX > rect.right - 20 && e.clientY > rect.bottom - 20) {
                        e.preventDefault(); return; 
                    }
                    panel.classList.add('dragging');
                });
                panel.addEventListener('dragend', () => panel.classList.remove('dragging'));
            });

            workspace.addEventListener('dragover', e => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                const afterElement = getDragAfterElement(workspace, e.clientX);
                if (afterElement == null) workspace.appendChild(dragging);
                else workspace.insertBefore(dragging, afterElement);
            });
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.panel:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- ä¸šåŠ¡æ¸²æŸ“ ---
        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            // æ¸²æŸ“å•†åº— [æ¢å¤åŠŸèƒ½]
            document.getElementById('shopList').innerHTML = state.shop.map((item, idx) => `
                <div class="item-row">
                    <span style="font-size:12px;">${item.name}</span>
                    <button class="p-btn" style="background:var(--g)" onclick="buyItem(${idx})">${item.cost}C</button>
                </div>
            `).join('');

            // æ¸²æŸ“æ—¶é—´è½´
            document.getElementById('timelineList').innerHTML = state.missions.map(m => `
                <div class="timeline-node" data-icon="${m.icon || 'ğŸ“'}">
                    <div style="font-size:10px; color:#666;">${m.startTime}</div>
                    <div style="font-weight:bold; color:${m.active ? 'var(--blue)' : 'inherit'}" onclick="toggleMission(${m.id})">
                        ${m.title} ${m.active ? `(${formatTime(m.secondsLeft)})` : ''}
                    </div>
                </div>
            `).join('');

            // æ¸²æŸ“å‘¨æœŸ
            document.getElementById('routineList').innerHTML = state.routines.map(r => `
                <div class="item-row" style="border-left-color:var(--color-fixed)">
                    <span><b>[${r.time}]</b> ${r.title}</span>
                    <span style="cursor:pointer" onclick="removeRoutine(${r.id})">Ã—</span>
                </div>
            `).join('');
            save();
        }

        // --- åŠŸèƒ½é€»è¾‘ ---
        async function deployMission() {
            const input = document.getElementById('mTitle'); if(!input.value) return;
            printTerminal("è´¾ç»´æ–¯æ­£åœ¨åˆ†æä»»åŠ¡...");
            const res = await callAI(`åˆ†æä»»åŠ¡: "${input.value}"ï¼Œè¿”å›ä¸¥æ ¼JSON: {"mins":æ•°å­—, "type":"work/life/mood", "icon":"å›¾æ ‡"}`);
            const data = JSON.parse(res.match(/\{.*\}/s)[0]);
            
            state.missions.unshift({
                id: Date.now(), title: input.value, startTime: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                secondsLeft: data.mins * 60, icon: data.icon, active: false, reward: Math.ceil(data.mins/5)
            });
            input.value = ''; render();
        }

        function addShopItem() {
            const name = document.getElementById('shopName').value;
            const cost = parseInt(document.getElementById('shopCost').value);
            if(name && cost) { state.shop.push({name, cost}); render(); }
        }

        function buyItem(idx) {
            const item = state.shop[idx];
            if(state.coins >= item.cost) {
                state.coins -= item.cost;
                confetti({ particleCount: 100 });
                printTerminal(`æˆåŠŸå…‘æ¢å¥–åŠ±: ${item.name}`);
                render();
            }
        }

        function toggleMission(id) {
            state.missions.forEach(m => m.active = (m.id === id ? !m.active : false));
            render();
        }

        function tick() {
            const active = state.missions.find(m => m.active);
            if(active && active.secondsLeft > 0) {
                active.secondsLeft--;
                if(active.secondsLeft % 5 === 0) render();
            } else if(active && active.secondsLeft <= 0) {
                active.active = false; state.coins += active.reward;
                confetti({ particleCount: 150 });
                printTerminal(`ä»»åŠ¡å®Œæˆï¼è·å¾—é‡‘å¸: ${active.reward}`);
                render();
            }
        }

        // --- å‘¨æœŸä»»åŠ¡ ---
        function addRoutine() {
            const time = document.getElementById('rTime').value;
            const title = document.getElementById('rTitle').value;
            if(title) { state.routines.push({id: Date.now(), time, title}); render(); }
        }
        function removeRoutine(id) { state.routines = state.routines.filter(r => r.id !== id); render(); }

        // --- å·¥å…· ---
        async function callAI(p) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: [{role:"system",content:"ä½ æ˜¯è´¾ç»´æ–¯"},{role:"user",content:p}] })
                });
                const d = await res.json(); return d.choices[0].message.content;
            } catch(e) { return '{"mins":25, "type":"work", "icon":"âš¡"}'; }
        }
        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function printTerminal(t) { const b = document.getElementById('terminalBox'); b.innerHTML += `<div>> ${t}</div>`; b.scrollTop = b.scrollHeight; }
        function save() { 
            localStorage.setItem('j_v3_coins', state.coins); 
            localStorage.setItem('j_v3_shop', JSON.stringify(state.shop));
            localStorage.setItem('j_v3_missions', JSON.stringify(state.missions));
            localStorage.setItem('j_v3_routines', JSON.stringify(state.routines));
        }

        init();
    </script>
</body>
</html>
