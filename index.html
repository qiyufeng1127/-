<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Jarvis Station - Drag & DIY</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #1A1A1C; --card: #2C2C2E; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #ffffff;
            --color-work: #FF4757; --color-life: #70A1FF; --color-fixed: #2ED573; --color-mood: #ECCC68;
        }
        body { 
            background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; 
            margin: 0; padding: 20px; height: 100vh; overflow: hidden;
        }

        /* æ‹–æ‹½å®¹å™¨ç½‘æ ¼ */
        #dropzone {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            height: 90vh;
        }

        /* å¯æ‹–æ‹½é¢æ¿åŸºç¡€æ ·å¼ */
        .panel { 
            background: var(--card); border-radius: 24px; padding: 20px; 
            border: 1px solid #333; display: flex; flex-direction: column; 
            height: 100%; position: relative;
            cursor: grab; transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            user-select: none;
        }
        .panel:active { cursor: grabbing; transform: scale(1.02); z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .panel.dragging { opacity: 0.5; background: #3a3a3c; border: 2px dashed var(--p); }

        .header { 
            font-size: 11px; text-transform: uppercase; letter-spacing: 2px; 
            color: #777; margin-bottom: 15px; border-bottom: 1px solid #444; 
            padding-bottom: 5px; pointer-events: none;
        }
        .header span { color: var(--p); text-shadow: 0 0 10px var(--p); }

        /* å†…å®¹åŒºå–æ¶ˆæ‹–æ‹½æ„Ÿï¼Œé˜²æ­¢æ— æ³•è¾“å…¥ */
        .content-inner { flex: 1; display: flex; flex-direction: column; overflow: hidden; cursor: default; }

        /* é‡‘å¸å•†åº— */
        .shop-item { 
            background: rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; 
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid var(--g);
        }

        /* æ—¶é—´è½´ */
        .timeline-container { position: relative; padding-left: 30px; border-left: 2px solid #444; margin-left: 10px; }
        .timeline-node { position: relative; margin-bottom: 20px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .timeline-node::before {
            content: "ğŸ“"; position: absolute; left: -42px; top: 10px;
            width: 22px; height: 22px; background: var(--bg); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 12px;
        }

        .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; }
        .scroll-area::-webkit-scrollbar { width: 0; }

        .input-bar { background: #000; border: 1px solid #444; border-radius: 12px; padding: 8px 12px; display: flex; gap: 8px; margin-top: 10px; }
        input { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 8px 12px; font-size: 11px; }
        .terminal { flex: 1; background: #111; border-radius: 15px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--blue); overflow-y: auto; }
    </style>
</head>
<body>

    <div id="dropzone">
        <div class="panel" draggable="true" id="mod-shop">
            <div class="header">ASSETS & SHOP // <span>MARKET</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size:32px; color:var(--g); font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <div style="width:24px;height:24px;background:var(--g);border-radius:50%;color:#000;font-size:14px;display:flex;align-items:center;justify-content:center;font-weight:900">C</div>
                        <span id="coinsDisplay">0</span>
                    </div>
                    <div style="font-size:11px; color:#777; margin-top:5px;">å¯å…‘æ¢é¢åº¦: <span id="timeDisplay">0</span> MIN</div>
                </div>
                <div class="scroll-area" id="shopList"></div>
                <div class="input-bar">
                    <input type="text" id="shopName" placeholder="æ–°å¥–åŠ±...">
                    <input type="number" id="shopCost" placeholder="C" style="width:40px">
                    <button class="p-btn" onclick="addShopItem()">+</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-routine">
            <div class="header">DAILY ROUTINES // <span>FIXED</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div class="scroll-area" id="routineList"></div>
                <div class="input-bar">
                    <input type="time" id="rTime" value="20:00">
                    <input type="text" id="rTitle" placeholder="å›ºå®šä»»åŠ¡...">
                    <button class="p-btn" onclick="addRoutine()">ADD</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-timeline">
            <div class="header">TIMELINE // <span>LIVE TRACK</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div class="scroll-area">
                    <div class="timeline-container" id="timelineList"></div>
                </div>
                <div class="input-bar">
                    <input type="text" id="mTitle" placeholder="è¾“å…¥å½“å‰æƒ³æ³•æˆ–ä»»åŠ¡...">
                    <button class="p-btn" onclick="deployMission()">DEPLOY</button>
                </div>
            </div>
        </div>

        <div class="panel" draggable="true" id="mod-brain">
            <div class="header">JARVIS BRAIN // <span>CORE</span></div>
            <div class="content-inner" onmousedown="event.stopPropagation()">
                <div class="terminal" id="terminalBox">> æ‹–æ‹½åŠŸèƒ½å·²æ¿€æ´»ã€‚æŒ‰ä½é¢æ¿ç©ºç™½å¤„å³å¯ç§»åŠ¨ã€‚</div>
                <div class="input-bar">
                    <input type="text" id="chatInput" placeholder="è¾“å…¥æŒ‡ä»¤..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button class="p-btn" onclick="sendChat()">SEND</button>
                </div>
                <button class="p-btn" style="margin-top: 10px; background: var(--g); color: #000; width: 100%;" onclick="printTerminal('æ­£åœ¨æ·±åº¦åˆ†æå¸ƒå±€æœ‰æ•ˆæ€§...')">è´¾ç»´æ–¯ï¼Œå»ºè®®å½“å‰åšä»€ä¹ˆï¼Ÿ</button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        let state = {
            coins: parseInt(localStorage.getItem('j_drag_coins')) || 800,
            shop: JSON.parse(localStorage.getItem('j_drag_shop')) || [{name: "åˆ·è§†é¢‘ 30min", cost: 100}],
            routines: JSON.parse(localStorage.getItem('j_drag_routines')) || [],
            missions: JSON.parse(localStorage.getItem('j_drag_missions')) || []
        };

        function init() {
            render();
            setupDraggable();
            printTerminal("ç³»ç»Ÿå°±ç»ªã€‚æ‚¨å¯ä»¥ç›´æ¥æ‹–åŠ¨å››ä¸ªé¢æ¿è¿›è¡Œå¸ƒå±€ DIYã€‚");
        }

        // --- æ ¸å¿ƒæ‹–æ‹½é€»è¾‘ ---
        function setupDraggable() {
            const dropzone = document.getElementById('dropzone');
            const panels = document.querySelectorAll('.panel');

            panels.forEach(panel => {
                panel.addEventListener('dragstart', () => {
                    panel.classList.add('dragging');
                });

                panel.addEventListener('dragend', () => {
                    panel.classList.remove('dragging');
                    // ä¿å­˜æ–°é¡ºåºåˆ°æœ¬åœ°ï¼ˆå¯é€‰ï¼‰
                    saveOrder();
                });
            });

            dropzone.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(dropzone, e.clientX);
                const dragging = document.querySelector('.dragging');
                if (afterElement == null) {
                    dropzone.appendChild(dragging);
                } else {
                    dropzone.insertBefore(dragging, afterElement);
                }
            });
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.panel:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function saveOrder() {
            const order = [...document.querySelectorAll('.panel')].map(p => p.id);
            localStorage.setItem('j_drag_order', JSON.stringify(order));
        }

        // --- ä¸šåŠ¡é€»è¾‘ ---
        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            document.getElementById('shopList').innerHTML = state.shop.map(item => `
                <div class="shop-item">
                    <span style="font-weight:bold;">${item.name}</span>
                    <button class="p-btn" style="background:var(--g)" onclick="buyItem(${item.cost}, '${item.name}')">${item.cost}C</button>
                </div>
            `).join('');

            document.getElementById('routineList').innerHTML = state.routines.map(r => `
                <div class="shop-item" style="border-left-color:var(--color-fixed)">
                    <span style="color:var(--g); font-family:monospace; margin-right:10px;">[${r.time}]</span>
                    <span style="flex:1;">${r.title}</span>
                </div>
            `).join('');

            document.getElementById('timelineList').innerHTML = state.missions.map(m => `
                <div class="timeline-node">
                    <div style="font-size:10px; color:#777;">${m.time}</div>
                    <div style="font-size:13px; margin-top:4px;">${m.title}</div>
                </div>
            `).join('');
            save();
        }

        function addShopItem() {
            const name = document.getElementById('shopName').value;
            const cost = parseInt(document.getElementById('shopCost').value);
            if(name && cost) {
                state.shop.push({name, cost});
                render();
            }
        }

        function buyItem(cost, name) {
            if(state.coins >= cost) {
                state.coins -= cost;
                confetti({ particleCount: 150, origin: { y: 0.7 } });
                printTerminal(`å…‘æ¢æˆåŠŸ: ${name}`);
                render();
            } else {
                printTerminal("è­¦å‘Š: é‡‘å¸ä¸è¶³ï¼Œè¯·ç»§ç»­æ‰§è¡Œä»»åŠ¡è·å–é…¬åŠ³ã€‚");
            }
        }

        function addRoutine() {
            const time = document.getElementById('rTime').value;
            const title = document.getElementById('rTitle').value;
            if(title) {
                state.routines.push({time, title});
                render();
            }
        }

        function deployMission() {
            const title = document.getElementById('mTitle').value;
            if(!title) return;
            const now = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            state.missions.unshift({title, time: now});
            document.getElementById('mTitle').value = '';
            render();
        }

        function save() {
            localStorage.setItem('j_drag_coins', state.coins);
            localStorage.setItem('j_drag_shop', JSON.stringify(state.shop));
            localStorage.setItem('j_drag_routines', JSON.stringify(state.routines));
            localStorage.setItem('j_drag_missions', JSON.stringify(state.missions));
        }

        function printTerminal(t) {
            const b = document.getElementById('terminalBox');
            b.innerHTML += `<div>> ${t}</div>`;
            b.scrollTop = b.scrollHeight;
        }

        async function sendChat() {
            const i = document.getElementById('chatInput'); if(!i.value) return;
            printTerminal(`ä¸»äºº: ${i.value}`);
            i.value = '';
        }

        init();
    </script>
</body>
</html>
