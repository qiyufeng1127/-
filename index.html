<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jarvis - Evolution System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #1A1A1C; --card: #2C2C2E; --p: #FF007F; --blue: #00D2FF; --g: #FFD700; --text: #ffffff; --highlight: #FF6347; }
        body { background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; margin: 0; display: grid; grid-template-columns: 320px 1fr 380px; height: 100vh; gap: 15px; padding: 15px; overflow: hidden; }
        
        @keyframes emergency-red { 0% { background: var(--bg); } 25% { background: #660000; } 50% { background: #000000; } 75% { background: #bb0000; } 100% { background: var(--bg); } }
        .emergency-active { animation: emergency-red 0.15s infinite !important; }
        .emergency-active .panel { opacity: 0.5; }

        .panel { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .header { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: #777; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .header span { color: var(--p); text-shadow: 0 0 10px var(--p); }
        
        .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; }
        .item-card { background: #333; border-radius: 12px; padding: 12px; margin-bottom: 10px; border-left: 4px solid var(--p); transition: 0.3s; position: relative; }
        .item-card.running { border-left-color: var(--blue); box-shadow: 0 0 15px rgba(0, 210, 255, 0.4); }
        .item-card.done { opacity: 0.4; border-left-color: #555; }

        .input-bar { background: #000; border: 1px solid #444; border-radius: 12px; padding: 8px 12px; display: flex; gap: 8px; margin-top: 10px; }
        input { background: transparent; border: none; color: white; outline: none; flex: 1; font-size: 13px; }
        
        .p-btn { background: var(--p); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 8px 12px; font-size: 11px; }
        .report-btn { background: #444; color: white; flex: 1; }

        .terminal { flex: 1; background: #111; border-radius: 15px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--blue); overflow-y: auto; }
        .timer-text { font-family: monospace; font-size: 18px; color: var(--blue); font-weight: bold; }
        
        /* ç¼–è¾‘æ­¥éª¤æ ·å¼ */
        .step-item { display: flex; align-items: center; gap: 8px; margin-top: 8px; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 4px; }
        .step-input { flex: 1; background: transparent; border: none; color: #aaa; font-size: 12px; outline: none; border-bottom: 1px solid transparent; }
        .step-input:focus { border-bottom: 1px solid var(--blue); color: #fff; }
        .step-check { cursor: pointer; font-size: 14px; }
    </style>
</head>
<body>

    <div class="panel">
        <div class="header">STATUS // <span>CORE ASSETS</span></div>
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size:32px; color:var(--g); font-weight: bold;">ğŸª™ <span id="coinsDisplay">0</span></div>
            <div style="font-size:10px; color:#666;">è‡ªç”±é¢åº¦: <span id="timeDisplay">0</span> åˆ†é’Ÿ</div>
        </div>
        <div class="header">SHOP // <span>REWARDS</span></div>
        <div id="shopList" class="scroll-area"></div>
        <div class="input-bar">
            <input type="text" id="shopName" placeholder="è‡ªç”±æ´»åŠ¨...">
            <input type="number" id="shopMins" placeholder="åˆ†é’Ÿ" style="width:40px">
            <button class="p-btn" onclick="addShopItem()">+</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">TIMELINE // <span>MONITORING</span></div>
        <div id="missionList" class="scroll-area"></div>
        <div class="input-bar">
            <input type="text" id="mTitle" placeholder="æ–°ä»»åŠ¡...">
            <button class="p-btn" onclick="deploySmartMission()">æ™ºèƒ½éƒ¨ç½²</button>
        </div>
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <button class="p-btn report-btn" onclick="generateReport('daily')">æ—¥æŠ¥</button>
            <button class="p-btn report-btn" onclick="generateReport('weekly')">å‘¨æŠ¥</button>
            <button class="p-btn report-btn" onclick="generateReport('monthly')">æœˆæŠ¥</button>
        </div>
    </div>

    <div class="panel">
        <div class="header">JARVIS CORE // <span>BRAIN</span></div>
        <div class="terminal" id="terminalBox">> ç›‘å¬ä¸­...</div>
        <div class="input-bar">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æ±‡æŠ¥..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="p-btn" onclick="sendChat()">SEND</button>
        </div>
        <button class="p-btn" style="margin-top: 10px; background: var(--g); color: #000;" onclick="autoAssignMission()">è´¾ç»´æ–¯ï¼Œæˆ‘ç°åœ¨è¯¥å¹²ä»€ä¹ˆï¼Ÿ</button>
    </div>

    <audio id="alarmSfx" loop src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3"></audio>

    <script>
        const API_KEY = 'sk-520f594ef712411d97f24cf387047c1c';
        const API_URL = 'https://api.deepseek.com/chat/completions';

        let state = {
            coins: parseInt(localStorage.getItem('j_v24_coins')) || 1000,
            missions: JSON.parse(localStorage.getItem('j_v24_missions')) || [],
            memories: JSON.parse(localStorage.getItem('j_v24_memories')) || [],
            learningMemories: JSON.parse(localStorage.getItem('j_v24_learning')) || [], // ä¸“é—¨å­˜å‚¨æ­¥éª¤ä¿®æ”¹ä¹ æƒ¯
            shop: JSON.parse(localStorage.getItem('j_v24_shop')) || [],
            activeId: null
        };

        let alarmTimer = null;
        let titleInterval = null;

        function init() {
            render();
            setInterval(tick, 1000);
            Notification.requestPermission();
            printTerminal("ç³»ç»Ÿè¿›åŒ–æ¨¡å—å·²å°±ç»ªã€‚æ ‡ç­¾æ ç›‘æ§å·²æ¿€æ´»ã€‚");
        }

        function render() {
            document.getElementById('coinsDisplay').innerText = state.coins;
            document.getElementById('timeDisplay').innerText = state.coins * 5;

            const mBox = document.getElementById('missionList');
            mBox.innerHTML = state.missions.map(m => `
                <div class="item-card ${m.id === state.activeId ? 'running' : ''} ${m.done ? 'done' : ''}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="flex:1; cursor:pointer;" onclick="toggleMission(${m.id})">
                            <b style="color:var(--g)">[${m.reward}ğŸª™]</b> ${m.title}
                        </span>
                        <div class="timer-text">${formatTime(m.secondsLeft)}</div>
                    </div>
                    ${m.steps ? m.steps.map((s, idx) => `
                        <div class="step-item">
                            <span class="step-check" onclick="completeStep(${m.id}, ${idx})">${s.completed ? 'âœ…' : 'â­•'}</span>
                            <input type="text" class="step-input" value="${s.desc}" 
                                onchange="editAndLearnStep(${m.id}, ${idx}, this.value)"
                                placeholder="æ­¥éª¤æè¿°...">
                            <span style="font-size:10px; color:#666;">${s.mins}m</span>
                        </div>
                    `).join('') : ''}
                    ${!m.steps && !m.done ? `<button class="p-btn" style="margin-top:10px; width:100%; background:var(--blue)" onclick="breakdownMission(${m.id})">è¿›åŒ–æ‹†è§£</button>` : ''}
                </div>
            `).join('');

            const sBox = document.getElementById('shopList');
            sBox.innerHTML = state.shop.map((s, idx) => `
                <div class="item-card" style="border-left-color: var(--blue)" onclick="buyItem(${idx})">
                    <b>${s.name}</b> (${s.mins}m) <span style="float:right; color:var(--highlight)">-${s.price}ğŸª™</span>
                </div>
            `).join('');
            save();
        }

        // --- æ ¸å¿ƒï¼šä¿®æ”¹æ­¥éª¤å¹¶å­¦ä¹  ---
        function editAndLearnStep(missionId, stepIdx, newValue) {
            const m = state.missions.find(x => x.id === missionId);
            if (m && m.steps[stepIdx]) {
                const oldValue = m.steps[stepIdx].desc;
                m.steps[stepIdx].desc = newValue;
                
                // å­˜å…¥è¿›åŒ–è®°å¿†
                const log = `ç”¨æˆ·å°†ä»»åŠ¡[${m.title}]çš„åŸå§‹æ­¥éª¤[${oldValue}]ä¿®æ”¹ä¸º[${newValue}]`;
                state.learningMemories.push({ log, timestamp: Date.now() });
                if(state.learningMemories.length > 20) state.learningMemories.shift(); // ä¿æŒæœ€è¿‘20æ¡
                
                printTerminal(`è´¾ç»´æ–¯å·²å­¦ä¹ æ‚¨çš„æ“ä½œåå¥½: ${newValue}`);
                save();
            }
        }

        async function breakdownMission(id) {
            const m = state.missions.find(x => x.id === id);
            printTerminal(`æ­£åœ¨å‚è€ƒ ${state.learningMemories.length} æ¡è¿›åŒ–ç»éªŒè¿›è¡Œæ‹†è§£...`);
            
            // å°†å­¦ä¹ åˆ°çš„ç»éªŒå–‚ç»™ AI
            const habits = state.learningMemories.map(l => l.log).join('\n');
            const res = await callAI(`å‚è€ƒä¸»äººçš„ä¿®æ”¹ä¹ æƒ¯:\n${habits}\n\nè¯·å°†ä»»åŠ¡ "${m.title}" æ‹†è§£ä¸º3ä¸ªç¬¦åˆä¸»äººåå¥½çš„æ­¥éª¤ã€‚JSONæ ¼å¼: [{"desc":"æ­¥éª¤å","mins":æ•°å­—}]`);
            
            try {
                m.steps = JSON.parse(res.match(/\[.*\]/s)[0]).map(s => ({...s, completed: false}));
                render();
            } catch(e) { printTerminal("æ‹†è§£å¤±è´¥ã€‚"); }
        }

        function tick() {
            if(state.activeId) {
                const m = state.missions.find(x => x.id === state.activeId);
                if(m && m.secondsLeft > 0) { 
                    m.secondsLeft--; 
                    // åŒæ­¥åˆ°æ ‡ç­¾æ æ ‡é¢˜
                    document.title = `[${formatTime(m.secondsLeft)}] ${m.title}`;
                    if(m.secondsLeft % 60 === 0) render(); 
                }
                else if(m && m.secondsLeft <= 0 && !m.done) {
                    m.done = true; state.coins += m.reward; state.activeId = null;
                    document.title = "âœ… ä»»åŠ¡å®Œæˆï¼";
                    confetti({particleCount: 150}); render();
                }
            } else if (!document.body.classList.contains('emergency-active')) {
                document.title = "Jarvis - Evolution";
            }
        }

        function completeStep(mId, sIdx) {
            const m = state.missions.find(x => x.id === mId);
            if(m && m.steps[sIdx]) {
                m.steps[sIdx].completed = true;
                printTerminal(`æ­¥éª¤å®Œæˆã€‚`);
                stopAlarm();
                render();
            }
        }

        function toggleMission(id) {
            const m = state.missions.find(x => x.id === id);
            if(m.done) return;
            state.activeId = (state.activeId === id) ? null : id;
            if(state.activeId) stopAlarm();
            else document.title = "Jarvis - System Ready";
            render();
        }

        function resetAlarmTimer(id) {
            clearTimeout(alarmTimer);
            alarmTimer = setTimeout(() => {
                if(state.activeId !== id) startAlarm();
            }, 60000);
        }

        function startAlarm() {
            document.body.classList.add('emergency-active');
            document.getElementById('alarmSfx').play();
            if(!titleInterval) {
                titleInterval = setInterval(() => {
                    document.title = document.title.includes("ğŸš¨") ? "ã€ï¼ï¼ä»»åŠ¡ï¼ï¼ã€‘" : "ã€ğŸš¨ è­¦å‘Š ğŸš¨ã€‘";
                }, 150);
            }
            if(Notification.permission === "granted") new Notification("ğŸš¨ ç«‹å³å¼€å§‹ä»»åŠ¡ï¼Œå¦åˆ™ç³»ç»ŸæŒç»­çˆ†é—ªï¼");
        }

        function stopAlarm() {
            document.body.classList.remove('emergency-active');
            document.getElementById('alarmSfx').pause();
            clearInterval(titleInterval);
            titleInterval = null;
            clearTimeout(alarmTimer);
        }

        // --- åŸºç¡€åŠŸèƒ½å‡½æ•° ---
        async function deploySmartMission() {
            const title = document.getElementById('mTitle').value;
            if(!title) return;
            printTerminal(`æ­£åœ¨è¯„ä¼°: ${title}...`);
            const res = await callAI(`é¢„ä¼°ä»»åŠ¡ "${title}" çš„åˆ†é’Ÿæ•°ã€‚è¿”å›JSON: {"mins":æ•°å­—}`);
            try {
                const data = JSON.parse(res.match(/\{.*\}/s)[0]);
                const newM = { id: Date.now(), title, reward: Math.ceil(data.mins / 5), secondsLeft: data.mins * 60, done: false };
                state.missions.unshift(newM);
                document.getElementById('mTitle').value = '';
                render();
                resetAlarmTimer(newM.id);
            } catch(e) { printTerminal("éƒ¨ç½²å¼‚å¸¸ã€‚"); }
        }

        async function autoAssignMission() {
            printTerminal("è°ƒå–æ·±åº¦è®°å¿†...");
            const context = { history: state.missions.slice(0,5).map(m=>m.title), memories: state.memories.slice(0,5).map(m=>m.text) };
            const res = await callAI(`å‚è€ƒå†å² ${JSON.stringify(context.history)} å’Œè®°å¿† ${JSON.stringify(context.memories)}ï¼Œå»ºè®®ä¸€ä¸ªä»»åŠ¡ã€‚è¿”å›JSON: {"title":"å","mins":åˆ†,"reason":"ç†"}`);
            try {
                const data = JSON.parse(res.match(/\{.*\}/s)[0]);
                const newM = { id: Date.now(), title: `[å»ºè®®] ${data.title}`, reward: Math.ceil(data.mins / 5), secondsLeft: data.mins * 60, done: false };
                state.missions.unshift(newM);
                render();
                printTerminal(`å»ºè®®: ${data.reason}`);
                resetAlarmTimer(newM.id);
            } catch(e) { printTerminal("å¤±è´¥ã€‚"); }
        }

        async function callAI(p) {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` },
                body: JSON.stringify({ model: "deepseek-chat", messages: [{role:"system",content:"ä½ æ˜¯è´¾ç»´æ–¯ï¼Œé«˜æ•ˆç£å¯¼ç®¡å®¶ã€‚"},{role:"user",content:p}] })
            });
            const d = await res.json(); return d.choices[0].message.content;
        }

        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`; }
        function printTerminal(t) { const b = document.getElementById('terminalBox'); b.innerHTML += `<div>> ${t}</div>`; b.scrollTop = b.scrollHeight; }
        function save() { 
            localStorage.setItem('j_v24_coins', state.coins); 
            localStorage.setItem('j_v24_missions', JSON.stringify(state.missions)); 
            localStorage.setItem('j_v24_memories', JSON.stringify(state.memories)); 
            localStorage.setItem('j_v24_learning', JSON.stringify(state.learningMemories)); 
            localStorage.setItem('j_v24_shop', JSON.stringify(state.shop)); 
        }
        async function sendChat() { 
            const i = document.getElementById('chatInput'); if(!i.value) return;
            state.memories.push({text: i.value, time: new Date().toISOString()});
            printTerminal(`ä¸»äºº: ${i.value}`); 
            const r = await callAI(i.value); printTerminal(`JARVIS: ${r}`); i.value = '';
        }

        init();
    </script>
</body>
</html>
